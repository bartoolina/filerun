var FR={initLayout:function(){var appsOpts=[];if(FR.apps&&FR.apps.length>0){var boxes=[];Ext.each(FR.apps,function(item){boxes.push({boxLabel:item.name+' <span style="color:var(--theme-textLighter)">'+item.date_created+"</span>",name:"revoke[]",inputValue:item.id,helpText:FR.T("Granted on %1 from %2").replace("%1","<strong>"+item.date_created+"</strong>").replace("%2","<strong>"+item.client_ip+"</strong>")+"<br><br>"+item.device_uuid})});appsOpts.push({xtype:"checkboxgroup",itemCls:"x-check-group-alt",columns:1,fieldLabel:"Revoke access",items:boxes})}var fieldsBasic=[{xtype:"hidden",name:"csrf",value:FR.system.csrf_token},{xtype:"textfield",fieldLabel:"E-mail address",name:"email",value:FR.userInfo.email},{xtype:"textfield",fieldLabel:"Phone",name:"phone",value:FR.userInfo.phone},{xtype:"checkbox",boxLabel:"E-mail notifications",inputValue:1,hidden:!FR.system.allowEmailNotifications,name:"receive_notifications",checked:FR.userInfo.receive_notifications,helpText:FR.T("If checked, this option gets the user notified when:")+'<div style="margin-top:5px;">&bull; '+FR.T("A file has been downloaded by another user.")+"</div>"+"<div>&bull; "+FR.T("Another user provided a file or a folder via copying, moving, uploading or sharing.")+"</div>"+"<div>&bull; "+FR.T("Another user added a comment or set a label on a file or a folder.")+"</div>"},{xtype:"checkbox",boxLabel:"Mute sound notifications",checked:window.parent.FR.localSettings.get("sound-notif",window.parent.Settings.sound_notification?"enabled":"disabled")=="disabled",listeners:{check:function(el,checked){window.parent.FR.localSettings.set("sound-notif",checked?"disabled":"enabled")}},hidden:!window.parent.User.perms.file_history},{xtype:"displayfield",fieldLabel:"Profile image",html:'<a href="javascript:FR.uploadAvatar()" class="avatarSelector" style="width:60px;display: inline-block;"><div style="position:relative;width:60px;"><img src="a/?uid='+FR.userInfo.id+"&noCache="+(new Date).getTime()+'" height="60" id="avatarImg"><div class="cameraIcon"></div></div></a><br>[<a href="javascript:FR.resetAvatar()">Reset</a>]'}];if(Ext.isMobile){fieldsBasic.unshift({fieldLabel:"Last name",xtype:"textfield",name:"name2",value:FR.userInfo.name2});fieldsBasic.unshift({fieldLabel:"First name",xtype:"textfield",name:"name",value:FR.userInfo.name})}else{fieldsBasic.unshift({xtype:"compositefield",fieldLabel:"Name",items:[{flex:1,xtype:"textfield",name:"name",value:FR.userInfo.name},{flex:1,xtype:"textfield",name:"name2",value:FR.userInfo.name2}]})}fieldsBasic.push();this.viewport=new Ext.Viewport({layout:"fit",items:{xtype:"form",id:"theForm",layout:"fit",bodyStyle:"padding-top:15px",items:[{xtype:"tabpanel",enableTabStripOverflow:!Ext.isMobile,activeTab:0,deferredRender:false,defaults:{autoScroll:true,bodyStyle:"padding:15px 5px",layout:"form",labelAlign:"right",labelWidth:160},items:[{title:"Basic details",hidden:!FR.system.allowUserToEdit,defaults:{width:"100%"},items:fieldsBasic},{title:"Change password",hidden:!FR.system.allowUserToChangePass,defaults:{xtype:"textfield",inputType:"password",width:"100%"},bodyStyle:"padding:15px 5px",labelWidth:190,items:[{xtype:"displayfield",submitValue:false,hideLabel:true,hidden:!FR.userInfo.last_pass_change,style:"color:var(--theme-textLighter)",value:FR.T("Your password has been last changed %1").replace("%1",FR.userInfo.last_pass_change)},{fieldLabel:"Current password",name:"current_password"},{fieldLabel:"New password",name:"new_password"},{fieldLabel:"Confirm new password",name:"confirm_new_password"}]},{title:"2-Step verification",hidden:!FR.system.enable2stepOption,items:[{xtype:"checkbox",boxLabel:"Enable 2-step verification",inputValue:1,hideLabel:true,name:"two_step_enabled",checked:FR.userInfo.two_step_enabled||FR.system.require_2fa,readOnly:FR.system.require_2fa},{xtype:"displayfield",hideLabel:true,style:"color:var(--theme-textLighter)",value:FR.T("Every time you login you will need to type in also a temporary code which can be generated on your mobile device with a dedicated app such as Google Authenticator.")}]},{title:"Connected apps",hidden:!FR.system.showApps,labelAlign:"top",items:appsOpts}]}],buttons:[{text:"Save changes",cls:"fr-btn-primary",handler:function(){FR.formPanel=Ext.getCmp("theForm");FR.formPanel.bwrap.mask(FR.T("Saving changes..."));Ext.Ajax.request({url:URLRoot+"/?module=fileman&section=profile&action=save",params:Ext.apply({receive_notifications:0,two_step_enabled:0},FR.formPanel.form.getValues()),callback:function(){FR.formPanel.bwrap.unmask()},success:function(req){try{var rs=Ext.util.JSON.decode(req.responseText)}catch(er){return false}if(rs){if(rs.msg){window.parent.FR.UI.feedback(rs.msg,rs.success?"success":"error")}if(rs.success){window.parent.FR.UI.popups.accountSettings.close()}}else{window.parent.FR.UI.feedback(req.responseText,"error")}},failure:function(f,a){FR.UI.feedback(f.responseText,"error")}})}}]}})},uploadAvatar:function(){var input=document.createElement("input");input.setAttribute("type","file");input.style.display="none";input.addEventListener("change",function(e){if(!e.target.files){new Ext.ux.prompt({text:"You need a modern browser in order to use this feature."});return}if(e.target.files[0].type!="image/png"&&e.target.files[0].type!="image/jpeg"){new Ext.ux.prompt({text:"Please select a PNG or JPG image file."});return}var reader=new FileReader;reader.onload=function(e){var el=document.createElement("div");FR.cropperWindow=new Ext.Window({width:300,contentEl:el,closable:false,buttonAlign:"center",maximized:true,buttons:[{text:"Save changes",cls:"fr-btn-primary",handler:function(){FR.cropper.croppie("result",{type:"canvas",size:"viewport"}).then(function(canvas){canvas.toBlob(function(blob){blob.fileName="avatar.png";var upload=new Flow({target:URLRoot+"/?module=fileman&section=profile&action=upload_avatar",validateChunkResponse:function(status,message){if(status!="200"){return"retry"}try{var rs=Ext.decode(message)}catch(er){return"retry"}if(rs){if(rs.success){return"success"}else{return"error"}}},validateChunkResponseScope:this,startOnSubmit:true});upload.on("fileSuccess",function(f,sr){FR.cropperWindow.el.unmask();FR.cropperWindow.close();$("#avatarImg").attr("src",canvas.toDataURL("image/png",1));FR.refreshAvatarDisplay()});upload.on("fileError",function(f,sr){FR.cropperWindow.el.unmask();try{var rs=Ext.decode(sr)}catch(er){}if(rs&&rs.msg){new Ext.ux.prompt({text:rs.msg})}});upload.on("progress",function(flow){var percent=Math.floor(flow.getProgress()*100);FR.cropperWindow.el.mask(FR.T("Saving image..")+" &nbsp; &nbsp;"+percent+"%")});upload.on("uploadStart",function(flow){FR.cropperWindow.el.mask("Saving image..")});upload.addFile(blob,false,{csrf:FR.system.csrf_token})},"image/png",1)})}},{text:"Cancel",cls:"fr-btn-default",style:"margin-left:5px",handler:function(){FR.cropperWindow.close()}}]});FR.cropperWindow.show();FR.cropper=$(el).croppie({enableExif:true,viewport:{width:116,height:116,type:"square"},boundary:{width:150,height:150}});FR.cropper.croppie("bind",{url:e.target.result})};reader.readAsDataURL(e.target.files[0])});document.body.appendChild(input);input.click()},resetAvatar:function(){FR.formPanel=Ext.getCmp("theForm");FR.formPanel.bwrap.mask(FR.T("Resetting profile picture..."));Ext.Ajax.request({url:URLRoot+"/?module=fileman&section=profile&action=reset_avatar",params:{csrf:FR.system.csrf_token},callback:function(){FR.formPanel.bwrap.unmask()},success:function(req){try{var rs=Ext.util.JSON.decode(req.responseText)}catch(er){return false}if(rs){if(rs.msg){window.parent.FR.UI.feedback(rs.msg,rs.success?"success":"error")}if(rs.success){FR.refreshAvatarDisplay()}}else{window.parent.FR.UI.feedback(req.responseText,"error")}},failure:function(f,a){FR.UI.feedback(f.responseText,"error")}})},refreshAvatarDisplay:function(){with(window.parent){var url=FR.baseURL+"/a/?uid="+User.id+"&noCache="+(new Date).getTime();Ext.getCmp("fr-btn-user").el.select("img").set({src:url});$("#avatarImg").attr("src",url)}}};Ext.onReady(function(){FR.initLayout()});