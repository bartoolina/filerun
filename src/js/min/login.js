var FR={windowHeight:0,formWidth:280,logoAreaWidth:260,showNorth:false,showSouth:false,showWest:false,textInPrompt:false,margin:24,windowMargin:24,shadowSize:30,northHeight:100,init:function(){this.hasLogo=Settings.ui_login_logo.length;this.hasText=Settings.ui_login_text.length;this.hasTitle=Settings.ui_login_title.length;this.canvasSize=Ext.getBody().getViewSize();this.isNarrow=this.canvasSize.width<560;this.isShort=this.canvasSize.height<360;this.showWest=(this.hasLogo||this.hasText)&&!this.isNarrow;var formHeight=(Ext.isPhone?134:108)+this.margin,bbar=38;if(Settings.passwordRecoveryEnabled){formHeight+=32}if(Settings.signUpEnabled&&!this.isShort){formHeight+=32}this.windowHeight=formHeight+bbar+this.margin*2+this.windowMargin*2;this.windowWidth=this.formWidth+this.margin*4;if(this.hasTitle){this.windowHeight+=this.margin}this.promptWidth=Ext.min([this.canvasSize.width-this.shadowSize,350]);if(this.showWest){this.windowWidth+=this.logoAreaWidth+(this.margin+this.windowMargin*2)}if(this.hasLogo){if(!this.showWest){var northExtraHeight=this.northHeight+this.margin*2;var hasSpaceForLogo=this.canvasSize.height>this.windowHeight+northExtraHeight;if(hasSpaceForLogo){this.showNorth=true;this.windowHeight+=northExtraHeight}else{FR.hasLogo=false}}}if(this.hasText){if(!this.showWest||this.showWest&&this.hasLogo){this.southTextEl=Ext.DomHelper.append(document.body,{cls:"footerText",html:Settings.ui_login_text},true);this.southTextEl.setWidth(this.windowWidth-(this.margin*2+this.windowMargin*2));this.southHeight=Math.min(this.southTextEl.getHeight(),100);var extra=this.southHeight+this.margin*2;this.southTextEl.setWidth("auto");var hasSpaceForSouth=this.canvasSize.height>this.windowHeight+extra;if(hasSpaceForSouth){this.showSouth=true;this.windowHeight+=extra}else{this.southTextEl.remove();this.textInPrompt=true}}}if(this.canvasSize.width<650||this.canvasSize.width>650&&this.showWest){this.maximized=this.windowWidth+this.shadowSize>=this.canvasSize.width||this.windowHeight+this.shadowSize>=this.canvasSize.height}},initForm:function(){if(Settings.ui_bg){Ext.getBody().addClass("fr-transparent-login")}if(Settings.ui_dark_mode){Ext.getBody().addClass("darkMode")}var lang=[];Ext.each(Settings.languages,function(l){if(Settings.selectedLang.name!=l.name){lang.push({text:l.displayName,value:l.name,handler:function(){FR.win.el.mask("Changing language...");document.location.href=URLRoot+"/?language="+encodeURIComponent(l.name)}})}});var langButton={tabIndex:5,text:Settings.selectedLang.displayName,cls:"lang-select",hidden:!Settings.ui_display_language_menu,menu:lang,menuIndicator:true,tooltip:"Language"};var signInButton={text:"Sign in",tabIndex:3,cls:"fr-btn-primary fr-btn-signin",handler:function(){FR.formPanel.getForm().submit()}};var ssoButton={text:"SSO",tabIndex:4,cls:"fr-btn-default fr-btn-signin",style:"margin-left:5px",handler:function(){document.location.href=URLRoot+"/sso"},hidden:!Settings.ssoEnabled,id:"ssoBtn"};var leftButtons=[langButton],rightButtons=["->",signInButton,ssoButton],formButtons=false;if(this.isNarrow||!this.showWest){rightButtons.unshift(langButton);leftButtons=false}if(this.maximized&&this.canvasSize.height>500){formButtons=rightButtons;rightButtons=false}var formFields=[{ref:"usrField",name:"username",value:Settings.prefilledUsername,width:"100%",tabIndex:1,cls:"loginFormField",emptyText:"Username",autocomplete:true,required:true},{xtype:"textfield",id:"pass",tabIndex:2,value:Settings.prefilledPassword,width:"100%",name:"password",inputType:"password",cls:"loginFormField",emptyText:"Password",autocomplete:true},{xtype:"component",html:'<input type="submit" hidefocus="true" tabindex="-1" style="position:absolute;z-index:-100;width:1px;height:1px;top:-100px;" />'},{xtype:"hidden",name:"otp",ref:"otp",id:"otp",value:""},{xtype:"hidden",name:"two_step_secret",ref:"two_step_secret",value:""},{xtype:"hidden",name:"language",ref:"language",value:Settings.selectedLang.name}];if(this.isShort){if(Settings.signUpEnabled||Settings.passwordRecoveryEnabled){formFields.push({xtype:"displayfield",cls:"forgotPass",value:(Settings.signUpEnabled?'<a href="'+Settings.signUpURL+'" style="float:left">'+FR.T("Create account")+"</a>":"")+(Settings.passwordRecoveryEnabled?'<a href="'+URLRoot+'/?module=fileman&page=password_recovery"  style="float:right">'+FR.T("Forgot password?")+"</a>":"")})}}else{if(Settings.passwordRecoveryEnabled){formFields.push({xtype:"displayfield",cls:"forgotPass",value:'<a href="'+URLRoot+'/?module=fileman&page=password_recovery" tabindex="0">'+FR.T("Forgot password?")+"</a>"})}if(Settings.signUpEnabled){formFields.push({xtype:"displayfield",cls:"forgotPass",value:'<a href="'+Settings.signUpURL+'" tabindex="0">'+FR.T("Create account")+"</a>"})}}this.formPanel=new Ext.form.FormPanel({defaultType:"textfield",hideLabels:true,cls:"loginForm",standardSubmit:true,targetFrame:"submitIframe",url:URLRoot+"/?module=fileman&page=login&action=login",action:{options:{waitMsg:"Signing in...",waitMsgTarget:"filerun-login-window"}},items:formFields,buttons:formButtons});this.iframe=Ext.DomHelper.append(document.body,{tag:"iframe",name:"submitIframe",id:"submitIframe",frameBorder:0,width:0,height:0,hidefocus:true,tabindex:"-1",css:"display:none;visibility:hidden;height:0px;",src:"about:blank"});Ext.get("submitIframe").on("load",function(){var networkError=false;FR.win.el.unmask();var frameDoc;try{if(this.iframe.contentDocument){if(this.iframe.contentDocument.document){frameDoc=this.iframe.contentDocument.document}else{frameDoc=this.iframe.contentDocument}}else{if(this.iframe.contentWindow.document){frameDoc=this.iframe.contentWindow.document}}var responseText=frameDoc.body.innerHTML;if(frameDoc.URL=="about:blank"){return false}}catch(er){networkError=true}if(networkError||responseText.length==0){new Ext.ux.prompt({text:"Communication with the server failed. Please try again later.",width:this.promptWidth});return false}try{var rs=Ext.util.JSON.decode(responseText)}catch(er){new Ext.ux.prompt({width:this.promptWidth,text:'Unexpected server reply. Press "OK" to display it.',callback:function(){document.write(responseText)}});return false}if(rs.success){FR.win.el.mask("Loading...");if(rs.redirect_url){document.location.href=decodeURIComponent(rs.redirect_url)}else{document.location.reload()}}else if(rs.success==false){FR.formPanel.otp.setValue("");if(rs.twoStepSecret){FR.formPanel.two_step_secret.setValue(rs.twoStepSecret);FR.showQR(rs.twoStepSecret,rs.keyURI,rs.keyURIPlain)}else{if(rs.ask_otp){FR.promptForOTP(rs.error)}else{new Ext.ux.prompt({width:this.promptWidth,text:rs.error,callback:function(){FR.formPanel.usrField.focus(true)}})}}}},this);var winConfig={id:"filerun-login-window",title:Settings.ui_login_title,cls:"login",layout:"border",height:this.windowHeight,width:this.windowWidth,closable:false,draggable:false,maximized:this.maximized,listeners:{show:function(){FR.formPanel.usrField.focus(false,20);if(FR.hasLogo){var logo=Ext.fly("loginLogoImage");if(!FR.isNarrow){logo.setHeight(FR.formPanel.getHeight())}Ext.get(document.createElement("img")).on("load",function(){if(this.dom){if(this.dom.width<logo.dom.offsetWidth&&this.dom.height<logo.dom.offsetHeight){logo.setStyle("background-size","auto")}}}).set({src:Settings.ui_login_logo})}else if(FR.hasText&&!FR.textInPrompt&&!FR.showSouth){Ext.get("loginText").show().setHeight(FR.formPanel.getHeight())}}},items:[{region:"center",margins:this.margin+"px",items:this.formPanel,buttons:rightButtons}]};if(this.showNorth){winConfig.items.push({region:"north",height:this.northHeight,margins:this.margin+"px",html:'<div id="loginLogoImage" style="background-image:url('+Settings.ui_login_logo+')"></div>'})}if(!this.isNarrow&&(this.hasLogo||this.hasText)){var html;if(this.hasLogo){html='<div id="loginLogoImage" style="background-image:url('+Settings.ui_login_logo+')"></div>'}else{html='<div id="loginText">'+Settings.ui_login_text+"</div>"}winConfig.items[0].region="east";winConfig.items[0].width=this.formWidth;winConfig.items.push({region:"center",margins:this.margin+"px",html:'<div class="logoArea">'+html+"</div>",buttons:leftButtons})}if(this.showSouth){winConfig.items.push({region:"south",height:this.southHeight,cls:"footerTextPanel",margins:this.margin+"px",contentEl:this.southTextEl})}this.win=new Ext.Window(winConfig);Ext.QuickTips.init();this.win.show();if(!this.maximized){this.win.anchorTo(Ext.get("theBODY"),"c-c")}if(this.textInPrompt){new Ext.ux.prompt({text:Settings.ui_login_text,width:this.promptWidth})}if(Settings.message){new Ext.ux.prompt({text:Settings.message,width:this.promptWidth,callback:function(){FR.formPanel.usrField.focus(true)}})}if(Settings.ssoEnabled){if(Settings.ssoOnly){FR.win.el.mask("Signing in...");document.location.href=URLRoot+"/sso"}else{new Ext.ToolTip({target:"ssoBtn",style:"padding:5px;white-space:nowrap",anchor:"top",showDelay:10,dismissDelay:0,html:FR.T("Single Sign On")})}}},promptForOTP:function(text){new Ext.ux.prompt({width:this.promptWidth,text:text,placeHolder:"6 digit verification code",numericInput:true,confirmHandler:function(code){FR.formPanel.otp.setValue(code);FR.formPanel.getForm().submit()},textFieldStyle:"text-align:center"})},showQR:function(secret,keyURI,keyURIPlain){if(Ext.isMobile){var appURL=Ext.isAndroid?"https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=en":"https://itunes.apple.com/us/app/google-authenticator/id388497605?mt=8";FR.add2stepWin=new Ext.Window({title:"2-step: Add account",closable:false,width:this.promptWidth,modal:true,items:{layout:"form",bodyStyle:"padding:20px 20px 40px 20px",defaults:{hideLabel:true},items:[{xtype:"displayfield",value:FR.T('Add a new <a href="%1" target="_blank">Google Authenticator</a> account with the following key:').replace("%1",appURL)},{xtype:"textfield",cls:"loginFormField",width:"100%",height:30,value:secret,style:"margin-top:10px;text-align:center"}]},buttonAlign:"center",buttons:[{cls:"fr-btn-primary",style:"margin-right:10px",text:"Done",handler:function(){FR.add2stepWin.close();FR.promptForOTP()}},{cls:"fr-btn-default",text:"Open Authenticator",handler:function(){document.location.href=keyURIPlain}}]});FR.add2stepWin.show();return false}FR.QRWindow=new Ext.Window({title:"2-step verification: add account",closable:false,draggable:false,modal:true,width:this.promptWidth,html:'<div style="text-align:center;">'+'<div style="padding:15px">'+FR.T('Scan this barcode with the <a href="%1" target="_blank">Google Authenticator</a> app on your mobile device to add your account.').replace("%1","https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=en")+"</div>"+'<div style="" class="loginQRCodeWrap">'+'<img title="'+secret+'" src="'+URLRoot+"/?module=fileman&section=utils&page=qrcode&encoded=1&size=6&data="+encodeURIComponent(keyURI)+'" width="222" height="222" />'+"</div>"+"</div>",buttonAlign:"center",buttons:[{cls:"fr-btn-primary",text:"Done",handler:function(){FR.QRWindow.close();FR.promptForOTP("")}}]});FR.QRWindow.show()}};Ext.onReady(function(){Ext.fly("loadMsg").hide();FR.init();if(Settings.androidAppURL&&Ext.isAndroid&&window.localStorage&&!window.localStorage.getItem("androidPrompt")){new Ext.ux.prompt({width:FR.promptWidth,text:"There is an Android app that you can use to access your files more comfortably. Would you like to try that instead?",confirmHandler:function(){document.location.href=Settings.androidAppURL;FR.initForm()},cancelHandler:function(){FR.initForm()}});window.localStorage.setItem("androidPrompt",true)}else{FR.initForm()}});