FR={step:0,adminPass:false,T:function(s){return s}};Ext.onReady(function(){FR.win=new Ext.Window({title:'<img src="?page=logo" style="height:24px;vertical-align: bottom;" title="FileRun" /><span style="color:var(--theme-textLighter)"> Installation</span>',width:440,buttonAlign:"right",height:310,closable:false,draggable:false,layout:"card",activeItem:0,items:[{bodyStyle:"padding:20px 0",html:'<span style="font-size:16px;font-weight:bold">Welcome to FileRun!</span>'+"<br><br>"+"This wizard will help you install the app with just a few clicks."+"<br><br>"+'For in-depth information, please check the <a href="https://docs.filerun.com/filerun_install_guide" target="_blank">installation guide</a>.'+"<br><br>"+'<i class="fa fa-check-square-o"></i> By using FileRun you are accepting the <a href="'+LicenseURL+'" target="_blank">license agreement</a>.'},{id:"reqPanel",bodyStyle:"padding: 15px 0",autoScroll:true,html:""},{xtype:"form",id:"mysqlFrm",bodyStyle:"padding: 10px",labelAlign:"right",autoScroll:true,labelWidth:120,items:[{xtype:"displayfield",hideLabel:true,value:'<span style="font-size:16px;font-weight:bold">Database setup</span><br><br>'},{xtype:"displayfield",hideLabel:true,value:"Please type in your MySQL server connection information:",hidden:DefaultDbVars.skipDetails},{xtype:"displayfield",value:"Ready to install FileRun.",hideLabel:true,hidden:!DefaultDbVars.skipDetails},{xtype:"compositefield",hidden:DefaultDbVars.skipDetails,items:[{xtype:"textfield",name:"host",width:145,value:DefaultDbVars.server,fieldLabel:"MySQL hostname"},{xtype:"textfield",name:"port",width:50,value:DefaultDbVars.serverPort}]},{xtype:"textfield",name:"dbname",width:200,value:DefaultDbVars.database,fieldLabel:"Database name",hidden:DefaultDbVars.skipDetails},{xtype:"textfield",name:"user",width:200,value:DefaultDbVars.username,fieldLabel:"MySQL user",hidden:DefaultDbVars.skipDetails},{xtype:"textfield",name:"pass",width:200,value:DefaultDbVars.password,fieldLabel:"Password",hidden:DefaultDbVars.skipDetails},{xtype:"displayfield",value:"If the database already exists:",hideLabel:true,hidden:DefaultDbVars.skipDetails},{xtype:"radiogroup",vertical:true,columns:1,hidden:DefaultDbVars.skipDetails,items:[{boxLabel:"Do nothing",name:"ifDbExist",inputValue:"alert",checked:DefaultDbVars.withExisting=="alert"},{boxLabel:"Use existing data",name:"ifDbExist",inputValue:"use",checked:DefaultDbVars.withExisting=="use"},{boxLabel:'<span style="color:var(--theme-textDanger)">Destroy existing data</span>',name:"ifDbExist",inputValue:"destroy",checked:DefaultDbVars.withExisting=="destroy"}]},{xtype:"displayfield",hideLabel:true,value:'The database will be automatically created if it doesn\'t exist.<br>The table names are prefixed with "df_".',hidden:DefaultDbVars.skipDetails}]},{id:"successPanel",bodyStyle:"padding: 10px",html:""}],buttons:[{id:"backBtn",text:"Back",style:"margin-right:10px",hidden:true,handler:function(){if(FR.step==1){FR.step=0;FR.win.setSize(440,310).anchorTo(Ext.get("theBODY"),"c-c")}else if(FR.step==2){FR.step=1;FR.win.setSize(600,440).anchorTo(Ext.get("theBODY"),"c-c")}else if(FR.step==3){FR.step=3}FR.win.getLayout().setActiveItem(FR.step);if(FR.step==0){this.hide()}}},{text:"Next",cls:"fr-btn-primary",handler:function(){if(FR.step==0){FR.checkRequirements()}else if(FR.step==1){FR.win.setSize(480,480).anchorTo(Ext.get("theBODY"),"c-c");FR.win.getLayout().setActiveItem(2);FR.step=2}else if(FR.step==2){FR.dbSetup()}else if(FR.step==3){document.location.href=URLRoot+"/?username=superuser"}}}]});FR.checkRequirements=function(){Ext.get(FR.win.body).mask("Checking server requirements...");Ext.Ajax.request({url:URLRoot+"/?module=install&page=requirements",callback:function(opt,success,resp){FR.step=1;Ext.getCmp("backBtn").show();Ext.get(FR.win.body).unmask();FR.win.setSize(600,440).anchorTo(Ext.get("theBODY"),"c-c");FR.win.getLayout().setActiveItem(1);Ext.getCmp("reqPanel").update(resp.responseText)},scope:this})};FR.dbSetup=function(){Ext.get(FR.win.body).mask("Setting up database...");Ext.Ajax.request({url:URLRoot+"/?module=install&page=mysql_setup",params:Ext.getCmp("mysqlFrm").getForm().getValues(),callback:function(){Ext.get(FR.win.body).unmask()},success:function(resp){try{var rs=Ext.util.JSON.decode(resp.responseText)}catch(er){if(confirm('Unexpected server reply. Press "OK" to display it.')){document.write(resp.responseText)}}if(rs.success){FR.step=3;FR.win.setSize(380,360).anchorTo(Ext.get("theBODY"),"c-c");FR.adminPass=rs.adminPass;Ext.getCmp("successPanel").update('<br><span style="font-size:20px;font-weight:bold">All right!</span>'+"<br><br>"+"FileRun installed successfully!"+"<br><br>"+"The default user account was created:"+"<br><br>"+'Your username is <div style="display:inline-block;border:1px solid whitesmoke;padding:3px;font-weight:bold">superuser</div>'+'<div style="height:1px"></div>'+'Your password is <div style="display:inline-block;border:1px solid whitesmoke;padding:3px;font-weight:bold">'+rs.adminPass+"</div>"+"<br><br>"+'<span style="color:red;font-weight:bold;">It is important that you make a note of the above password!</span>');FR.win.getLayout().setActiveItem(3);Ext.getCmp("backBtn").hide()}else if(rs.success==false){new Ext.ux.prompt({text:'<div style="max-height:200px;overflow:auto;">'+rs.msg+"</div>"})}},failure:function(frm,act){document.write(resp.responseText)},scope:this})};FR.win.show().anchorTo(Ext.getBody(),"c-c")});