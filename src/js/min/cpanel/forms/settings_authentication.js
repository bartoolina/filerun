FR.editSettings={confirmAuthPluginChange:false,saveChanges:function(){var editForm=this.formPanel;var params=editForm.form.getFieldValues();if(!FR.system.isFree){if(params["settings[auth_plugin]"]!="-"&&params["settings[auth_plugin]"]!=FR.settings.auth_plugin&&!FR.editSettings.confirmAuthPluginChange){new Ext.ux.prompt({text:FR.T('You are about to enable an authentication plugin. Did you use the "Test settings" button to make sure the plugin is properly configured?'),confirmHandler:function(){this.confirmAuthPluginChange=true;this.saveChanges()},scope:this});return false}this.confirmAuthPluginChange=false}var extra={};Ext.apply(params,extra);var opts={url:FR.URLRoot+"/?module=cpanel&section=settings&page=authentication&action=save",maskText:"Saving changes...",params:params};editForm.submitForm(opts)},changePlugin:function(pluginInfo){if(!pluginInfo){return false}var form=FR.editSettings.formPanel;var combo=form.plugin;var pluginOpts=form.pluginOpts;form.pluginDescr.update(pluginInfo.description);if(pluginInfo.id=="-"){pluginOpts.hide()}else{pluginOpts.setTitle(FR.T("%1 plugin options").replace("%1",pluginInfo.name));pluginOpts.removeAll();Ext.each(pluginInfo.fields,function(field){this.ownerCt.ownerCt.pluginOpts.add({xtype:field.name?"textfield":"displayfield",fieldLabel:field.label,name:"settings["+field.name+"]",helpText:FR.T(field.helpText)||false,value:field.value})},combo);pluginOpts.add(new Ext.form.DisplayField);pluginOpts.add(new Ext.form.CompositeField({fieldLabel:"",items:[{xtype:"button",text:FR.T("Test settings"),cls:"fr-btn-primary fr-btn-smaller fr-btn-nomargin",handler:function(){var params=FR.editSettings.formPanel.form.getValues();var output=this.ownerCt.ownerCt.ownerCt.serverReply;output.show();FR.utils.getAjaxOutput(FR.URLRoot+"/?module=cpanel&section=settings&page=authentication&action=test_auth_plugin",params,output)}},{xtype:"displayfield"}]}));pluginOpts.add(new Ext.form.DisplayField({ref:"serverReply",width:300,value:"test",style:"border:1px solid silver;padding:3px;",hidden:true}));pluginOpts.doLayout();pluginOpts.show()}}};FR.editSettings.comboStore=new Ext.data.ArrayStore({idIndex:0,fields:["id","name","description","fields"],data:FR.pluginsInfo});FR.editSettings.formPanel=new FR.components.editForm({title:"Authentication",autoScroll:true,layout:"form",defaults:{width:600},labelWidth:160,disabled:FR.system.isFree,disabledMaskText:FR.T("Available in the %1 version").replace("%1",'<a href="https://filerun.com/get-enterprise" target="_blank">Enterprise FileRun</a>'),items:[{xtype:"fieldset",title:"Third-party authentication",defaults:{width:400},items:[{xtype:"combo",fieldLabel:"Enabled plugin",width:200,name:"settings[auth_plugin]",hiddenName:"settings[auth_plugin]",ref:"../plugin",autoCreate:true,mode:"local",editable:false,displayField:"name",valueField:"id",triggerAction:"all",disableKeyFilter:true,store:FR.editSettings.comboStore,listeners:{beforeselect:function(combo,record){FR.editSettings.changePlugin(record.data)}}},{xtype:"displayfield",ref:"../pluginDescr",style:"color:var(--theme-textLighter)",value:"Use this application's own users database"},{xtype:"checkbox",boxLabel:"Sync passwords to the local database",value:1,name:"settings[auth_sync_passwords]",checked:parseInt(FR.settings.auth_sync_passwords),helpText:FR.T("Allows the users to login even after the third-party authentication system is not active or enabled. The passwords are stored encrypted.")},{xtype:"checkbox",boxLabel:"Allow local user accounts to login",value:1,name:"settings[auth_allow_local]",checked:parseInt(FR.settings.auth_allow_local),helpText:FR.T("Enabling this will allow access to the users that do not have an account with the third-party system.")+"<br>"+FR.T("Make sure you have a user account with the superuser's username in the third-party authentication database before disabling this option. If you lock the superuser out, you can disable the plugin by renaming its file.")},{xtype:"textfield",width:200,fieldLabel:"IP address limitation",emptyText:FR.T("Example:")+" 192.168.1.*",name:"settings[auth_plugin_ip_mask]",value:FR.settings.auth_plugin_ip_mask,helpText:FR.T("Enable the authentication plugin only for users using certain IP addresses.")+"<br><br>"+FR.T("There are three possible formats that can be used:")+"<br>"+FR.T("1. Wildcard format: 1.2.3.*")+"<br>"+FR.T("2. CIDR format: 1.2.3/24 OR 1.2.3.4/255.255.255.0")+"<br>"+FR.T("3. Start-End IP format: 1.2.3.0-1.2.3.255")+"<br><br>"+FR.T('It does not work with the "%1" option enabled.').replace("%1",FR.T("Sync passwords to the local database"))}]},{xtype:"fieldset",title:"&nbsp;",hidden:true,defaults:{width:360},ref:"pluginOpts",items:[]},{xtype:"fieldset",title:"New users",defaults:{width:400},items:[{xtype:"combo",fieldLabel:"Role",width:200,name:"settings[auth_plugin_default_role]",hiddenName:"settings[auth_plugin_default_role]",autoCreate:true,mode:"local",editable:false,emptyText:"Select...",displayField:"name",valueField:"id",triggerAction:"all",disableKeyFilter:true,value:FR.settings.auth_plugin_default_role||"-",store:new Ext.data.SimpleStore({fields:["id","name"],data:FR.roles})}]},{xtype:"fieldset",title:"User Logout",defaults:{width:300},items:[{xtype:"textfield",fieldLabel:"Redirect URL after logout",name:"settings[logout_redirect]",value:FR.settings.logout_redirect},{xtype:"textfield",fieldLabel:"Logout URL",name:"settings[logout_url]",value:FR.settings.logout_url},{xtype:"checkbox",boxLabel:"Hide the logout option",value:1,name:"settings[logout_hide]",checked:parseInt(FR.settings.logout_hide)}]}],tbar:[{text:"Save changes",cls:"fr-btn-primary",ref:"saveBtn",handler:FR.editSettings.saveChanges,scope:FR.editSettings}]});Ext.getCmp("appTab").add(FR.editSettings.formPanel);Ext.getCmp("appTab").doLayout(false,true);if(!FR.system.isFree){if(!FR.settings.auth_plugin){FR.settings.auth_plugin="-"}var pluginInfoRecord=FR.editSettings.comboStore.getById(FR.settings.auth_plugin);if(pluginInfoRecord){FR.editSettings.formPanel.plugin.setValue(FR.settings.auth_plugin);FR.editSettings.changePlugin(pluginInfoRecord.data)}}else{FR.settings.auth_plugin="-"}