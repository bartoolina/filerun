Ext.getCmp("appTab").add(new FR.components.editForm({title:"Import Users",disabled:FR.system.isFree||FR.system.isFreelancer,disabledMaskText:FR.T("Available in the %1 version").replace("%1",'<a href="https://filerun.com/get-enterprise" target="_blank">Enterprise FileRun</a>'),items:{xtype:"tabpanel",ref:"tabPanel",activeTab:0,deferredRender:false,enableTabStripOverflow:true,defaults:{autoScroll:true,bodyStyle:"padding:10px",listeners:{render:function(){this.doLayout(false,true)}}},items:[{title:"Step 1: Upload CSV File",items:[{xtype:"displayfield",style:"color:var(--theme-textLighter);padding:var(--panelPad);",value:FR.T("The CSV file needs to contain at least two columns, for username and name.")+"<br><br>"+FR.T("You will be asked to map the fields, so the names and the order of the columns are not important.")},{xtype:"fieldset",labelWidth:150,width:500,defaults:{width:300},items:[{xtype:"radiogroup",fieldLabel:"Fields are separated by",columns:1,items:[{boxLabel:"Comma",name:"delimiter",inputValue:"comma",value:"comma",checked:true},{boxLabel:"Semicolon",name:"delimiter",inputValue:"semicolon",value:"semicolon",checked:false},{boxLabel:"Tab",name:"delimiter",inputValue:"tab",value:"tab",checked:false}]},{xtype:"panel",layout:"hbox",layoutConfig:{padding:5},bodyStyle:"padding-left:150px",defaults:{margins:"0 5 0 0"},items:[{xtype:"button",text:"Upload CSV file",cls:"fr-btn-primary",iconCls:"fa-upload",listeners:{afterrender:function(){var formPanel=this.ownerCt.ownerCt.ownerCt.ownerCt.ownerCt;var tabPanel=formPanel.tabPanel;var uploadTab=tabPanel.items.itemAt(0);this.flow=new Flow({target:FR.URLRoot+"/?module=users&section=import&page=upload",singleFile:true,startOnSubmit:true});this.flow.on("filesSubmitted",function(){uploadTab.bwrap.mask("Upload starting...")});this.flow.on("progress",function(flow){var percent=Math.floor(flow.getProgress()*100);uploadTab.bwrap.mask(FR.T("Uploading...%1%").replace("%1",percent))});this.flow.on("fileSuccess",function(file,message){uploadTab.bwrap.unmask();try{var rs=Ext.util.JSON.decode(message)}catch(er){FR.feedback("Unexpected server reply: "+message,"error")}if(rs){if(rs.msg){FR.feedback(rs.msg)}if(rs.success){var mapFieldsTab=tabPanel.items.itemAt(1);uploadTab.setDisabled(1);mapFieldsTab.setDisabled(0);tabPanel.setActiveTab(1);var comboStore=new Ext.data.SimpleStore({idIndex:0,fields:["key","display"],data:FR.importColumns});var fields=["record_number"];var columns=[{dataIndex:"record_number",width:100}];var comboMappings=[{xtype:"displayfield",width:100,value:FR.T("Record number")}];var gridWidth=100;for(var i=0;i<rs.preview[0].length-1;i++){gridWidth=gridWidth+130;fields.push("h"+i);columns.push({dataIndex:"h"+i,width:130});comboMappings.push({xtype:"combo",width:125,mode:"local",editable:false,triggerAction:"all",lazyRender:true,displayField:"display",valueField:"key",listClass:"x-combo-list-small",store:comboStore,name:"mappings",hiddenName:"mappings["+i+"]",value:rs.preset&&rs.preset[i]?rs.preset[i]:"-"})}var store=new Ext.data.ArrayStore({idIndex:0,fields:fields,data:rs.preview});var grid=new Ext.grid.GridPanel({columns:columns,store:store,border:false,hideHeaders:true,columnLines:true,width:gridWidth});var combos=new Ext.form.CompositeField({items:comboMappings,width:gridWidth});mapFieldsTab.add(combos);mapFieldsTab.add(new Ext.form.DisplayField);mapFieldsTab.add(grid);mapFieldsTab.add(new Ext.form.DisplayField({style:"font-size:10px;color:gray",value:FR.T("Only the first 10 records are being displayed here.")}));mapFieldsTab.doLayout()}}});this.flow.on("fileError",function(file,message){uploadTab.bwrap.unmask();try{var rs=Ext.util.JSON.decode(message)}catch(er){FR.feedback("Unexpected server reply: "+message,"error")}if(rs&&rs.msg){FR.feedback(rs.msg)}});this.flow.on("complete",function(){uploadTab.bwrap.unmask()})}},handler:function(){var formPanel=this.ownerCt.ownerCt.ownerCt.ownerCt.ownerCt;this.flow.removeAll();this.flow.browseFiles({query:{delimiter:formPanel.form.getValues().delimiter}})}}]}]}]},{title:"Step 2: Map Fields",disabled:true,tbar:{height:54,items:[{text:"Import Users",cls:"fr-btn-primary",ref:"saveBtn",handler:function(){var fp=this.ownerCt.ownerCt.ownerCt.ownerCt;fp.el.mask("Loading...");Ext.Ajax.request({url:FR.URLRoot+"/?module=users&section=import&page=import",params:fp.form.getValues(),success:function(req){this.el.unmask();try{var rs=Ext.util.JSON.decode(req.responseText)}catch(er){FR.feedback("Error: "+req.responseText,"error");return false}if(rs.success){fp.results.update(rs.msg);fp.tabPanel.items.itemAt(2).setDisabled(0);fp.tabPanel.setActiveTab(2)}else{FR.feedback(rs.msg,"error")}},failure:function(){FR.feedback("An error was encountered while trying to send the request to the server.","error")},scope:fp})}}]},items:[{xtype:"fieldset",labelWidth:200,width:500,items:[{xtype:"combo",fieldLabel:"Assign a role to the users",name:"role",hiddenName:"role",ref:"../role",autoCreate:true,mode:"local",editable:false,displayField:"name",valueField:"id",allowBlank:false,forceSelection:true,triggerAction:"all",disableKeyFilter:true,value:FR.roles[0]?FR.roles[0][0]:"-",store:new Ext.data.SimpleStore({fields:["id","name"],data:FR.roles})},{xtype:"userslistfield",name:"groups",only:"groups",value:"",fieldLabel:"Add the users to groups",tcfg:{height:70,width:230}},{xtype:"textfield",fieldLabel:"Start with record number",name:"offset",width:60,helpText:"Set this to 2, if your CSV file has a header line.",value:2},{xtype:"checkbox",fieldLabel:"Passwords are in clear text",name:"clear_text_pass",value:1,helpText:"Enable this option if the passwords stored in your CSV files are not encrypted."},{xtype:"checkbox",fieldLabel:"Automatically generate passwords for the accounts",name:"gen_pass",value:1},{xtype:"checkbox",fieldLabel:"Require user to change the password",name:"require_password_change",value:1},{xtype:"checkbox",boxLabel:"Send a notification now",helpText:"An e-mail message with the login information will be sent to the user's address.",inputValue:1,name:"notify",checked:false}]}]},{title:"Step 3: Import Users",disabled:true,items:[{ref:"../../results",bodyStyle:"padding:10px",html:""}]}]}}));Ext.getCmp("appTab").doLayout();