FR.components.gridView=Ext.extend(Ext.grid.GridView,{searchMode:false,filterMode:false,filters:[],init:function(grid){if(!this.defaultViewMode){this.defaultViewMode=Settings.ui_default_view}if(!this.viewMode){this.viewMode=this.defaultViewMode}grid.colModel.on("hiddenchange",function(cm,idx,hideCol){if(cm.getColumnAt(idx).custom){this.grid.setMetaCols();if(!hideCol){FR.utils.reloadGrid()}}},this);FR.components.gridView.superclass.init.call(this,grid)},changeFilter:function(filter,persist){if(filter==this.filterMode){return}this.filterMode=filter;var metaTypeColumn=this.grid.colModel.getMetaTypeCol();if(this.filterMode&&metaTypeColumn.column.hidden==true){this.grid.colModel.setHidden(metaTypeColumn.indx,false)}else{this.refresh(true)}if(persist){this.defaultFilterMode=filter}var s=this.grid.getStore();s.fireEvent("filterchanged",s,this.filterMode)},setViewMode:function(mode,persist){if(mode==this.viewMode){return}if(!mode){mode=this.defaultViewMode}this.viewMode=mode;if(persist){this.defaultViewMode=mode;this.grid.fireEvent("viewchange",this.grid,mode)}this.grid.updateUIAround();var loadPhotoSizes=mode=="photos"?1:0;var prevSetting=this.grid.store.baseParams.photoSizes;this.grid.store.setBaseParam("photoSizes",loadPhotoSizes);if(loadPhotoSizes&&prevSetting!=1){FR.utils.reloadGrid()}return this},loadThumbs:new Ext.util.DelayedTask(function(){if(this.isListViewStyle()&&!Settings.ui_thumbs_in_detailed){return false}var scroller=this.scroller.dom;var scrollerRect=scroller.getBoundingClientRect();this.grid.store.each(function(item){if(item.data.thumbLoading){return true}if(item.data.thumbLoadingError){return true}if(item.data.thumbLoaded){return true}var el=this.getRowElById(item.id);if(!el){return true}if(!FR.utils.elementInView(el.getBoundingClientRect(),scrollerRect,2)){return true}var thumbCt=this.viewMode=="list"?Ext.get(el).child(".x-grid3-td-icon"):Ext.get("itemIcon_"+item.data.uniqid+"_"+item.data.filesize);if(!thumbCt){return true}if(!item.data.thumbURL){if(!item.data.thumb){item.data.thumbLoaded=true;return true}else{item.data.thumbURL=FR.UI.getThumbURL(Ext.copyTo({},item.data,"path,filesize,modified"))}}item.data.thumbLoading=true;FR.UI.preloadImage(item.data.thumbURL,function(success,img){item.data.thumbLoading=false;if(success){item.data.thumbLoaded=true;if(!thumbCt.dom){return false}thumbCt.addClass("tmbLoaded");var isMedia=FR.UI.fileTypeIsMedia(item.data.filetype);thumbCt.addClass(isMedia?"isPicture":"isNotPicture");if(this.viewMode=="list"){FR.UI.insertImageToContainer({img:img,container:thumbCt,clearContainer:true,padding:10});if(item.data.label){img.style.outline=item.data.label.color+" solid 1px";img.style.outlineOffset="1px"}}else{var opts={img:img,container:thumbCt,destroyImg:true};if(this.viewMode=="photos"){opts.fixed=true;if(!item.data.imageWidth){opts.padding=15}else{opts.style="cover"}}else if(this.viewMode=="thumbnails"){opts.style="cover";opts.coverAlign=isMedia?"center":"top"}else{opts.style="contain"}FR.UI.setImageToContainer(opts)}}else{item.data.thumbLoadingError=true}},this)},this)}),prepareData:function(r){r.data.thumbLoaded=false;r.data.thumbLoading=false;var icons=[];var iconCls=r.data.icon;var iconExtra="";if(r.data.isFolder){if(!iconCls){iconCls=r.data.share?"fa-folder-user":"fa-folder"}}else{if(!iconCls){iconCls=r.data.share?"fa-file-user":"fa-file"}if(r.data.share){icons.push('<i class="fa fa-fw fa-user" ext:qtip="'+FR.T("This item is shared with other users")+'"></i>')}}if(r.data.label){iconCls+=" fas";iconExtra+=' style="color:'+r.data.label.color+'"'}if(r.data.star){icons.push('<i class="fa fa-fw fa-star-o" ext:qtip="'+FR.T("This item is starred")+'"></i>')}if(r.data.hasWebLink){icons.push('<i class="fa fa-fw fa-link" ext:qtip="'+FR.T("This item is shared with link")+'"></i>')}if(r.data.lockInfo){icons.push('<i class="fa fa-fw fa-lock" ext:qtip="'+FR.T("This file is locked by %1.").replace("%1",r.data.lockInfo)+'"></i>')}if(r.data.notInfo){icons.push('<i class="fa fa-fw fa-bell-o" ext:qtip="'+FR.T("This item has notifications enabled")+'"></i>')}if(r.data.comments>0){icons.push('<i class="fa fa-fw fa-comment'+(r.data.comments>1?"s":"")+'" ext:qtip="'+FR.T("This item has user comments")+'"></i>')}if(r.data.extra){icons.push('<span class="extra">'+r.data.extra+"</span>")}if(r.data.isNew){var icon='<i class="fa fa-fw fa-bolt" ext:qtip="'+FR.T("This item has recent changes")+'"></i>';if(this.isListViewStyle()){icons.unshift(icon)}else{icons.push(icon)}}r.data.icons=icons.join("");var iconsHolder=icons.length?'<div class="iconsHolder">'+r.data.icons+"</div>":"";var cls;var itemId="itemIcon_"+r.data.uniqid+"_"+r.data.filesize;var checkboxSelector='<div class="grid-row-checkbox chkbx"><i class="grid-row-checkbox fa fa-fw fa-check"></i></div>';r.data.iconHTML='<i class="icon fa '+iconCls+'"'+iconExtra+"></i>";if(this.isListViewStyle()){r.data.checkboxHTML=checkboxSelector;return true}if(r.data.label){iconExtra+=' ext:qtip="'+r.data.label.text+'"'}if(r.data.isFolder){return'<div class="gridItem typeFolder" data-rid="'+r.id+'">'+'<div class="icon fa '+iconCls+'"'+iconExtra+"></div>"+'<div class="name" ext:qtip="'+r.data.filename+'">'+r.data.filename+"</div>"+iconsHolder+checkboxSelector+"</div>"}var extensionLabel="";if(r.data.ext&&r.data.filenameWithoutExt!=r.data.filename){var extLabelExtra="";var extLabelClass="extLabel ext_"+r.data.ext;if(r.data.label){extLabelClass+=" withFileLabel";extLabelExtra+=' style="--labelColor:'+r.data.label.color+'" ext:qtip="'+r.data.label.text+'"'}extensionLabel='<div class="'+extLabelClass+'"'+extLabelExtra+">"+r.data.ext+"</div>"}if(this.viewMode=="thumbnails"||this.viewMode=="large_grid"){var displayedFilename;if(this.viewMode=="large_grid"){displayedFilename=r.data.filename}else{displayedFilename=r.data.filenameWithoutExt}cls=r.data.label?" labeled":"";return'<div class="gridItem" data-rid="'+r.id+'">'+'<div class="tmbInner'+cls+'" id="'+itemId+'">'+'<div class="selOverlay"></div>'+r.data.iconHTML+checkboxSelector+extensionLabel+iconsHolder+"</div>"+'<div class="name" ext:qtip="'+r.data.filename+"&lt;br&gt; "+r.data.nice_filesize+'">'+displayedFilename+"</div>"+"</div>"}var videoIcon="";if(r.data.filetype=="wvideo"){videoIcon='<i class="fa fa-play-circle videoIcon"></i>'}var pad="100%";var width=Settings.ui_photos_thumbnail_size;cls="gridItem";if(r.data.thumb){if(r.data.imageWidth){width=Math.round(r.data.imageWidth*Settings.ui_photos_thumbnail_size/r.data.imageHeight);pad=Math.floor(r.data.imageHeight/r.data.imageWidth*100)+"%"}else{cls+=" noImageSize"}}else{cls+=" noImageSize"}return'<div class="'+cls+'" data-rid="'+r.id+'" id="'+itemId+'" style="width:'+width+"px;flex-grow:"+width+'">'+'<div style="padding-bottom:'+pad+'"></div>'+checkboxSelector+extensionLabel+iconsHolder+videoIcon+"</div>"},doRender:function(cs,rs,ds,startRow,colCount,stripe){if(this.isListViewStyle()){Ext.each(rs,function(r){this.prepareData(r)},this);return FR.components.gridView.superclass.doRender.apply(this,arguments)}var bufFolders="",bufFiles="",html="",ret="";Ext.each(rs,function(r){html=this.prepareData(r);if(r.data.isFolder){bufFolders+=html}else{bufFiles+=html}},this);if(bufFolders.length>0){ret+='<div class="gridGroup viewMode-thumbnails">'+bufFolders+"</div>";if(bufFiles.length>0){ret+='<div class="gridSpacer"></div>'}}ret+='<div class="gridGroup viewMode-'+this.viewMode+' files">'+bufFiles+"</div>";ret+='<div class="gridSpacer gridBottom"></div>';return ret},refresh:function(headersToo){var ua=FR.UI.actions;var gridPanel=FR.UI.gridPanel;var isListViewStyle=this.isListViewStyle();ua.disableFolderGrouping.setVisible(isListViewStyle);Ext.menu.MenuMgr.setCheckedItem("filter_mode",this.filterMode);if(isListViewStyle){this.selectedRowClass="x-grid3-row-selected";this.rowSelector="div.x-grid3-row";this.mainHd.setStyle("display","block");ua.sortItems.hide()}else{if(gridPanel.store.remoteSort){ua.sortItems.setChecked(false).hide()}else{ua.sortItems.show()}if(!ua.sortItems.checked){this.mainHd.setStyle("display","none")}this.rowSelector="div.gridItem";this.selectedRowClass="tmbItemSel"}var bbar=gridPanel.bottomToolbar;bbar.setVisible(bbar.getPageData().pages>1);gridPanel.el.removeClass(["viewMode-thumbnails","viewMode-photos","viewMode-large_grid","viewMode-list"]);gridPanel.el.addClass("viewMode-"+this.viewMode);this.filters=[];if(this.filterMode){var colId=FR.UI.gridPanel.colModel.getMetaTypeCol().column.id;var metaFileTypeId=this.filterMode;this.filters.push(function(r){return r.data.isFolder||r.data[colId]==metaFileTypeId})}var s=this.grid.getStore();if(this.filters.length>0){s.suspendEvents();s.filterBy(function(r){var rs=false;Ext.each(this.filters,function(f){if(f(r)){rs=true;return false}});return rs},this);s.resumeEvents()}else{if(s.isFiltered()){s.clearFilter(true)}}FR.components.gridView.superclass.refresh.apply(this,arguments);this.loadThumbs.delay(0,false,this)},showAudioPanel:function(){if(!FR.customActions.audio_player){return false}FR.UI.AudioPlayer.expand()},closeAudioPanel:function(){if(!FR.customActions.audio_player){return false}var ap=FR.UI.AudioPlayer;if(ap.app){ap.app.pause()}ap.collapse()},showSearchPanel:function(){FR.UI.searchPanel.show().alignTo(Ext.getBody(),"t-t?");this.searchMode=true},closeSearchPanel:function(){FR.UI.searchPanel.hide();this.searchMode=false},updateAllColumnWidths:function(){if(this.isListViewStyle()){return FR.components.gridView.superclass.updateAllColumnWidths.apply(this)}var tw=this.getTotalWidth();var clen=this.cm.getColumnCount();var ws=[];for(var i=0;i<clen;i++){ws[i]=this.getColumnWidth(i)}this.innerHd.firstChild.firstChild.style.width=tw;for(i=0;i<clen;i++){var hd=this.getHeaderCell(i);hd.style.width=ws[i]}this.onAllColumnWidthsUpdated(ws,tw)},updateColumnWidth:function(col,width){if(this.isListViewStyle()){return FR.components.gridView.superclass.updateColumnWidth.apply(this,arguments)}var w=this.getColumnWidth(col);var tw=this.getTotalWidth();this.innerHd.firstChild.firstChild.style.width=tw;var hd=this.getHeaderCell(col);hd.style.width=w;this.onColumnWidthUpdated(col,w,tw)},updateColumnHidden:function(col,hidden){if(this.isListViewStyle()){return FR.components.gridView.superclass.updateColumnHidden.apply(this,arguments)}var tw=this.getTotalWidth();this.innerHd.firstChild.firstChild.style.width=tw;var display=hidden?"none":"";var hd=this.getHeaderCell(col);hd.style.display=display;this.onColumnHiddenUpdated(col,hidden,tw);delete this.lastViewWidth;this.layout()},applyEmptyText:function(){var imgSrc=FR.illustrationsURL+"/",text="";if(this.searchMode){imgSrc+="search.svg";if(FR.UI.searchPanel.hasParams()){text="No file was found matching your search criteria."}}else if(FR.currentSection=="starred"){imgSrc+="stared.svg";text="There are no starred files or folders"}else if(FR.currentSection=="recent"){imgSrc+="recent.svg";text="There are no recently accessed files"}else if(FR.currentSection=="shares"){imgSrc+="shared_with_me.svg";text="There are no shared files or folders"}else if(FR.currentSection=="webLinked"){imgSrc+="link.svg";text="There are no shared links"}else if(FR.currentSection=="trash"){imgSrc+="trash.svg";text="There are no deleted files"}else if(FR.currentSection=="collection"){imgSrc+="files.svg";text="This collection is empty"}else if(FR.currentSection=="collections"){imgSrc+="files.svg";text="There are no collections"}else if(FR.currentSection=="photos"){imgSrc+="photos.svg";text="There are no photos in here"}else if(FR.currentSection=="videos"){imgSrc+="videos.svg";text="There are no videos in here"}else if(FR.currentSection=="music"){imgSrc+="music.svg";text="There are no audio files in here"}else{if(FR.currentFolderPerms.upload){imgSrc+="upload.svg";text=FR.T("Drop files here")+" "+FR.T('or use the "NEW" button')}else{imgSrc+="files.svg";text="This folder is empty"}}if(this.filterMode){var metaType=FR.metaFileTypes[this.filterMode].name;text=FR.T('There are no "%1" in here').replace("%1",metaType)}var count=this.grid.getStore().getTotalCount();if(count==1){text+="<br><br>"+FR.T("There is one other item");text+='<br><a href="javascript:;" onclick="FR.UI.gridPanel.view.showAll()" style="pointer-events:auto">'+FR.T("Show the item")+"</a>"}else if(count>1){text+="<br><br>"+FR.T("There are %1 other items").replace("%1",count);text+='<br><a href="javascript:;" onclick="FR.UI.gridPanel.view.showAll()" style="pointer-events:auto">'+FR.T("Show all items")+"</a>"}this.emptyText='<img class="illustration" src="'+imgSrc+'" />'+'<div class="text">'+FR.T(text)+"</div>";FR.components.gridView.superclass.applyEmptyText.apply(this,arguments)},showAll:function(){this.changeFilter(false)},layout:function(){FR.components.gridView.superclass.layout.apply(this);if(!this.isListViewStyle()){this.mainBody.setStyle("width","auto")}this.mainBody.setStyle("height","100%")},isListViewStyle:function(){return this.viewMode=="list"}});