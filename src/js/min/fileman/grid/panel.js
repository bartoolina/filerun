FR.components.gridPanel=Ext.extend(Ext.grid.GridPanel,{autoExpandColumn:"filename",autoExpandMin:130,autoExpandMax:600,minColumnWidth:70,highlightOnDisplay:false,highlightOnLoadCallback:false,region:"center",updateUIAround:function(){Ext.menu.MenuMgr.setCheckedItem("display_mode",this.view.viewMode)},initComponent:function(){this.addEvents("viewchange");this.initStore();var listeners={afterrender:function(){this.updateUIAround();this.view.focusEl.focus();this.view.scroller.on("scroll",function(){this.view.loadThumbs.delay(200,false,this.view)},this);this.setMetaCols()},resize:function(grid,width){this.view.loadThumbs.delay(200,false,this.view)},render:function(grid){var view=grid.getView();var scroller=view.scroller;if(User.perms.alter){this.view.dragZone.onStartDrag=function(){Ext.each(this.dragData.selections,function(item){var rowIdx=grid.store.indexOfId(item.id);var row=view.getRow(rowIdx);Ext.fly(row).addClass("dragging")})};this.view.dragZone.endDrag=function(){Ext.each(this.dragData.selections,function(item){var rowIdx=grid.store.indexOfId(item.id);var row=view.getRow(rowIdx);Ext.fly(row).removeClass("dragging")})}}this.dropZone=new Ext.dd.DropZone(scroller,{ddGroup:grid.ddGroup,getTargetFromEvent:function(e,dz){var rowEl=e.getTarget(view.rowSelector);if(rowEl){var record=grid.store.getById(view.getRecordId(rowEl));return{rowViewEl:rowEl,record:record,target:FR.Context.getTarget("grid",[record.data])}}else{if(dz.ddGroup=="tagging"){return{target:FR.Context.getTarget("currentFolder")}}}},checkRequirements:function(dropped,dz){if(dz.ddGroup=="tagging"){if(!dropped.target.checkRequirement("isFileOrFolder")){return false}}else{if(!dropped.target.checkRequirement("isFolderOrCollection")){return false}}return true},onNodeEnter:function(dropped,dz){if(this.checkRequirements(dropped,dz)){var el=dropped.rowViewEl||view.el.dom;el.classList.add("dragged-over")}},onNodeOut:function(dropped,dz){if(this.checkRequirements(dropped,dz)){var el=dropped.rowViewEl||view.el.dom;el.classList.remove("dragged-over")}},onNodeOver:function(dropped,dz,e,dropData){if(this.checkRequirements(dropped,dz)){return Ext.dd.DropZone.prototype.dropAllowed}},onNodeDrop:function(dropped,dz,e,dragData){var path=dropped.target.getPath();if(dz.ddGroup=="tagging"){FR.actions.processMetadata({url:"/?module=metadata&section=tags&page=add",params:{"paths[]":path,"tags[]":[dragData.tagValue]}});return true}else{var dragged=grid.target;if(FR.currentSection=="collections"||FR.currentSection=="albums"){var draggeFileInfo=dragged.getFileInfo();FR.actions.addToCollection({"paths[]":draggeFileInfo.paths||[draggeFileInfo.path],targetPath:path})}else{if(dragged.checkRequirement("isFileOrFolder")&&dropped.target.checkRequirement("folder")){FR.actions.move({data:dragData},path)}}return true}}});this.dropZone.addToGroup("tagging");if(!Ext.isMobile&&User.perms.upload){FlowUtils.DropZoneManager.add({domNode:scroller.dom,overClass:"dragged-over",findTarget:function(e){e=Ext.EventObject.setEvent(e);var rowEl=e.getTarget(view.rowSelector);var t;var heighlightEl;if(rowEl){var record=grid.store.getById(view.getRecordId(rowEl));if(record.data.isFolder){t=FR.Context.getTarget("grid",[record.data]);heighlightEl=rowEl}}if(!t){t=FR.Context.getTarget("currentFolder");heighlightEl=view.el.dom}if(!t.checkRequirement("upload")){return false}return{el:heighlightEl,target:t}},onDrop:function(e,target){FR.UI.showUploadWindow({targetPath:target.target.getPath(),dropEvent:e})},scope:this})}},folderChange:function(){if(!FR.UI.searchPanel.isVisible()){this.view.focusEl.focus()}FR.UI.searchPanel.folderChange();FR.UI.infoPanel.folderChange()},rowdblclick:function(grid,rowIndex,e){var record=grid.store.getAt(rowIndex);if(record){this.openItem(record.data)}e.stopEvent();return false},rowcontextmenu:function(grid,rowIndex,e){if(!e.ctrlKey&&!e.shiftKey){var s=this.selModel;if(!s.isSelected(rowIndex)){s.selectRow(rowIndex,false);this.countSel=1;var row=this.store.getAt(rowIndex);FR.currentSelectedFile=row.data;this.target=FR.Context.getTarget("grid",[FR.currentSelectedFile])}}if(this.countSel>0){this.showContextMenu()}e.stopEvent();return false},containercontextmenu:function(grid,e){if(!e.ctrlKey&&!e.shiftKey){this.selectNone();this.showContextMenu()}e.stopEvent()},containermousedown:function(grid,e){if(e.ctrlKey||e.shiftKey){return false}if(e.getTarget().classList.contains("x-grid3-scroller")){return true}this.selectNone()},scope:this};if(Ext.hasTouch){listeners.rowtap=function(grid,rowIndex,e){Ext.menu.MenuMgr.hideAll();var record=grid.store.getAt(rowIndex);if(!record){return false}if(this.countSel==0){this.openItem(record.data);return false}};listeners.rowtaphold=function(){Ext.menu.MenuMgr.hideAll()}}Ext.apply(this,{stateful:true,stateId:"files-grid-v3",stateEvents:["columnresize","columnmove","sortchange","viewchange","reconfigure"],ddGroup:"TreeDD",ds:this.store,cm:new FR.components.gridColumnModel,enableDragDrop:true,trackMouseOver:false,selModel:new Ext.grid.RowSelectionModel({listeners:{selectionchange:function(){this.onSelectionChange()},scope:this}}),keys:[{key:[10,Ext.EventObject.ENTER],fn:function(k,e){if(!FR.currentSelectedFile){return false}this.openItem(FR.currentSelectedFile)},scope:this,stopEvent:true},{key:[Ext.EventObject.BACKSPACE],fn:function(k,e){var c=FR.UI.tree.currentSelectedNode;if(c&&c.parentNode&&!c.parentNode.isRoot){c.parentNode.select().scrollIntoView()}},scope:this,stopEvent:true},{key:[Ext.EventObject.DELETE,Ext.EventObject.D],fn:function(k,e){var t=FR.UI.gridPanel.target;if(t.items.length==0){return false}if(!FR.Context.checkRequirement("isFileOrFolder",t)){return false}FR.contextMenuActions.remove(t,false,e)},scope:this,stopEvent:true},{key:[Ext.EventObject.S],fn:function(k,e){if(FR.currentFolderHasSearch){FR.UI.searchPanel.open()}},scope:this,stopEvent:true},{key:[Ext.EventObject.F2,Ext.EventObject.R],fn:function(){var t=FR.UI.gridPanel.target;if(t.items.length!=1){return false}var ot=t.objectTypes;if(!("file"in ot)&&!("folder"in ot)&&!("collection"in ot)){return false}FR.contextMenuActions.rename(t)},scope:this,stopEvent:true},{key:[Ext.EventObject.N],fn:function(){if(FR.currentSection=="collections"&&User.perms.alter){FR.actions.newCollectionPrompt()}else if(FR.currentSection=="albums"&&User.perms.alter){FR.actions.newCollectionPrompt({type:"album"})}else{var t=FR.Context.getTarget("currentFolder");if(FR.Context.checkRequirement("folder",t)&&FR.Context.checkRequirement("upload",t)){FR.contextMenuActions.newFolder(t)}}},stopEvent:true},{ctrl:true,key:[Ext.EventObject.A],fn:function(){FR.UI.gridPanel.selectAll()},stopEvent:true},{key:[Ext.EventObject.ESC],fn:function(){FR.UI.gridPanel.selectNone()},stopEvent:true},{key:[Ext.EventObject.F5],fn:function(){FR.utils.reloadGrid()},stopEvent:true},{key:[Ext.EventObject.PAGEDOWN,Ext.EventObject.PAGEUP],fn:function(){return true},stopEvent:false}],view:new FR.components.gridView,plugins:[new Ext.ux.GridDragSelector],listeners:listeners,bbar:new Ext.PagingToolbar({store:this.store,cls:"fr-paging-bar",hideRefresh:true,buttonAlign:"center",height:50,hidden:true,pageSize:Settings.ui_file_page_size})});this.addEvents(["folderChange"]);FR.components.gridPanel.superclass.initComponent.apply(this,arguments)},openItem:function(item){var path=item.path;if(item.isFolder){if(FR.currentSection=="trash"){return false}if(item.objectType=="virtual"){FR.UI.tree.offlineNode({text:item.filename,pathname:FR.utils.pathInfo(path).basename},FR.UI.tree.currentSelectedNode).select()}else{return FR.utils.browseToPath(path)}}var ext=item.ext;var ca=FR.UI.contextActions[FR.ext[ext]];if(FR.ext[ext]&&ca){return FR.actions.customAction(ca.pluginSettings,item.path,item.filename)}if(User.perms.download){if(Settings.ui_double_click=="download"){return FR.actions.download(path)}else if(Settings.ui_double_click=="downloadb"){return FR.actions.openFileInBrowser(path)}}if(User.perms.preview){FR.utils.showPreview(item)}},getDragDropText:function(){var count=this.selModel.getCount();if(count==1){return FR.T("One item")}return FR.T("%1 items").replace("%1",count)},initStore:function(){this.store=new FR.components.gridStore({listeners:{filterchanged:function(s,typeId){var tt=FR.UI.grid.filterTooltip;if(typeId){var metaType=FR.metaFileTypes[typeId].name;var title=FR.T('Showing only "%1"').replace("%1",metaType);if(!tt){tt=new Ext.Window({title:title,cls:"x-tip fr-grid-filter",bbar:[{text:"Show all",cls:"fr-btn-primary fr-btn-smaller",handler:function(){FR.UI.gridPanel.view.changeFilter(false)}}],closable:true,draggable:true,help:function(){new Ext.ux.prompt({text:FR.T('Showing only files for which the "File type" <strong>%1</strong> has been selected from the file\'s Metadata panel.').replace("%1",this.metaType)+"<br><br>"+FR.T("Browsing folders will maintain this filter until manually cleared.")})}});FR.UI.grid.filterTooltip=tt}else{tt.setTitle(title)}tt.metaType=metaType;tt.show();tt.anchorTo(FR.UI.actions.gridOptions.el.dom,"br-tr?")}else{if(tt){tt.hide()}}FR.UI.infoPanel.refresh()}}});this.store.on("exception",function(p,t,a,opt,response){FR.UI.actions.refresh.el.removeClass("fa-spin");this.view.mainBody.update("");var d=opt.reader.jsonData;if(d&&d.authError){new Ext.ux.prompt({title:"Error",text:d.msg,confirmBtnLabel:"Refresh",callback:function(){document.location.reload()}})}var msg=FR.T("Failed to load file list.");if(response.status==200){FR.lastGridServerResponse=response.responseText;msg+="<br>"+FR.T('<a href="%1">The data</a> received from the server contains errors.').replace("%1","javascript:alert(FR.lastGridServerResponse)")}else if(response.status==500){msg+="<br>"+FR.T("There is a server internal error (HTTP code 500).<br>The administrator should check the appropriate server error logs for related information.")}else if(response.status==0){msg+="<br>"+FR.T("Please check your network connection.")}else{msg+="<br>"+FR.T("The server HTTP response code is "+response.status)}this.body.mask(msg)},this);this.store.on("beforeload",function(store){var i=FR.UI.ImageViewer;if(i&&i.isVisible()){i.hide()}store.removeAll(true);store.totalLength=0;this.selModel.clearSelections(true);FR.UI.actions.refresh.el.addClass("fa-spin");this.view.mainBody.update("");FR.UI.infoPanel.tabs.detailsPanel.reset()},this);this.store.on("load",function(store){FR.UI.actions.refresh.el.removeClass("fa-spin");FR.lastGridServerResponse=false;var data=store.reader.jsonData;if(this.body.isMasked()){this.body.unmask()}if(data.error){this.view.mainBody.update("");new Ext.ux.prompt({title:"Error",text:data.error,callback:function(){FR.UI.tree.panel.selectFirstVisible()}})}else{this.fireEvent("folderChange",this,store);this.onSelectionChange();var h=this.highlightOnDisplay;if(h){this.highlight(h,this.highlightOnLoadCallback);this.highlightOnDisplay=false;this.highlightOnLoadCallback=false}if(data.countNewEvents){FR.UI.infoPanel.tabs.activityPanel.updateStatus(parseInt(data.countNewEvents))}}},this)},setMetaCols:function(){this.store.setBaseParam("metadata[]",this.colModel.getMetaCols())},selectAll:function(){this.selModel.suspendEvents().selectAll().resumeEvents().fireEvent("selectionchange",this.selModel)},selectNone:function(){FR.UI.contextMenu.hide();if(this.countSel==0){return false}this.selModel.suspendEvents().clearSelections().resumeEvents().fireEvent("selectionchange",this.selModel)},getSelectedFiles:function(){var list=[];this.selModel.each(function(row){var data=row.data;data.id=row.id;list.push(data)});return list},getSelectedAttrs:function(attr){var list=[];this.selModel.each(function(row){list.push(row.data[attr])});return list},getOneSel:function(){return this.selModel.selections.items[0]},getByPath:function(path){var rowIdx=this.store.findBy(function(r){if(r.data.path==path){return true}});return rowIdx!=-1?this.store.getAt(rowIdx):false},highlight:function(fileNames,callback){if(!Ext.isArray(fileNames)){fileNames=[fileNames]}var count=0;Ext.each(fileNames,function(fileName){var rowIdx=this.store.findBy(function(record){if(record.data.filename==fileName){return true}});if(rowIdx==-1){if(callback){callback(false)}return false}this.selModel.selectRow(rowIdx,count>0);this.getView().focusRow(rowIdx);if(callback){callback(true,this.store.getAt(rowIdx))}count++},this);this.highlightOnDisplay=false;return count>0},highlightByRecord:function(recordData){var rowIdx=this.store.findBy(function(r){if(r.data==recordData){return true}});if(rowIdx>-1){this.selModel.selectRow(rowIdx);this.getView().focusRow(rowIdx)}},load:function(path){this.store.setBaseParam("path",Ext.value(path,FR.currentPath));this.store.load()},onSelectionChange:function(){this.target=FR.Context.getTarget("grid",this.getSelectedFiles());if(!this.target){return false}this.countSel=this.target.items.length;this.view.el.toggleClassIf("withSelection",this.countSel>0);FR.UI.headerTBar.el.toggleClassIf("highlighted",this.countSel>0);if(this.countSel==0){FR.currentSelectedFile=false}else{if(this.countSel==1){FR.currentSelectedFile=this.target.items[0]}}this.showTopMenu();FR.UI.infoPanel.refresh()},showTopMenu:function(){var hideByDefault=["openTree","selected","filePick","newItem","searchBtn","download","weblink","shareWithUsers","preview","remove","more","info"];Ext.iterate(hideByDefault,function(k){FR.UI.actions[k].hide();FR.UI.actions[k].xtbHidden=false});FR.UI.headerTBar.layout.hiddenItems=[];Ext.each(FR.UI.headerTBar.initialConfig.items,function(ca){var cfg=ca.initialConfig;if(cfg&&cfg.requires){var meets=0;if(cfg.debug){console.log(cfg.tooltip)}Ext.each(cfg.requires,function(req){var met;if(typeof req=="function"){met=req(this.target,ca)}else{met=FR.Context.checkRequirement(req,this.target)}if(cfg.debug){console.log("\t",req,met);console.log(this.target.location,this.target.items.length)}if(met){meets++}else{return false}},this);if(cfg.requires.length==meets){ca.show()}else{ca.hide()}}},this);if(this.countSel!=0){var text=FR.UI.layout.isSmall?this.countSel:FR.T("% selected").replace("%",this.countSel);FR.UI.actions.selected.setText(text)}FR.UI.headerTBar.doLayout(true)},showContextMenu:function(alignTo){if(!this.target){return false}FR.UI.contextMenu.event({location:"grid",alignTo:alignTo})},reset:function(){this.store.removeAll(true);this.store.totalLength=0;this.view.refresh();return this}});