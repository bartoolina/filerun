var FR={chooser:false,UI:{tree:{}},defaultPerms:{upload:false,download:true,comment:true,read_comments:true,share:false,alter:false},removeUser:function(){FR.UI.tree.rootNode.removeChild(FR.UI.tree.panel.getSelectionModel().getSelectedNode());if(FR.UI.tree.rootNode.firstChild){FR.UI.tree.rootNode.firstChild.select()}},addUsers:function(){if(!FR.chooser){FR.chooser=new UserChooser({windowCfg:{maximized:false,modal:true,draggable:false},addGuest:function(){new Ext.ux.prompt({title:FR.T("Guest user's name"),defaultValue:"",confirmBtnLabel:FR.T("Next"),confirmHandler:function(name){if(!name){return false}new Ext.ux.prompt({title:FR.T("%1's e-mail address").replace("%1",name),defaultValue:"",confirmBtnLabel:FR.T("Add user"),confirmHandler:function(email){if(!email){return false}FR.addToList({text:name,iconCls:"fa-user-plus",uid:email,guest:1})},cancelHandler:function(){FR.addUsers()}})},cancelHandler:function(){FR.addUsers()}})}})}FR.chooser.clearChecked();FR.chooser.show(false,function(data){var treeRoot=FR.UI.tree.rootNode;if(data.users){Ext.each(data.users,function(user){if(!treeRoot.findChild("uid",user.uid)){FR.addToList({text:user.name,uid:user.uid,iconCls:"basicAvatar",icon:"a/?uid="+user.uid})}})}if(data.groups){Ext.each(data.groups,function(group){if(!treeRoot.findChild("gid",group.gid)){FR.addToList({text:group.name,gid:group.gid,iconCls:"basicAvatar group",icon:"a/?gid="+group.gid})}})}})},addToList:function(data){data.leaf=true;if(!data.perms){data.perms={};Ext.apply(data.perms,FR.defaultPerms)}if(!data.anonymous){data.anonymous=0}var newTreeNode=new Ext.tree.TreeNode(data);FR.UI.tree.rootNode.appendChild(newTreeNode);if(!FR.UI.tree.panel.getSelectionModel().getSelectedNode()){newTreeNode.select()}},getInfo:function(){Ext.getCmp("optPane").getEl().mask("Add Users");FR.viewPort.el.mask(FR.loadingMsg);Ext.Ajax.request({url:URLRoot+"/?module=share&section=ajax&page=load",method:"post",params:{"paths[]":window.parent.FR.sharing.paths},success:function(req){FR.viewPort.el.unmask();try{var rs=Ext.util.JSON.decode(req.responseText)}catch(er){return false}if(rs){FR.shareInfo=rs;FR.applyInfo(rs)}}})},applyInfo:function(info){var error=info.error||info.msg;if(error){FR.viewPort.el.mask(error);return false}var countItems=window.parent.FR.sharing.paths.length;var hideOptions=false;if(countItems>1){hideOptions=true;Ext.getCmp("copyLinkBtn").hide();Ext.getCmp("saveBtn").setText(FR.T("Apply to all %1 items").replace("%1",countItems))}else{Ext.getCmp("copyLinkBtn").show();Ext.getCmp("saveBtn").setText("Apply")}if(hideOptions||!info.isFolder){Ext.getCmp("options_panel").ownerCt.activate("permissions_panel");Ext.getCmp("options_panel").disable()}else{Ext.getCmp("options_panel").enable()}var troot=FR.UI.tree.rootNode;while(troot.firstChild){troot.removeChild(troot.firstChild)}Ext.each(info.recipients,function(record){var r={name:record.name,text:record.name,leaf:true,anonymous:record.anonymous,perms:record.perms,alias:record.alias};if(record.uid){r.iconCls="basicAvatar";r.icon="a/?uid="+record.uid;r.uid=record.uid}else{r.iconCls="basicAvatar group";r.icon="a/?gid="+record.gid;r.gid=record.gid}FR.addToList(r)});if(troot.childNodes.length>0){troot.firstChild.select();if(FR.chooser){FR.chooser.dlg.hide()}}else{FR.addUsers()}},saveInfo:function(){var paths=window.parent.FR.sharing.paths;var pars={"paths[]":paths,csrf:FR.csrf_token,"actors[]":[]};FR.UI.tree.rootNode.eachChild(function(node){if(!node.disabled){var a=node.attributes;var data={name:node.text,upload:a.perms.upload?1:0,download:a.perms.download?1:0,alter:a.perms.alter?1:0,read_comments:a.perms.read_comments?1:0,comment:a.perms.comment?1:0,share:a.perms.share?1:0,anonymous:a.anonymous?1:0,alias:paths.length>1?"":a.alias};if(a.gid){data.type="group";data.id=a.gid}else{data.type=a.guest?"guest":"user";data.id=a.uid}pars["actors[]"].push(JSON.stringify(data))}});FR.viewPort.el.mask("Applying..");Ext.Ajax.request({url:URLRoot+"/?module=share&section=ajax&page=save",method:"post",params:pars,success:function(req){FR.viewPort.el.unmask();try{var rs=Ext.util.JSON.decode(req.responseText)}catch(er){return false}if(rs.success){window.parent.FR.UI.popups.folderShare.hide();if(rs.updates){window.parent.FR.utils.applyBatchFileUpdates(rs.updates)}}window.parent.FR.UI.feedback(rs.msg,rs.success?"success":"error")}})}};Ext.onReady(function(){Ext.QuickTips.init();FR.update=FR.getInfo;FR.UI.tree.panel=new Ext.tree.TreePanel({id:"usersList",cls:"plain-list",animate:true,containerScroll:true,rootVisible:false,autoScroll:true});FR.UI.tree.panel.getSelectionModel().on("selectionchange",function(sel,node){if(sel.getSelectedNode()){Ext.getCmp("optPane").getEl().unmask()}else{Ext.getCmp("optPane").getEl().mask("Add Users")}if(!node){Ext.getCmp("optPane").setTitle("&nbsp;");return false}Ext.getCmp("optPane").setTitle(node.text);Ext.getCmp("perms_upload").suspendEvents().setValue(node.attributes.perms.upload).resumeEvents();Ext.getCmp("perms_download").suspendEvents().setValue(node.attributes.perms.download).resumeEvents();Ext.getCmp("perms_comment").suspendEvents().setValue(node.attributes.perms.comment).resumeEvents();Ext.getCmp("perms_share").suspendEvents().setValue(node.attributes.perms.share).resumeEvents();Ext.getCmp("perms_read_comments").suspendEvents().setValue(node.attributes.perms.read_comments).resumeEvents();Ext.getCmp("perms_alter").suspendEvents().setValue(node.attributes.perms.alter).resumeEvents();Ext.getCmp("anonymous").suspendEvents().setValue(node.attributes.anonymous).resumeEvents();Ext.getCmp("alias").suspendEvents().setValue(node.attributes.alias).resumeEvents();FR.currentlySelectedNode=node});FR.UI.tree.rootNode=new Ext.tree.TreeNode({});FR.UI.tree.panel.setRootNode(FR.UI.tree.rootNode);var listPaneCfg={id:"listPane",split:true,layout:"fit",items:FR.UI.tree.panel,tbar:[{iconCls:"fa-user-plus",text:"Add Users",handler:FR.addUsers}]};var optPaneCfg={};if(window.innerWidth<500){listPaneCfg.region="north";listPaneCfg.cls="vertical";listPaneCfg.height=Math.round(window.innerHeight/3);listPaneCfg.margins="10px 0 0 0";optPaneCfg.margins="1px 0 10px 0"}else{listPaneCfg.region="west";listPaneCfg.cls="horizontal";listPaneCfg.width=240;listPaneCfg.margins="15px 0";optPaneCfg.margins="0 0 15px 15px"}FR.viewPort=new Ext.Viewport({layout:"fit",cls:"fr-sharing-panel",items:[{layout:"border",items:[listPaneCfg,{id:"optPane",cls:"sharePanelOptionsPanel",region:"center",margins:optPaneCfg.margins,title:"",layout:"fit",tools:[{toolType:"addUser",iconCls:"fa-minus-circle colorDanger",text:"Remove",handler:FR.removeUser}],items:[{xtype:"tabpanel",activeTab:0,deferredRender:false,autoScroll:true,items:[{title:"Permissions",id:"permissions_panel",autoScroll:true,items:{xtype:"form",labelAlign:"right",bodyStyle:"padding:10px",labelWidth:0,items:[{id:"perms_download",xtype:"checkbox",inputType:"checkbox",boxLabel:FR.T("Download"),hideLabel:true,name:"perms_download",value:1,listeners:{check:function(inpt,checked){FR.currentlySelectedNode.attributes.perms.download=checked}}},{id:"perms_read_comments",xtype:"checkbox",inputType:"checkbox",boxLabel:"Read comments",hideLabel:true,name:"perms_read_comments",value:1,listeners:{check:function(inpt,checked){FR.currentlySelectedNode.attributes.perms.read_comments=checked}}},{id:"perms_comment",xtype:"checkbox",inputType:"checkbox",boxLabel:"Add comments",hideLabel:true,name:"perms_comment",value:1,listeners:{check:function(inpt,checked){FR.currentlySelectedNode.attributes.perms.comment=checked}}},{id:"perms_upload",xtype:"checkbox",inputType:"checkbox",boxLabel:"Upload",hideLabel:true,name:"perms_upload",value:1,listeners:{check:function(inpt,checked){FR.currentlySelectedNode.attributes.perms.upload=checked}}},{id:"perms_alter",xtype:"checkbox",inputType:"checkbox",boxLabel:"Make changes",hideLabel:true,name:"perms_alter",value:1,listeners:{check:function(inpt,checked){FR.currentlySelectedNode.attributes.perms.alter=checked}}},{id:"perms_share",xtype:"checkbox",inputType:"checkbox",boxLabel:"Share links",hideLabel:true,name:"perms_share",value:1,listeners:{check:function(inpt,checked){FR.currentlySelectedNode.attributes.perms.share=checked}}}]}},{title:"Options",id:"options_panel",items:{xtype:"form",autoWidth:true,bodyStyle:"padding:10px;",labelWidth:FR.language=="french"?95:80,items:[{xtype:"textfield",id:"alias",anchor:"100%",enableKeyEvents:true,fieldLabel:"Share as",listeners:{keyup:function(inpt){FR.currentlySelectedNode.attributes.alias=inpt.getValue()}}},{xtype:"displayfield",value:""},{id:"anonymous",xtype:"checkbox",inputType:"checkbox",boxLabel:"Share anonymously",hideLabel:true,name:"anonymous",value:1,listeners:{check:function(inpt,checked){FR.currentlySelectedNode.attributes.anonymous=checked}}}]}}]}]}],buttons:[{id:"saveBtn",text:"Apply",cls:"fr-btn-primary",handler:function(){FR.saveInfo()}},{text:"Cancel",style:"margin-left:10px",handler:function(){window.parent.FR.UI.popups.folderShare.hide()}},"->",{id:"copyLinkBtn",hidden:true,text:"Copy direct link",handler:function(){var tempInput=document.createElement("input");tempInput.value=URLRoot+"/index.php/f/"+FR.shareInfo.pid;document.body.appendChild(tempInput);tempInput.select();try{if(document.execCommand("copy")){window.parent.FR.UI.feedback(window.parent.FR.T("The link has been copied to clipboard."))}}catch(err){}document.body.removeChild(tempInput)}}]}]});FR.loadingMsg=window.parent.FR.T("Loading...");FR.viewPort.el.mask(FR.loadingMsg);FR.getInfo()});