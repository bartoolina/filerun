FR.components.detailsPanel=Ext.extend(Ext.Panel,{layout:"border",cls:"fr-details-panel",icon:"fa-info-circle",title:"Details",hidePreview:false,lastTargetId:false,autoWidth:true,initComponent:function(){this.moreDetailsCache=new Ext.util.MixedCollection;this.moreDetailsLoaderTask=new Ext.util.DelayedTask(function(){this.loadMoreDetails()},this);var ths=this;Ext.apply(this,{items:[{region:"center",layout:"fit",bodyCssClass:"fr-details-panel-body",listeners:{afterrender:function(){ths.readmeContainer=this.body.createChild({cls:"fr-details-fields readmeContainer"}).enableDisplayMode("block");ths.thumbContainer=this.body.createChild({cls:"fr-details-thumb",children:[{tag:"img",cls:"empty",alt:""}]});ths.thumbImg=Ext.get(ths.thumbContainer.first());ths.thumbImg.on("load",function(){if(!this.dom){return false}var maxW=ths.getWidth()-30;var maxH=Math.round((ths.getHeight()-50)/1.9);this.removeClass("empty").setStyle(FR.UI.bestImgSizeToFitFixed(this.dom.naturalWidth,this.dom.naturalHeight,maxW,maxH));if(!ths.fileInfo||!ths.fileInfo){return false}this.toggleClassIf("isNotPicture",!FR.UI.fileTypeIsMedia(ths.fileInfo.filetype))});ths.thumbImg.on("error",function(){ths.hideThumbnail()});ths.thumbContainer.first().on("click",function(){FR.utils.showPreview(ths.fileInfo)},this);ths.infoEl=this.body.createChild({cls:"fr-details-fields"}).enableDisplayMode("block");ths.labelSection=this.body.createChild({cls:"fr-details-fields"}).enableDisplayMode("block");var id="labelField"+this.id;ths.labelSection.appendChild(ths.makeFieldset({fields:[{name:"Label",cls:"centerv",values:[{id:id}]}]}));ths.labelButton=new Ext.Button({renderTo:id,cls:"labelSelector",text:"&nbsp;",menu:new Ext.menu.Menu({modal:Ext.isMobile,items:FR.UI.getLabelMenuItems(function(label,labelObj){ths.labelButton.applyLabel(labelObj);FR.actions.setLabel(ths.infoPanel.target,label,{successCallback:function(){ths.clearDetailCache()},scope:ths})})}),menuIndicator:true,applyLabel:function(label){this.labelValue=label;if(!label){label={text:FR.T("No label"),color:"var(--theme-textLight)"}}this.el.setStyle({color:label.color,"border-color":label.color});this.setText(label.text)}});if(Settings.ui_enable_rating){var id="ratingField"+this.id;ths.ratingEl=this.body.createChild({cls:"fr-details-fields",children:[{cls:"field centerv",children:[{cls:"name",html:FR.T("Rating")},{cls:"value",id:id}]}]}).enableDisplayMode("block");ths.ratingField=new Ext.ux.form.StarField({renderTo:id,listeners:{change:function(f,v){this.setMetadata({params:{"fields[rating]":v}})},scope:ths}})}ths.moreDetailsEl=this.body.createChild({cls:"fr-details-fields"}).enableDisplayMode("block");ths.tagsSection=this.body.createChild({cls:"fr-details-fields"}).enableDisplayMode("block");ths.tagsSection.appendChild(ths.makeFieldset({name:"Tags",value:{tag:"a",cls:"editIcon",href:"javascript:FR.UI.showTagsHelp()",html:'<i class="fa fa-info-circle"></i>'}}));ths.tagsPanel=new FR.components.tagsPanel({detailsPanel:ths,renderTo:ths.tagsSection.createChild({},false,true)})}}}],listeners:{activate:function(p){p.onInfoPanelRefresh()},scope:this}});FR.components.detailsPanel.superclass.initComponent.apply(this,arguments)},onInfoPanelRefresh:function(){if(!this.active){return false}this.fileInfo=this.infoPanel.fileInfo;this.updateQuickView()},reset:function(){if(!this.active||!this.rendered){return false}this.tabButton.setIconClass("fa-info-circle");this.moreDetailsLoaderTask.cancel();if(this.loadMoreDetailsRequest&&this.loadMoreDetailsRequest.conn){this.loadMoreDetailsRequest.conn.abort()}this.readmeContainer.hide().update("");this.infoEl.hide().update("");this.labelSection.hide();if(Settings.ui_enable_rating){this.ratingField.setValue(0);this.ratingEl.hide()}this.moreDetailsEl.hide().update("");this.tagsSection.hide();this.tagsPanel.reset();this.doLayout(true)},updateQuickView:function(){if(!this.active||!this.infoPanel.target){return false}if(this.lastTargetId&&this.lastTargetId==this.infoPanel.target.id){return false}this.lastTargetId=this.infoPanel.target.id;this.reset();this.targetIsFileOrFolder=this.infoPanel.target.checkRequirement("isFileOrFolder");this.canAlterTarget=this.infoPanel.target.checkRequirement("alter");this.countSel=this.infoPanel.target.items.length;if(this.countSel==1){this.showThumbnail();this.showDetails();this.showMoreDetails()}else{this.hideThumbnail();if(FR.UI.gridPanel.store.getCount()>0){this.showStatus();if(Settings.ui_enable_rating&&this.targetIsFileOrFolder){this.ratingEl.setVisible(this.countSel>0)}}if(this.countSel==0){if(!FR.UI.gridPanel.view.searchMode){this.showMoreDetails()}}else{this.showTags()}this.doLayout(true)}},showTags:function(){var visible=User.perms.metadata&&this.targetIsFileOrFolder;this.tagsPanel.setReadOnly(!this.canAlterTarget);this.tagsSection.setVisible(visible)},showThumbnail:function(){if(this.hidePreview||FR.UI.layout.isSmall||FR.UI.gridPanel.view.viewMode=="photos"||FR.UI.gridPanel.view.viewMode=="large_grid"||!this.fileInfo||this.fileInfo.objectType!="file"||this.fileInfo.filetype=="mp3"||!this.fileInfo.thumb){this.hideThumbnail()}else{if(!this.fileInfo.thumbURL){this.fileInfo.thumbURL=FR.UI.getThumbURL(this.fileInfo)}this.thumbImg.set({src:this.fileInfo.thumbURL})}},hideThumbnail:function(){this.thumbImg.dom.removeAttribute("src");this.thumbImg.set({cls:"empty",style:{width:"0px",height:"0px"}})},showStatus:function(){var size=0,items;var gridPanel=FR.UI.gridPanel;var fields=[];if(this.countSel>0){items=gridPanel.selModel.getSelections();fields.push({name:"Selected",values:[FR.utils.showCount(this.countSel,"One item","%1 items")]})}else{items=gridPanel.store.data.items;var count=gridPanel.store.getCount();fields.push({name:"Listing",values:[FR.T("%1 items").replace("%1",Ext.util.Format.number(count,"0,000"))]})}Ext.each(items,function(item){if(["folder","collection"].includes(item.data.objectType)){size=false;return false}size+=parseInt(item.data.filesize)});if(size===false){if(["photos","videos","music"].indexOf(FR.currentSection)===-1){size={tag:"a",html:FR.T("[calculate]"),onclick:"javascript:FR.UI.calculateSelectionSize(this)"}}}else{size=Ext.util.Format.fileSize(size)}fields.push({name:"Size",values:[size]});if(this.countSel==0){var filterMode=FR.UI.gridPanel.view.filterMode;if(filterMode){fields.push({name:"Showing only",values:[{html:FR.metaFileTypes[filterMode].name}]})}var totalCount=gridPanel.store.getTotalCount();if(totalCount&&totalCount!=count){fields.push({name:"All",values:[FR.T("%1 items").replace("%1",Ext.util.Format.number(totalCount,"0,000"))]});if(["myfiles","sharedFolder"].indexOf(FR.currentSection)!==-1){fields.push({name:"Size",values:[{tag:"a",html:FR.T("[calculate]"),onclick:"javascript:FR.UI.calculateSelectionSize(this, true)"}]})}}}this.infoEl.show().appendChild(this.makeFieldset({fields:fields}))},showDetails:function(){var fields=[];var d=this.infoPanel.fileInfo;if(d.ext){this.infoEl.appendChild(this.makeFieldset({fields:[{name:"Type",style:"padding-top: 8px;",values:[{cls:"extLabel ext_"+d.ext,html:d.ext.toUpperCase(),"ext:qtip":d.type}]}]}))}if(this.targetIsFileOrFolder){if(!["userWithShares","myfiles","sharedFolder","trash"].includes(FR.currentSection)||FR.UI.gridPanel.view.searchMode){fields.push({name:"Location",type:"locate",values:[d.path]})}if(FR.currentSection=="trash"){fields.push({name:"Deleted from",type:"locate",values:[d.trash_deleted_from]})}}if(["folder","collection"].includes(d.objectType)){fields.push({name:"Size",values:[{tag:"a",html:FR.T("[calculate]"),onclick:"javascript:FR.UI.calculateSelectionSize(this)"}]})}else if(d.objectType=="file"){fields.push({name:"Size",qtip:Ext.util.Format.number(d.filesize,"0,000")+" "+FR.T("bytes"),values:[d.nice_filesize]})}if(d.modified&&d.created&&d.modified.getTime()!=d.created.getTime()){fields.push({name:"Modified",qtip:d.modified,values:[Settings.grid_short_date?d.modifiedHuman:Ext.util.Format.date(d.modified,FR.T("Date Format: Files"))]})}if(d.created){fields.push({name:"Created",qtip:d.created,values:[Settings.grid_short_date?d.createdHuman:Ext.util.Format.date(d.created,FR.T("Date Format: Files"))]})}if(d.lockInfo){fields.push({name:"Locked by",values:[d.lockInfo]})}if(d.version>1){fields.push({name:"Version",values:[{tag:"a",href:"javascript:FR.actions.openVersions(FR.UI.getInfoPanelById('"+this.infoPanel.id+"').target);",html:d.version.toString()}]})}this.infoEl.show().appendChild(this.makeFieldset({fields:fields}))},getMoreDetailsFromCache:function(){if(!this.moreDetailsCache.containsKey(this.fileInfo.path)){return false}return this.moreDetailsCache.get(this.fileInfo.path)},showMoreDetails:function(){if(!this.targetIsFileOrFolder){return false}var md=this.getMoreDetailsFromCache();if(md){this.applyMoreDetails(md)}else{this.moreDetailsLoaderTask.delay(500)}},loadMoreDetails:function(){if(!this.fileInfo){return false}this.moreDetailsEl.update("").show();this.tabButton.setIconClass("fa-spin fa-refresh");this.loadMoreDetailsRequest=Ext.Ajax.request({url:FR.baseURL+"/?module=fileman&section=get&page=details",params:{path:this.fileInfo.path},callback:function(opts,succ,req){this.tabButton.setIconClass("fa-info-circle");if(!this.fileInfo){return false}try{var rs=Ext.decode(req.responseText)}catch(er){FR.UI.feedback("Failed to load details","error");return false}var path=this.fileInfo.path;if(!this.moreDetailsCache.containsKey(path)){this.moreDetailsCache.add(path,rs)}else{this.moreDetailsCache.replace(path,rs)}this.applyMoreDetails(rs)},scope:this})},applyMoreDetails:function(rs){this.moreDetailsEl.hide();if(!rs.success){return}var d=rs.data;if(this.infoPanel.target.checkRequirement("not-homefolder")){if(this.infoPanel.target.perms.comment||d.label){this.labelSection.show();this.labelButton.applyLabel(d.label)}if(Settings.ui_enable_rating){if(this.canAlterTarget||d.rating){this.ratingEl.show();this.ratingField.setValue(d.rating)}}}this.moreDetailsEl.update().show();if(d.meta_type){this.moreDetailsEl.appendChild(this.makeFieldset({fields:[{name:"Meta type",values:d.meta_type}]}))}if(d.sharing&&d.sharing.length>0){var sharedWith=[];Ext.each(d.sharing,function(record){var cls="basicAvatar";var avatarURL="a/?uid="+record.id;if(record.type=="group"){avatarURL="a/?gid="+record.id;cls+=" group"}var style="display:inline-block;margin-right:5px;background-image:url("+avatarURL+")";sharedWith.push({tag:"a",href:"javascript:FR.contextMenuActions.shareWithUsers(FR.UI.getInfoPanelById('"+this.infoPanel.id+"').target)",children:[{tag:"i",cls:cls,style:style,"ext:qtip":record.name}]})},this);this.moreDetailsEl.appendChild(this.makeFieldset({fields:[{name:"Shared with",children:sharedWith}]}))}if(FR.UI.fileTypeIsMedia(this.fileInfo.filetype)||d.albums&&d.albums.length>0){var albums=[];Ext.each(d.albums,function(album){var path="/ROOT/Photos/Albums/"+album.id;albums.push({html:"<a href=\"javascript:FR.utils.locateItem('"+path+'\');" ext:qtip="Go to album"><i class="fa fa-images"></i> '+album.name+"</a>"})});if(d.albums&&d.albums.length>0){albums.push({style:"height:5px;"})}albums.push({html:"<a href=\"javascript:FR.contextMenuActions.add2Album(FR.UI.getInfoPanelById('"+this.infoPanel.id+"').target)\">"+FR.T("Add to album")+"</a>"});this.moreDetailsEl.appendChild(this.makeFieldset({fields:[{name:"Albums",children:albums}]}))}if(d.collections&&d.collections.length>0){var collections=[];Ext.each(d.collections,function(collection){var path="/ROOT/Collections/"+collection.id;collections.push({html:"<a href=\"javascript:FR.utils.locateItem('"+path+'\');" ext:qtip="Go to collection"><i class="fa fa-clone"></i> '+collection.name+"</a>"})});collections.push({style:"height:5px;"});collections.push({html:"<a href=\"javascript:FR.contextMenuActions.add2Col(FR.UI.getInfoPanelById('"+this.infoPanel.id+"').target)\">"+FR.T("Add to collection")+"</a>"});this.moreDetailsEl.appendChild(this.makeFieldset({fields:[{name:"Collections",children:collections}]}))}if(d.metadata.fieldsets){Ext.each(d.metadata.fieldsets,function(set){this.moreDetailsEl.appendChild(this.makeFieldset(set))},this)}else{if(User.perms.metadata&&this.canAlterTarget){this.moreDetailsEl.appendChild(this.makeFieldset({fields:[{name:{tag:"a",href:"javascript:FR.actions.openMetadata(FR.UI.getInfoPanelById('"+this.infoPanel.id+"').target)",html:FR.T("Add details")}}]}))}}var gps=d.metadata.gps;if(gps&&Settings.google_static_maps_api_key){var color=getComputedStyle(document.body).getPropertyValue("--theme-lighter").replace(" ","").replace("#","0x");var url="https://maps.googleapis.com/maps/api/staticmap?size=300x300&zoom=11&scale=2&&markers=color:"+color+"|"+gps.x+","+gps.y+"&key="+encodeURIComponent(Settings.google_static_maps_api_key);if(Settings.ui_theme=="dark"){url+="&style=invert_lightness:true"}this.moreDetailsEl.appendChild(this.makeFieldset({name:"Location",fields:[{cls:"map",html:'<a href="https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(gps.x+","+gps.y)+'" target="_blank"><img src="'+url+'" width="100%" loading="lazy" /></a>'}]}))}if(!(d.tags.length==0&&!this.canAlterTarget)){this.showTags();this.tagsPanel.setNew(d.tags)}if(d.readmeFileName){this.showReadMe(d.readmeFileName)}this.doLayout(true)},makeFieldset:function(set){var obj={children:[]};if(set.name){var title={cls:"field title",children:[]};title.children.push({cls:"name",html:FR.T(set.name)});var v="";if(set.id&&this.infoPanel.target.checkRequirement("alter")){v={tag:"a",cls:"editIcon",html:'<i class="fa fa-pen"></i>'}}else if(set.value){v=set.value}title.children.push({cls:"value",children:[v]});obj.children.push(title)}Ext.each(set.fields,function(field){if(!field.name){obj.children.push(field);return true}var valueObj={cls:"value",children:[]};if(field.values){Ext.each(field.values,function(val){if(field.type=="large"){val={html:val}}else if(field.type=="locate"){var folderPath=FR.utils.pathInfo(val).dirname;var hpath=FR.utils.humanFilePath(folderPath);var humanPinfo=FR.utils.pathInfo(hpath);val={html:"<a href=\"javascript:FR.utils.locateItem('"+folderPath+'\')" ext:qtip="'+hpath.replaceAll("/","/<wbr>")+'">'+humanPinfo.basename+"</a>"}}else{if(field.id){if(field.type=="date"){val={children:[{tag:"a",cls:"search","data-field-id":field.id,"data-smode":"begins",html:val.substr(0,10)},val.substr(10)]}}else{val={tag:"a",cls:"search","ext:qtip":FR.T("Click to search by %1").replace("%1","<strong>"+field.name.toLowerCase()+"</strong>"),"data-field-id":field.id,html:val};if(field.searchMode){val["data-smode"]=field.searchMode}}}}var v={children:[val]};if(field.qtip){v["ext:qtip"]=field.qtip}valueObj.children.push(v)})}else{valueObj.children=field.children}obj.children.push({cls:"field"+(field.cls?" "+field.cls:""),children:[{cls:"name",style:field.style||"",children:Ext.isString(field.name)?[FR.T(field.name)]:field.name},valueObj]})});var div=Ext.DomHelper.createDom(obj);Ext.each(Ext.fly(div).query("a.search"),function(a){Ext.fly(a).on("click",function(){FR.actions.filterMeta(this.dataset.fieldId,this.innerText,this.dataset.smode||"exact")},a)});Ext.each(Ext.fly(div).query("a.editIcon"),function(a){if(!a.href){Ext.fly(a).on("click",function(){FR.actions.openMetadata(this.infoPanel.target)},this)}},this);return div},showReadMe:function(readmeFileName){var url=FR.baseURL+"/?section=utils&page=readme&path="+encodeURIComponent(this.infoPanel.fileInfo.path);this.readmeContainer.show();var section=this.readmeContainer.createChild({children:[{cls:"field title",children:[{cls:"name",html:readmeFileName},{cls:"value",children:[{tag:"a",cls:"editIcon",href:"javascript:FR.actions.editReadMe('"+readmeFileName+"')",html:'<i class="fa fa-pen"></i>'}]}]},{cls:"fr-details-readme",html:'<iframe style="border:none;" width="100%" src="'+url+'" loading="lazy"></iframe>'}]});this.readMeEl=section.child("iframe")},onReadMeLoad:function(h){if(this.readMeEl){this.readMeEl.setHeight(Math.min(h+5,300))}},setMetadata:function(opts){if(this.infoPanel.target.items.length>1){opts.params["paths[]"]=this.infoPanel.target.getFileInfo().paths}else{opts.params["paths[]"]=this.fileInfo.path}if(!opts.successCallback){opts.successCallback=Ext.emptyFn}var ths=this;opts.successCallback=opts.successCallback.createSequence(function(rs,opts){Ext.each(opts.params["paths[]"],function(path){ths.clearDetailCache(path)},ths)});FR.actions.processMetadata(opts)},clearDetailCache:function(path){if(!path){path=this.fileInfo.path}if(this.moreDetailsCache.containsKey(path)){this.moreDetailsCache.removeKey(path)}}});