Ext.onReady(function(){Ext.QuickTips.init();var fieldWidth=170;var labelWidth=110;if(["german","dutch","finnish","turkish","italian"].indexOf(FR.language)!=-1){labelWidth=180}else if(["french","spanish","danish"].indexOf(FR.language)!=-1){labelWidth=160}FR.viewSettings={};var tabs=[];tabs.push({title:"Options",autoScroll:true,bodyStyle:"padding:15px 0px 0px 15px",items:[{layout:"form",defaults:{xtype:"checkbox",value:"1",hideLabel:true},items:[{name:"allow_downloads",id:"allow_downloads"},{name:"allow_editing",id:"allow_editing"},{name:"allow_uploads",id:"allow_uploads"},{boxLabel:"Receive e-mail notifications.",name:"notify",id:"notify",helpText:FR.T("Receive e-mail notifications when visitors upload or download files via this link.")},{boxLabel:"Share the file comments with the visitors.",name:"show_comments",id:"show_comments",hidden:!window.parent.User.perms.read_comments,listeners:{check:function(field,checked){Ext.getCmp("show_comments_names").setVisible(checked)}}},{boxLabel:"Display users names.",hidden:!window.parent.User.perms.read_comments,xtype:"checkbox",value:"1",name:"show_comments_names",id:"show_comments_names"},{boxLabel:"Share the metadata with the visitors.",name:"show_metadata",id:"show_metadata",hidden:!window.parent.User.perms.metadata}]}]});tabs.push({title:"Restrictions",autoScroll:true,bodyStyle:"padding:15px 15px 18px 15px",items:[{layout:"form",labelAlign:Ext.isMobile?"top":"right",labelWidth:labelWidth,items:[{xtype:"datefield",fieldLabel:"Expiration date",width:fieldWidth,name:"expiry",id:"expiry",minValue:new Date,helpText:FR.T("The link will stop working at the end of this specified day.")},{xtype:"numberfield",fieldLabel:"Download limit",name:"download_limit",id:"download_limit",width:50,allowDecimals:false,allowNegative:false,autoStripChars:true,helpText:FR.T("Specify a number of downloads after which the link will stop working.")},{xtype:"textfield",fieldLabel:"Set a password",name:"password",id:"password",selectOnFocus:true,width:fieldWidth,listeners:{focus:function(){if(this.getRawValue().length==0){this.setValue(randomPass(12,true,true,true,true,2));this.getEl().dom.select()}}}},{boxLabel:"Require visitors to be signed in.",xtype:"checkbox",name:"require_login",id:"require_login",value:"1",helpText:FR.T("Only registered users will be able to access this link.")}]}]});tabs.push({title:"Download Terms",bodyStyle:"padding:15px",autoScroll:true,items:[{xtype:"displayfield",value:FR.T("Force the visitors to accept your written terms before being able to download files.")},{xtype:"textarea",hideLabel:true,id:"dterms",height:82,width:"99%"}]});FR.UI.form=new Ext.FormPanel({layout:"fit",items:[{xtype:"tabpanel",ref:"tabPanel",activeTab:0,deferredRender:false,buttonAlign:"center",items:tabs,buttons:[{id:"saveBtn",text:"Save changes",cls:"fr-btn-primary",style:"margin-right:5px;",handler:function(){FR.SaveChanges()}},{text:"Cancel",handler:function(){FR.UI.form.tabPanel.setActiveTab(0);Ext.getCmp("cardPanel").getLayout().setActiveItem(0)}}]}]});var linklabel="&nbsp;";if(window.parent.FR.WebLinking.isFileRequest){linklabel="Give this link to people you’re requesting files from"}FR.linkTypeStore=new Ext.data.SimpleStore({fields:["val","label"],data:[["preview",FR.T("With preview")],["open",FR.T("Open in browser")],["download",FR.T("Force download")]]});FR.linkTypeFolderStore=new Ext.data.SimpleStore({fields:["val","label"],data:[["grid",FR.T("Grid view")],["list",FR.T("List view")],["gallery",FR.T("Image gallery")],["playlist",FR.T("Audio playlist")],["rss",FR.T("RSS feed")]]});var topTbar={xtype:"toolbar",style:"margin-top: 10px;",items:[{iconCls:"fa-cog",cls:"fr-btn-default",text:"Advanced",handler:function(){Ext.getCmp("cardPanel").getLayout().setActiveItem(1)}},"->",{id:"shareBtn",iconCls:"fa-share-alt",text:"Share link",menu:{items:[{text:"LinkedIn",handler:function(){window.open("https://www.linkedin.com/shareArticle?mini=true&url="+encodeURIComponent(Ext.getCmp("LinkURLField").getValue())+"&source="+encodeURIComponent(window.parent.Settings.title),"linkedin-share-dialog","width=570,height=430")}},{text:"Twitter",handler:function(){window.open("https://twitter.com/share?text="+encodeURIComponent(Ext.getCmp("LinkURLField").getValue()),"twitter-share-dialog","width=570,height=350")}},{text:"Facebook",handler:function(){window.open("https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(Ext.getCmp("LinkURLField").getValue()),"facebook-share-dialog","width=626,height=436")}},{text:"Gmail",hidden:!FR.userCanEmail,handler:function(){var url="http://mail.google.com/mail/?view=cm&fs=1&ui=1&body="+encodeURIComponent(Ext.getCmp("LinkURLField").getValue());window.open(url,"gmail-share-dialog","width=626,height=436")}},{xtype:"menuseparator",hidden:!FR.showQR},{id:"QRCBtn",hidden:!FR.showQR,text:"QR Code",iconCls:"fa-qrcode",handler:function(){FR.showQRCode(Ext.getCmp("LinkURLField").getValue())}},{xtype:"menuseparator",hidden:!FR.userCanEmail},{id:"emailBtn",hidden:!FR.userCanEmail,text:FR.useClientEmail?"E-mail program":"E-mail",iconCls:"fa-envelope-o",handler:function(){FR.emailLink()}}]}},{text:"Copy",iconCls:"fa-clipboard",handler:function(){FR.copyToClipboard()}}]};var bottomTbar={xtype:"toolbar",style:"margin-top: 10px;",items:[{id:"linkTypeOptFile",xtype:"combo",width:140,mode:"local",editable:false,hidden:true,displayField:"label",valueField:"val",value:"preview",triggerAction:"all",disableKeyFilter:true,store:FR.linkTypeStore,listeners:{select:function(combo,sel){FR.viewSettings.linkTypeOptFile=sel.data.val;FR.changeViewSettings();var allowsEditing=Ext.getCmp("allow_editing").getValue();if(sel.data.val=="edit"&&allowsEditing!=1){new Ext.ux.prompt({text:FR.T("The current settings of this link do not allow editing. Would you like to enable editing now?"),confirmHandler:function(){Ext.getCmp("allow_editing").setValue(true);FR.SaveChanges()},scope:this})}var allowsDownload=Ext.getCmp("allow_downloads").getValue();if((sel.data.val=="open"||sel.data.val=="download")&&allowsDownload!=1){new Ext.ux.prompt({text:FR.T("The current settings of this link do not allow downloading. Would you like to enable downloading now?"),confirmHandler:function(){Ext.getCmp("allow_downloads").setValue(true);FR.SaveChanges()},scope:this})}}}},{id:"linkTypeOpt",xtype:"combo",width:130,mode:"local",editable:false,hidden:true,displayField:"label",valueField:"val",value:FR.defaultMode,triggerAction:"all",disableKeyFilter:true,store:FR.linkTypeFolderStore,listeners:{select:function(combo,sel){FR.viewSettings.linkTypeOpt=sel.data.val;FR.changeViewSettings()}}},{id:"shortLinkToggle",iconCls:"fa-scissors",tooltip:"Shorten",enableToggle:true,style:"margin-left:5px",toggleHandler:function(item,pressed){if(pressed){if(!FR.WebLinkInfo.short_url){FR.getShort()}else{Ext.getCmp("LinkURLField").setValue(FR.WebLinkInfo.short_url)}}else{Ext.getCmp("LinkURLField").setValue(FR.WebLinkInfo.url)}Ext.getCmp("LinkURLField").getEl().highlight("dc143c",{attr:"border-color",easing:"easeIn",endColor:"C1C1C1",duration:1})}}]};FR.viewport=new Ext.Viewport({activeItem:0,id:"cardPanel",layout:"card",items:[{layout:"anchor",bodyStyle:"padding-top:30px;",tbar:topTbar,items:[{xtype:"component",autoEl:{html:'<div class="x-form-item x-form-empty-field" id="linkLabel">'+FR.T(linklabel)+"</div>"}},{xtype:"trigger",id:"LinkURLField",anchor:"100%",wrapClass:"weblinkField",triggerClass:"fa-external-link",triggerWidth:40,triggerToolTip:"Open",monitorTab:false,onTriggerClick:function(){window.open(Ext.getCmp("LinkURLField").getValue())},selectOnFocus:true,readOnly:true,listeners:{focus:function(){this.getEl().dom.select()}}},bottomTbar],buttons:[{cls:"fr-btn-primary",text:"Close",handler:function(){window.parent.FR.UI.popups.webLink.hide()}},"->",{id:"removeBtn",text:"Remove link",iconCls:"fa-remove colorDanger",handler:function(){var url=URLRoot+"/?module=weblinks&section=ajax&page=remove";FR.loadMask.show();Ext.Ajax.request({url:url,method:"post",params:{path:window.parent.FR.WebLinking.path},success:function(req){FR.loadMask.hide();try{var rs=Ext.util.JSON.decode(req.responseText)}catch(er){return false}if(rs.success){window.parent.FR.utils.applyFileUpdates(window.parent.FR.WebLinking.path,{weblink:0});window.parent.FR.UI.popups.webLink.hide();if(rs.msg){window.parent.FR.UI.feedback(rs.msg,"success")}}else{new Ext.ux.prompt({text:rs.msg})}}})}}]},FR.UI.form]});FR.SaveChanges=function(){FR.loadMask.show();FR.UI.form.getForm().submit({clientValidation:true,url:URLRoot+"/?module=weblinks&section=ajax&page=update",params:{path:window.parent.FR.WebLinking.path,download_terms:Ext.getCmp("dterms").getValue()},success:function(form,action){FR.loadMask.hide();FR.UI.form.tabPanel.setActiveTab(0);Ext.getCmp("cardPanel").getLayout().setActiveItem(0);var allow_uploads=Ext.getCmp("allow_uploads").getValue();var allow_downloads=Ext.getCmp("allow_downloads").getValue();Ext.getCmp("linkTypeOpt").setVisible(FR.WebLinkInfo.isdir&&(allow_uploads&&allow_downloads||!allow_uploads));window.parent.FR.UI.feedback(action.result.msg,"success")},failure:function(form,action){FR.loadMask.hide();switch(action.failureType){case Ext.form.Action.CLIENT_INVALID:new Ext.ux.prompt({text:FR.T("Please make the appropriate <br>changes to the highlighted fields.")});break;case Ext.form.Action.CONNECT_FAILURE:new Ext.ux.prompt({text:FR.T("Ajax communication failed.")});break;case Ext.form.Action.SERVER_INVALID:new Ext.ux.prompt({text:action.result.msg})}}})};FR.getInfo=function(){FR.loadMask.show();var url=URLRoot+"/?module=weblinks&section=ajax&page=load"+(FR.email?"&email=1":"");var pars={path:window.parent.FR.WebLinking.path};if(window.parent.FR.WebLinking.isFileRequest){pars.isFileRequest=1;window.parent.FR.WebLinking.isFileRequest=false}Ext.Ajax.request({url:url,method:"post",params:pars,success:function(req){FR.loadMask.hide();try{var rs=Ext.util.JSON.decode(req.responseText)}catch(er){}if(!rs||!rs.linkInfo){if(rs&&rs.msg){window.parent.FR.UI.feedback(rs.msg,"error");window.parent.FR.UI.popups.webLink.hide()}else{new Ext.ux.prompt({text:FR.T("Application error: Unexpected server response!")})}FR.UI.form.getForm().reset();Ext.getCmp("LinkURLField").setValue("");return false}FR.WebLinkInfo=rs.linkInfo;FR.WebLinkInfo.isdir=rs.isdir;var allow_downloads=Ext.getCmp("allow_downloads");var label=rs.isdir?"Allow visitors to download files from the folder.":"Allow visitors to download this file.";allow_downloads.setBoxLabel(FR.T(label)).setValue(rs.linkInfo.allow_downloads=="1");var allow_editing=Ext.getCmp("allow_editing");var label=rs.isdir?"Allow visitors to edit the files inside this folder.":"Allow visitors to edit this file.";allow_editing.setBoxLabel(FR.T(label)).setValue(rs.linkInfo.allow_editing=="1").setVisible(rs.editingAvailable);FR.toggleEditableOption(rs.editingAvailable);var allow_uploads=Ext.getCmp("allow_uploads");var label=rs.isdir?"Allow visitors to upload files in this folder.":"Allow visitors to upload new versions of this file.";allow_uploads.setBoxLabel(FR.T(label)).setValue(rs.linkInfo.allow_uploads=="1").setVisible(rs.uploadAvailable);Ext.getCmp("linkTypeOptFile").setValue("preview").setVisible(!rs.isdir);Ext.getCmp("require_login").setVisible(!rs.require_login);Ext.getCmp("download_limit").setVisible(!rs.isdir);Ext.getCmp("shortLinkToggle").toggle(rs.linkInfo&&rs.linkInfo.short_url,true).setVisible(!FR.disableShortURL);Ext.getCmp("expiry").setValue(rs.linkInfo.expiry2);Ext.getCmp("download_limit").setValue(rs.linkInfo.download_limit);Ext.getCmp("password").setValue(rs.linkInfo.password);var linkType=rs.isPhotoAlbum?"gallery":FR.defaultMode;Ext.getCmp("linkTypeOpt").setValue(linkType).setVisible(rs.isdir&&(rs.linkInfo.allow_uploads=="1"&&rs.linkInfo.allow_downloads=="1"||rs.linkInfo.allow_uploads=="0"));FR.viewSettings.linkTypeOpt=linkType;if(rs.linkInfo.short_url){Ext.getCmp("LinkURLField").setValue(rs.linkInfo.short_url)}else{if(linkType!=FR.defaultMode){FR.changeViewSettings()}else{Ext.getCmp("LinkURLField").setValue(rs.linkInfo.url)}}Ext.getCmp("dterms").setValue(rs.linkInfo.download_terms);if(rs.linkInfo.short_url){Ext.getCmp("shortLinkToggle").toggle(true,true)}Ext.getCmp("require_login").setValue(rs.linkInfo.require_login=="1");Ext.getCmp("show_comments").suspendEvents().setValue(rs.linkInfo.show_comments=="1").resumeEvents();Ext.getCmp("show_comments_names").setValue(rs.linkInfo.show_comments_names=="1");Ext.getCmp("show_comments_names").setVisible(rs.linkInfo.show_comments=="1");Ext.getCmp("show_metadata").setValue(rs.linkInfo.show_metadata=="1");Ext.getCmp("notify").setValue(rs.linkInfo.notify=="1");Ext.getCmp("cardPanel").getLayout().setActiveItem(0);with(window.parent){FR.utils.applyFileUpdates(FR.WebLinking.path,{weblink:1})}if(rs.linkInfo.allow_uploads==true){Ext.fly("linkLabel").update(FR.T("Give this link to people you’re requesting files from")+":")}else{Ext.fly("linkLabel").update("&nbsp;")}}})};FR.changeViewSettings=function(){var url=FR.WebLinkInfo.url;if(FR.WebLinkInfo.isdir){if(FR.viewSettings.linkTypeOpt){url+="&mode="+FR.viewSettings.linkTypeOpt}}else{if(FR.viewSettings.linkTypeOptFile!="preview"){url+="&fmode="+FR.viewSettings.linkTypeOptFile}}Ext.getCmp("LinkURLField").setValue(url);Ext.getCmp("LinkURLField").getEl().highlight("cffac5",{attr:"background-color",easing:"easeIn",endColor:"f1f3f4",duration:1})};FR.update=function(){if(FR.QRWindow){FR.QRWindow.hide()}this.getInfo()};FR.toggleEditableOption=function(editingAvailable){FR.linkTypeStore.removeAt(3);if(editingAvailable){FR.linkTypeStore.add([new Ext.data.Record({val:"edit",label:FR.T("Editable")})])}};FR.getShort=function(){var url=Ext.getCmp("LinkURLField").getValue();Ext.getCmp("LinkURLField").setValue(FR.T("Loading..."));Ext.Ajax.request({url:URLRoot+"/?module=weblinks&section=ajax&page=get_short",method:"post",params:{linkId:FR.WebLinkInfo.id,url:url},success:function(req){try{var rs=Ext.util.JSON.decode(req.responseText)}catch(er){return false}if(rs.success){FR.WebLinkInfo.short_url=rs.url;Ext.getCmp("LinkURLField").setValue(rs.url)}else{Ext.getCmp("LinkURLField").setValue(rs.error)}}})};FR.emailLink=function(){if(FR.useClientEmail){window.open("mailto:?body="+Ext.getCmp("LinkURLField").getValue())}else{window.parent.FR.actions.EmailFromLink()}};FR.showQRCode=function(URL){FR.QRWindow=new window.parent.Ext.Window({title:FR.T("QR Code"),draggable:false,layout:"border",width:290,height:290,modal:true,items:[{region:"north",bodyStyle:"padding-top:10px;text-align:center;",height:55,html:FR.T("Scan this QR code with your mobile device.")},{region:"center",html:'<div style="text-align:center;"><div style="display:inline-block;background-image:url(images/loading.svg);background-position: center center;background-repeat:no-repeat;width:148px;height:148px;" id="qrwrap"><img src="'+URLRoot+"/?module=fileman&section=utils&page=qrcode&data="+encodeURIComponent(URL)+'" width="148" height="148" border="0" alt="" /></div></div>'}]});FR.QRWindow.show()};FR.copyToClipboard=function(){Ext.getCmp("LinkURLField").focus();try{if(document.execCommand("copy")){window.parent.FR.UI.feedback(FR.T("The link has been copied to clipboard."))}}catch(err){}};FR.loadMask=new Ext.LoadMask(Ext.getCmp("cardPanel").el,{msg:window.parent.FR.T("Loading...")});FR.getInfo()});