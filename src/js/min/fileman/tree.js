FR.initTree=function(){FR.UI.tree.defaultLoader=new FR.components.TreeLoader({dataUrl:FR.getBaseURL+"&page=tree",applyLoader:true});FR.components.AsyncTreeNode=Ext.extend(Ext.tree.AsyncTreeNode,{defaultUI:FR.components.TreeNodeCustomUI,expand:function(deep,anim,callback,scope){this.ui.removeClass("offline");FR.components.AsyncTreeNode.superclass.expand.call(this,deep,anim,callback,scope)},expandStatic:function(deep,anim,callback,scope){Ext.tree.AsyncTreeNode.superclass.expand.call(this,deep,anim,callback,scope)}});FR.components.TreeNode=Ext.extend(Ext.tree.TreeNode,{defaultUI:FR.components.TreeNodeCustomUI});FR.components.RegularAsyncFolder=Ext.extend(FR.components.AsyncTreeNode,{loader:FR.UI.tree.defaultLoader});Ext.tree.TreePanel.nodeTypes.filerunFolder=FR.components.RegularAsyncFolder;Ext.tree.TreePanel.nodeTypes.filerunAsync=FR.components.AsyncTreeNode;Ext.tree.TreePanel.nodeTypes.simpleNode=FR.components.TreeNode;var t=new Ext.tree.TreePanel({id:"FR-Tree-Panel",region:"center",margins:Settings.layout.tree&&Settings.layout.tree.margins?Settings.layout.tree.margins:"0 3 0 0",enableDrop:!User.perms.read_only,ddGroup:"TreeDD",dropConfig:{containerScroll:true},animate:true,autoScroll:true,rootVisible:false,listeners:{afterrender:function(){if(!User.perms.read_only){this.dropZone.addToGroup("tagging")}if(User.perms.upload){FlowUtils.DropZoneManager.add({domNode:this.el.dom,overClass:"dragged-over",findTarget:function(e){var el=Ext.get(e.target);if(el&&!el.hasClass("x-tree-node-el")){el=el.parent("div.x-tree-node-el")}if(!el){return false}var treeNodeId=el.getAttribute("tree-node-id","ext");if(!treeNodeId){return false}var treeNode=FR.UI.tree.panel.getNodeById(treeNodeId);if(!treeNode){return false}if(["myfiles","sharedFolder"].indexOf(treeNode.attributes.section)!=-1){var perms=FR.getTargetPerms(treeNode.attributes.perms);if(perms.upload){return{el:el.dom,node:treeNode}}}},onDrop:function(e,target){FR.UI.showUploadWindow({targetPath:target.node.getPath("pathname"),dropEvent:e})},scope:FR})}if(User.perms.alter){this.on("nodedragover",function(e){var dropped=FR.Context.getTarget("tree",e.target);if(e.source.ddGroup=="tagging"){if(dropped.checkRequirement("isFileOrFolder")){return true}e.cancel=true}else{var dragged=FR.UI.gridPanel.target;if(dropped.checkRequirement("isFolder")){if(dragged.checkRequirement("isFileOrFolder")){if(dropped.checkRequirement("upload")){return true}e.cancel=true}}else if(dropped.checkRequirement("isCollection")){if(dragged.checkRequirement("isNotVirtual")){return true}e.cancel=true}else if(dropped.checkRequirement({sections:["starred"]})){if(dragged.checkRequirement("isFileOrFolder")){return true}e.cancel=true}}return false});this.on("beforenodedrop",function(e){var p=e.target.getPath("pathname");if(e.source.ddGroup=="tagging"){FR.actions.processMetadata({url:"/?module=metadata&section=tags&page=add",params:{"paths[]":p,"tags[]":[e.data.tagValue]}});return true}else{var s=e.target.attributes.section;if(s=="collection"){FR.actions.addToCollection({"paths[]":FR.UI.gridPanel.getSelectedAttrs("path"),targetPath:p})}else if(s=="starred"){FR.actions.star(FR.UI.gridPanel.target,"add");return true}else{FR.actions.move(e,p);return true}}return false})}},load:function(node){if(FR.UI.tree.currentSelectedNode&&!FR.UI.tree.currentSelectedNode.ownerTree){node.select()}}}});t.getSelectionModel().on("beforeselect",function(selectionModel,treeNode){if(treeNode.attributes.pathname===false){return false}});var r=new Ext.tree.TreeNode({pathname:"ROOT"}),loader,node,asyncNode=FR.components.AsyncTreeNode,tNode=FR.components.TreeNode;if(Settings.has_home_folder){FR.UI.tree.homeFolderNode=r.appendChild(new FR.components.RegularAsyncFolder({text:FR.T("My Files"),pathname:"HOME",section:"myfiles",homefolder:true,pid:FR.homeFolderCfg.pid,perms:"user",allowDrag:false,allowDrop:!User.perms.read_only,custom:FR.homeFolderCfg.customAttr}))}if(Settings.has_home_folder){if(Settings.media_folders_photos){node=r.appendChild(new tNode({text:FR.T("Photos"),pathname:"Photos",section:"photos",allowDrag:false,iconCls:"fa-folder-image",viewMode:"photos",remoteSort:true,objectType:"virtual"}));loader=new FR.components.TreeLoader({dataUrl:FR.baseURL+"/?module=collections&page=tree&type=album"});FR.UI.tree.photoAlbumsNode=node.appendChild(new asyncNode({text:FR.T("Albums"),pathname:"Albums",allowDrag:false,section:"albums",viewMode:"thumbnails",iconCls:"fa-images",remoteSort:true,loader:loader,objectType:"virtual"}));node.appendChild(new tNode({text:FR.T("Last uploaded"),section:"photos",allowDrag:false,allowDrop:false,leaf:true,perms:{alter:true,download:true,share:true},pathname:"LatestUploads",viewMode:"photos",remoteSort:true,objectType:"virtual"}));loader=new FR.components.TreeLoader({dataUrl:FR.baseURL+"/?module=photos&page=tree",applyLoader:true});node.appendChild(new asyncNode({text:FR.T("By date"),pathname:"Date",allowDrag:false,allowDrop:false,viewMode:"photos",remoteSort:true,section:"photos",loader:loader,autoExpand:false,objectType:"virtual"}));node.appendChild(new asyncNode({text:FR.T("By tag"),pathname:"Tags",allowDrag:false,allowDrop:false,readonly:true,viewMode:"photos",remoteSort:true,section:"photos",loader:loader,autoExpand:false,objectType:"virtual"}));node.appendChild(new tNode({text:FR.T("Videos"),section:"videos",iconCls:"fa-play-circle",allowDrag:false,allowDrop:false,leaf:true,perms:{alter:true,download:true,share:true},pathname:"Videos",viewMode:"photos",remoteSort:true,objectType:"virtual"}))}if(Settings.media_folders_videos){node=r.appendChild(new tNode({text:FR.T("Videos"),iconCls:"fa-play-circle",pathname:"Videos",viewMode:"photos",section:"videos",allowDrag:false,allowDrop:false,remoteSort:true,perms:{alter:true,download:true,share:true},objectType:"virtual"}));node.appendChild(new tNode({text:FR.T("Last uploaded"),leaf:true,perms:{alter:true,download:true,share:true},pathname:"LatestUploads",viewMode:"photos",remoteSort:true,section:"videos",objectType:"virtual"}));loader=new FR.components.TreeLoader({dataUrl:FR.baseURL+"/?module=videos&page=tree",applyLoader:true});node.appendChild(new asyncNode({text:FR.T("By date"),pathname:"Date",allowDrag:false,allowDrop:false,viewMode:"photos",remoteSort:true,loader:loader,autoExpand:false,objectType:"virtual",section:"videos"}));node.appendChild(new asyncNode({text:FR.T("By tag"),pathname:"Tags",allowDrag:false,allowDrop:false,readonly:true,viewMode:"photos",section:"videos",remoteSort:true,loader:loader,autoExpand:false,objectType:"virtual"}))}if(Settings.media_folders_music){node=r.appendChild(new tNode({text:FR.T("Music"),iconCls:"fa-folder-music",allowDrag:false,allowDrop:false,pathname:"Music",viewMode:"list",section:"music",remoteSort:true,perms:{alter:true,download:true,share:true},objectType:"virtual"}));loader=new FR.components.TreeLoader({dataUrl:FR.baseURL+"/?module=music&page=tree",baseAttrs:{nodeType:"filerunAsync",allowDrag:false}});node.appendChild(new asyncNode({text:FR.T("By artist"),pathname:"Artists",viewMode:FR.UI.layout.isSmall?"list":"thumbnails",allowDrag:false,allowDrop:false,readonly:true,loader:loader,autoExpand:false,objectType:"virtual",section:"music"}));node.appendChild(new asyncNode({text:FR.T("By album"),pathname:"Albums",viewMode:FR.UI.layout.isSmall?"list":"thumbnails",allowDrag:false,allowDrop:false,readonly:true,loader:loader,autoExpand:false,objectType:"virtual",section:"music"}));node.appendChild(new tNode({text:FR.T("Random"),leaf:true,pathname:"Random",allowDrag:false,allowDrop:false,viewMode:"list",remoteSort:true,perms:{alter:true,download:true,share:true},objectType:"virtual",section:"music"}))}}loader=new FR.components.TreeLoader({dataUrl:FR.getBaseURL+"&page=tree"});Ext.each(AnonShares,function(fld){r.appendChild(new asyncNode(Ext.apply(fld,{readonly:true,allowDrag:false,allowDrop:fld.perms.upload,loader:loader,section:"sharedFolder"})))});Ext.each(Sharing,function(usr){r.appendChild(new asyncNode({text:usr.name,pathname:usr.id,section:"userWithShares",uid:usr.id,iconCls:"basicAvatar",allowDrag:false,allowDrop:false,loader:loader,objectType:"virtual"}))});if(Settings.ui_enable_collections&&User.perms.download){loader=new FR.components.TreeLoader({dataUrl:FR.baseURL+"/?module=collections&page=tree"});FR.UI.tree.collectionsNode=r.appendChild(new FR.components.AsyncTreeNode({text:FR.T("Collections"),pathname:"Collections",iconCls:"fa-clone",allowDrag:false,section:"collections",loader:loader,objectType:"virtual"}))}r.appendChild(new tNode({text:FR.T("Recent"),remoteSort:true,hidden:!User.perms.file_history,iconCls:"fa-clock-o",pathname:"RECENT",section:"recent",allowDrag:false,objectType:"virtual"}));r.appendChild(new tNode({text:FR.T("Starred"),hidden:User.perms.read_only||!User.perms.download,allowDrag:false,iconCls:"fa-star",pathname:"STARRED",section:"starred",objectType:"virtual"}));r.appendChild(new tNode({text:FR.T("Shared by me"),hidden:!User.perms.share||!Settings.has_home_folder,allowDrag:false,allowDrop:false,iconCls:"fa-user-plus",pathname:"SHARES",section:"shares",objectType:"virtual"}));r.appendChild(new tNode({text:FR.T("Shared links"),hidden:!User.perms.download||!User.perms.weblink,allowDrag:false,iconCls:"fa-link",pathname:"WLINKED",section:"webLinked",objectType:"virtual",perms:{}}));FR.UI.tree.trashNode=r.appendChild(new tNode({text:FR.T("Trash"),iconCls:"fa-trash",hidden:User.perms.read_only,remoteSort:true,allowDrag:false,pathname:"TRASH",section:"trash",viewMode:"list",objectType:"trash",perms:{alter:User.perms.alter,read_comments:User.perms.read_comments}}));t.getSelectionModel().on("selectionchange",function(sm,node){this.currentSelectedNode=node;if(!node){return false}var a=node.attributes;var p=a.perms;var s=a.section;FR.currentFolderPerms=FR.getTargetPerms(p);FR.previousSection=Ext.value(FR.currentSection);FR.currentSection=s;FR.currentPath=node.getPath("pathname");FR.UI.tree.setCurrentFolderName(node.text);var gridPanel=FR.UI.gridPanel;var gridView=gridPanel.view;var ua=FR.UI.actions;FR.currentFolderHasSearch=false;ua.refresh.show();ua.gridOptions.show();if(["myfiles","sharedFolder"].indexOf(s)!=-1){FR.currentFolderHasSearch=true}if(!FR.currentFolderHasSearch){if(gridView.searchMode){FR.UI.searchPanel.close()}}if(gridView.searchMode&&FR.currentFolderHasSearch){FR.UI.searchPanel.push2History()}else{FR.push2History(FR.currentPath)}gridView.setViewMode(a.viewMode);gridPanel.reset();var remoteSort=a.remoteSort||false;gridPanel.store.remoteSort=remoteSort;gridPanel.store.enableFolderGrouping=remoteSort?false:!FR.UI.actions.disableFolderGrouping.checked;gridPanel.load(FR.currentPath);if(!Ext.isDefined(a.autoExpand)||a.autoExpand){if(FR.UI.layout.treePanel.float){FR.UI.colapseTree()}else{if(!FR.UI.window.layout.west.isCollapsed){node.expand()}}}},FR.UI.tree);t.on("contextmenu",FR.UI.tree.showContextMenu);t.setRootNode(r);FR.UI.tree.panel=t};FR.UI.tree.setCurrentFolderName=function(name){FR.UI.currentFolderTitle=name;FR.UI.title=name;document.title=name+" - "+Settings.title;if(!FR.UI.hasLogo){Ext.getCmp("FR-Tree-Region").setTitle(FR.UI.currentFolderTitle)}FR.UI.gridBreadcrumbs.build(this.currentSelectedNode);var info=FR.UI.infoPanel;if(info.fileInfo){info.fileInfo.filename=name;info.updateTitle()}};FR.UI.tree.offlineNode=function(params,parentNode){var fromParent=Ext.copyTo({},parentNode.attributes,["perms","section","readonly","allowDrag","allowDrop","autoExpand","loader","viewMode","objectType"]);params=Ext.apply(fromParent,params,{pathname:params.text,nodeType:"filerunAsync"});params.cls="offline";if(parentNode.expandStatic){parentNode.expandStatic(false,false);if(!parentNode.loaded){parentNode.ui.addClass("offline")}}else{parentNode.expand(false,false)}var treeNode=parentNode.findChild("pathname",params.pathname);if(!treeNode){treeNode=parentNode.appendChild(params)}return treeNode};FR.UI.tree.layPath=function(path,callback){var folders=path.split("/");folders.shift();folders.shift();var curNode=this.panel.root,index=0,subFolderName;while(curNode){subFolderName=folders[index];if(subFolderName){curNode=FR.UI.tree.offlineNode({text:subFolderName},curNode)}else{if(callback){callback(true,curNode)}break}index++}};FR.UI.tree.reloadNode=function(node,callback){node.reload(callback)};FR.UI.tree.updateIcon=function(treeNode){treeNode.getUI().updateIcons()};FR.UI.tree.showContextMenu=function(node,e,alignTo){FR.UI.contextMenu.event({location:"tree",target:node,alignTo:alignTo});if(e){e.stopEvent()}return false};FR.components.TreeNode=Ext.extend(Ext.tree.TreeNode,{readonly:true,defaultUI:FR.components.TreeNodeCustomUI,leaf:false,allowDrag:false,allowDrop:false,constructor:function(config){Ext.apply(config,{listeners:{append:function(t,thisNode,childNode){if(thisNode.attributes.section&&!childNode.attributes.section){childNode.attributes.section=thisNode.attributes.section}}}});FR.components.TreeNode.superclass.constructor.call(this,config)}});FR.components.TreeLoader=Ext.extend(Ext.tree.TreeLoader,{baseAttrs:{nodeType:"filerunFolder",allowDrag:false},nodeParameter:null,root:"items",listeners:{beforeload:function(loader,node){loader.baseAttrs.section=node.attributes.section;loader.baseParams.path=node.getPath("pathname")}}});