FR.UI.refreshQuotaUsage=function(){if(!FR.utils.hasQuota()){return false}FR.UI.quotaIndicator.setText("Calculating usage").setIconClass("fa-spin fa-refresh").disable();Ext.Ajax.request({url:FR.baseURL+"/?module=fileman&section=utils&page=status_bar",success:function(req){FR.UI.quotaIndicator.enable();try{var rs=Ext.util.JSON.decode(req.responseText)}catch(er){return false}if(rs){User.perms=Ext.apply(User.perms,rs);var used=User.perms.space_quota_percent_used;var text;var available=FR.T("%1 available").replace("%1",User.perms.space_quota_free);if(used==0){text=available}else{if(used>=98){used='<span style="color:red">'+used+"</span>"}else if(used>90){used='<span style="color:orange">'+used+"</span>"}else if(used<90){used='<span style="color:green">'+used+"</span>"}text=FR.T("%1 used, %2%").replace("%1",User.perms.space_quota_used).replace("%2",used)}FR.UI.quotaIndicator.setText(text).setIconClass("fa-database")}}})};FR.UI.fileTypeIsPhoto=function(filetype){return["img","img2","raw"].indexOf(filetype)!=-1};FR.UI.fileTypeIsVideo=function(filetype){return["wvideo","video"].indexOf(filetype)!=-1};FR.UI.fileTypeIsMedia=function(filetype){return this.fileTypeIsPhoto(filetype)||this.fileTypeIsVideo(filetype)};FR.UI.feedback=function(text,type){if(!text){return false}if(Ext.util.Format.stripTags(text).length>100){new Ext.Window({title:type=="error"?"Problems":null,modal:true,width:350,height:160,layout:"fit",items:{bodyStyle:"padding:5px",html:text,autoScroll:true}}).show();return false}var delay=Math.max(text.length/15,2);if(!FR.UI.feedbackCt){FR.UI.feedbackCt=Ext.DomHelper.append(document.body,{style:"position:absolute;width:300px;z-index:9999999;"},true)}var m=Ext.DomHelper.append(FR.UI.feedbackCt,{html:'<div class="fr-feedback-msg '+(type||"")+'">'+text+"</div>"},true);FR.UI.feedbackCt.alignTo(Ext.getBody(),"b-b");m.on("click",function(e,node){node.remove()});m.slideIn("b").pause(delay).ghost("b",{remove:true})};FR.UI.popupCount=0;FR.UI.popup=function(args){var id;if(args.id){id=args.id}else{args.autoDestroy=true;id="popups_"+ ++this.popupCount}var frameId=id+"-iframe";if(!args.noId){args.src+="&_popup_id="+id}var w=args.width;var h=args.height;args.draggable=true;if(!w||!h){args.maximized=true}if(args.maximized){args.cls="x-window-full"}if(FR.UI.layout.isPhone){args.maximized=true}if(args.maximized){args.resizable=false;args.draggable=false}var options={id:id,stateful:false,autoDestroy:args.autoDestroy,closeAction:args.autoDestroy?"close":"hide",layout:"fit",width:w,height:h,title:args.title||false,tools:args.tools||false,resizable:args.resizable||false,collapsible:args.collapsible||false,maximizable:args.maximizable||false,maximized:args.maximized||false,draggable:args.draggable,cls:args.cls||false,closable:typeof args.closable=="undefined"?true:args.closable,plain:false,modal:args.modal!==false,html:'<iframe src="'+(args.post?"about:blank":args.src)+'" style="width:100%;height:100%;position:relative" marginheight="0" marginwidth="0" frameborder="0" id="'+frameId+'" name="'+id+'" allowfullscreen></iframe>'};var dialog=new Ext.Window(options);dialog.frameId=frameId;args.centerTo=args.centerTo||false;dialog.show(args.centerTo);dialog.iframe=Ext.get(frameId);if(args.align){dialog.alignTo(args.align.el,args.align.pos,args.align.offset)}dialog.body.mask(args.loadingMsg||"Loading...");dialog.iframe.on("load",function(){dialog.body.unmask()});dialog.on("beforeshow",function(){this.iframe.dom.style.display="block"});dialog.on("beforehide",function(){this.iframe.dom.style.display="none";FR.UI.gridPanel.view.focusEl.focus()});FR.UI.popups[id]=dialog;if(args.autoDestroy){dialog.on("afterhide",function(dlg){dlg.destroy(true);delete FR.UI.popups[dlg.id]})}if(args.post){FR.UI.postToTarget(args,id)}return dialog};FR.UI.openInPopup=function(args){var id="fr-tabs-"+Ext.id();var frameId=id+"-frame";args.src=args.src+"&_tab_id="+id;var dualScreenLeft=window.screenLeft!=undefined?window.screenLeft:screen.left;var dualScreenTop=window.screenTop!=undefined?window.screenTop:screen.top;var width=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width;var height=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height;var w=Math.round(width-15/100*width);var h=Math.round(height-15/100*height);var left=width/2-w/2+dualScreenLeft;var top=height/2-h/2+dualScreenTop;var win=window.open(args.src,frameId,"scrollbars=yes, width="+w+", height="+h+", top="+top+", left="+left);if(args.post){FR.UI.postToTarget(args,frameId)}return win};FR.UI.backgroundPost=function(path,url){if(!path){path=FR.UI.gridPanel.target.getPath()}var args={src:url,post:[{name:"path",value:path}]};FR.UI.postToTarget(args,FR.UI.createDisposableIFrame())};FR.UI.createDisposableIFrame=function(){var ifr=document.createElement("IFRAME");var iframeName="hidden-iframe-"+Ext.id();ifr.setAttribute("name",iframeName);ifr.setAttribute("style","width:0px;height:0px;position:absolute;top:-100px;left:-100px;");Ext.get("theBODY").appendChild(ifr);Ext.get(ifr).on("load",function(){Ext.get(ifr).remove()});return iframeName};FR.UI.postToTarget=function(args,target){var frm=document.createElement("FORM");frm.action=args.src;frm.method="POST";frm.target=target||"_blank";Ext.each(args.post,function(param){var inpt=document.createElement("INPUT");inpt.type="hidden";inpt.name=param.name;inpt.value=param.value;frm.appendChild(inpt)});Ext.get("theBODY").appendChild(frm);frm.submit();Ext.get(frm).remove()};FR.UI.showUploadWindow=function(opts){if(!FR.UI.uploadWindow){var bsize=Ext.getBody().getSize();var height=Ext.min([Math.floor(bsize.height-20/100*bsize.height),344]);var width=Ext.min([bsize.width,750]);FR.UI.uploadWindow=new FR.components.uploadWindow({width:width,height:height,listeners:{hide:function(){FR.UI.gridPanel.view.focusEl.focus()}}})}var query={path:opts.targetPath};if(opts.files){FR.UI.uploadWindow.flow.addFiles(opts.files,false,query)}else{if(opts.dropEvent){FR.UI.uploadWindow.flow.onDrop(opts.dropEvent,query)}else{FR.UI.uploadWindow.flow.browseFiles({entireFolder:opts.folder,query:query})}}};FR.UI.persistentWindow=function(args){var win=FR.UI.popups[args.id];args.persistent=true;if(!win){FR.UI.popup(args)}else{win.setTitle(args.title);win.show();if(args.align){win.alignTo(args.align.el,args.align.pos,args.align.offset)}else{win.center()}Ext.get(win.frameId).dom.contentWindow.FR.update(args)}};FR.UI.showLoading=function(msg,onlyTreePane){if(onlyTreePane){this.tree.panel.el.mask(msg)}else{Ext.getBody().mask(msg,"fr-absolute-mask-msg","fr-absolute-mask")}};FR.UI.doneLoading=function(){this.tree.panel.el.unmask();this.window.getEl().unmask()};FR.UI.getTextLogo=function(text){return text};FR.UI.getImageLogo=function(URL){return'<div class="logoContainer" style="background-image:url('+URL+')"></div>'};FR.UI.styleFileName=function(text){return'<span class="filename-in-context">'+text+"</span>"};FR.UI.getThumbURL=function(itemData){var path=itemData.path;var url=FR.baseURL+"/t.php?p="+FR.utils.encodeURIComponent(path);if(itemData.filesize){url+="&s="+itemData.filesize}if(itemData.modified){var timestamp=new Date(itemData.modified).getTime()/1e3;url+="&t="+timestamp}if(itemData.extra){url+="&"+itemData.extra}return url};FR.UI.preloadImage=function(src,callback,scope,remove){var img=document.createElement("img");img.onload=function(){callback.createDelegate(scope,[true,this,src])();if(remove){this.remove()}};img.onerror=function(){callback.createDelegate(scope,[false,this,src])();if(remove){this.remove()}};img.src=src;return img};FR.UI.cancelPreloadImage=function(dom){if(dom){dom.src="";dom.remove()}};FR.UI.copyToClipboard=function(text,feedback){if(!text.length){return false}var t=Ext.getBody().createChild({tag:"textarea"});t.dom.innerText=text;t.dom.select();try{if(document.execCommand("copy")){if(feedback){FR.UI.feedback(feedback)}}}catch(err){}t.remove()};FR.UI.bestBgFit=function(opts){var w=opts.img.width;var h=opts.img.height;var cW=opts.container.getWidth();var cH=opts.container.getHeight();var size=opts.style;if(opts.style=="contain"){if(w>=cW||h>=cH){var widthRatio=w/cW;var heightRatio=h/cH;if(widthRatio>heightRatio){var shrinkedW=w/widthRatio;var shrinkedH=h/widthRatio}else{var shrinkedW=w/heightRatio;var shrinkedH=h/heightRatio}var percentW=shrinkedW/cW*100;var percentH=shrinkedH/cH*100;var stretchThreshold=85;if(percentW>stretchThreshold&&percentH>stretchThreshold){size="cover"}}else{if(w<cW&&h<cH){var percentW=w/cW*100;var percentH=h/cH*100;var stretchThreshold=opts.stretchThreshold||85;if(percentW<stretchThreshold&&percentH<stretchThreshold){size="auto"}else{var widthRatio=cW/w;var heightRatio=cH/h;if(widthRatio<heightRatio){var stretchedW=w*widthRatio;var stretchedH=h*widthRatio}else{var stretchedW=w*heightRatio;var stretchedH=h*heightRatio}var percentW=stretchedW/cW*100;var percentH=stretchedH/cH*100;if(stretchedW<=cW&&stretchedH<=cH){var percentW=stretchedW/cW*100;var percentH=stretchedH/cH*100;var stretchThreshold=85;if(percentW>stretchThreshold&&percentH>stretchThreshold){size="cover"}}}}else{var containerRatio=cW/cH;var stretchedW=w*containerRatio;var stretchedH=h*containerRatio;if(stretchedW<=cW&&stretchedH<=cH){var percentW=stretchedW/cW*100;var percentH=stretchedH/cH*100;var stretchThreshold=85;if(percentW>stretchThreshold&&percentH>stretchThreshold){size="cover"}}}}}else{if(w<cW||h<cH){var percentW=w/cW*100;var percentH=h/cH*100;var stretchThreshold=50;if(percentW<=stretchThreshold||percentH<=stretchThreshold){size="auto"}}}var style={"background-image":"url('"+opts.img.src+"')","background-size":size};if(size=="cover"&&opts.coverAlign&&opts.coverAlign!="center"){style["background-position"]=opts.coverAlign}return style};FR.UI.bestImgSizeToFitFixed=function(imgW,imgH,cW,cH,padding){var w=cW;var h=cH;if(imgW<cW&&imgH<cH){w=imgW;h=imgH}else{var imageAspectRatio=imgW/imgH;var targetAspectRatio=cW/cH;if(imageAspectRatio>targetAspectRatio){h=Math.round(cW/imageAspectRatio)}else if(imageAspectRatio<targetAspectRatio){w=Math.round(cH*imageAspectRatio)}}if(padding){w-=padding;h-=padding}return{width:w+"px",height:h+"px"}};FR.UI.setImageToContainer=function(opts){var style;if(opts.fixed){style={"background-image":"url('"+opts.img.src+"')"};if(opts.style){style["background-size"]=opts.style}else{var rs=FR.UI.bestImgSizeToFitFixed(opts.img.width,opts.img.height,opts.container.getWidth(),opts.container.getHeight(),opts.padding);style["background-size"]=rs.width+" "+rs.height}}else{style=FR.UI.bestBgFit(opts)}if(opts.destroyImg){opts.img.remove()}opts.container.setStyle(style)};FR.UI.insertImageToContainer=function(opts){var s=FR.UI.bestImgSizeToFitFixed(opts.img.width,opts.img.height,opts.container.getWidth(),opts.container.getHeight(),opts.padding);opts.img.style.width=s.width;opts.img.style.height=s.height;if(opts.clearContainer){opts.container.dom.innerHTML=""}opts.container.dom.append(opts.img)};FR.UI.calculateSelectionSize=function(link,currentFolder){var paths;if(currentFolder){paths=[FR.currentPath]}else{var paths=FR.UI.gridPanel.getSelectedAttrs("path");if(paths.length==0){paths=[];FR.UI.gridPanel.store.each(function(row){paths.push(row.data["path"])})}}Ext.fly(link).parent().load({url:FR.getBaseURL+"&page=filesize",method:"post",params:{"paths[]":paths}})};FR.UI.slideRegionIn=function(region){FR.UI.window.layout[region].slideIn()};FR.UI.slideRegionOut=function(region){FR.UI.window.layout[region].slideOut()};FR.UI.expandInfo=function(region){if(FR.UI.layout.infoPanel.float){FR.UI.slideRegionOut("east")}else{FR.UI.infoPanel.expand()}};FR.UI.collapseInfo=function(region){var r=FR.UI.infoPanel;if(r.isSlid){FR.UI.slideRegionIn("east")}else{r.collapse()}};FR.UI.expandTree=function(region){if(FR.UI.layout.treePanel.float){FR.UI.slideRegionOut("west")}else{Ext.getCmp("FR-Tree-Region").expand()}};FR.UI.colapseTree=function(){var r=Ext.getCmp("FR-Tree-Region");if(r.isSlid){FR.UI.slideRegionIn("west")}else{r.collapse()}};FR.UI.showTagsHelp=function(){var text;if(Ext.isPhone){text=FR.T("Tap a tag for options")}else{text=FR.T("Click a tag to search files by it.")+"<br>"+FR.T("Right-click a tag for options.")+"<br>"+FR.T("Drag a tag over a file or a folder to add it to it.")+"<br>"}new Ext.ux.prompt({text:text})};FR.UI.getInfoPanelById=function(id){return id=="ImageViewerInfoPanel"?FR.UI.ImageViewer.infoPanel:FR.UI.infoPanel};FR.UI.calculateLayout=function(){var canvasSize=Ext.getBody().getViewSize();var bodyWidth=canvasSize.width;var bodyHeight=canvasSize.height;var rs={bodyWidth:bodyWidth,isSmall:bodyWidth<=640,isMedium:bodyWidth>640&&bodyWidth<1007,isLarge:bodyWidth>=1007,isVeryLarge:bodyWidth>=1366,isShort:bodyHeight<=450,treePanel:{minWidth:250,floatMinWidth:350},infoPanel:{minWidth:300,floatMinWidth:350},viewerInfoPanel:{minWidth:300,floatMinWidth:350}};rs.isPhone=rs.isSmall||rs.isShort;rs.northBarsHeight=70;rs.treePanel.float=rs.isSmall;if(rs.treePanel.float){rs.treePanel.width=Math.min(rs.treePanel.floatMinWidth,bodyWidth)}else{rs.treePanel.width=Math.min(Math.max(Math.round(21/100*bodyWidth),rs.treePanel.minWidth),rs.treePanel.minWidth)}var minGridWidth=400;rs.infoPanel.float=rs.isSmall||rs.isMedium||bodyWidth<rs.treePanel.width+rs.infoPanel.minWidth+minGridWidth;if(rs.infoPanel.float){rs.infoPanel.width=Math.min(rs.infoPanel.floatMinWidth,bodyWidth);rs.infoPanel.collapsed=true}else{rs.infoPanel.width=Math.min(Math.max(Math.round(24/100*bodyWidth),rs.infoPanel.minWidth),rs.infoPanel.minWidth)}var minViewerWidth=400;rs.viewerInfoPanel.float=rs.isSmall||bodyWidth<rs.viewerInfoPanel.minWidth+minViewerWidth;if(rs.viewerInfoPanel.float){rs.viewerInfoPanel.width=Math.min(rs.viewerInfoPanel.floatMinWidth,bodyWidth);rs.viewerInfoPanel.collapsed=true}else{rs.viewerInfoPanel.width=Math.min(Math.max(Math.round(24/100*bodyWidth),rs.viewerInfoPanel.minWidth),rs.viewerInfoPanel.minWidth)}rs.gridPanel={availableWidth:rs.bodyWidth};if(!rs.treePanel.float){rs.gridPanel.availableWidth-=rs.treePanel.width}if(!rs.viewerInfoPanel.float){rs.gridPanel.availableWidth-=rs.viewerInfoPanel.width}this.layout=rs};FR.UI.getLabelMenuItems=function(handler){var items=[{text:"No label",iconCls:"fa-none",handler:handler.createDelegate(false,["",false])}];FR.labels.each(function(label){items.push({style:"color:"+label.color,text:label.text,iconCls:"far fa-tag",cls:"fr-label",labelInfo:label,handler:handler.createDelegate(false,[label.text+"|"+label.color,label])})});items.push("-");items.push({text:"Custom label",iconCls:"fa-pen",handler:function(){return false},menu:{xtype:"colormenu",handler:function(target,color){new Ext.ux.prompt({title:"Custom label",text:"Please type the label's text",defaultValue:FR.T("New label"),confirmHandler:function(text){handler(text+"|#"+color,{text:text,color:"#"+color})}})}}});return items};