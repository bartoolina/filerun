FR.initToolbar=function(){FR.UI.cartWindow=new Ext.Window({title:"Download cart",layout:"fit",modal:true,maximized:Ext.isPhone,closeOnModalMaskClick:true,items:[FR.UI.cart=new FR.components.cartPanel({width:Math.min(400,FR.UI.layout.bodyWidth-30),height:300})]});FR.UI.searchPanel=new FR.components.SearchPanel({id:"FR-SearchPanel",width:Math.min(500,FR.UI.layout.bodyWidth-30)});FR.UI.actions={openTree:new FR.ContextAction({iconCls:"fa-sidebar",cls:"fr-btn-tree-toggle",tooltip:"Show side panel",requires:["empty",function(){return Ext.getCmp("FR-Tree-Region").collapsed}],handler:FR.UI.expandTree}),selected:new FR.ContextAction({tooltip:"Clear selection",text:"&nbsp;",iconCls:"fa-close",cls:"fr-btn-clear-sel",requires:["non-empty"],handler:function(){FR.UI.gridPanel.selModel.clearSelections()}}),newItem:new FR.ContextAction({text:"New",iconCls:"fa-plus",cls:"fr-btn-new",requires:["empty","upload",function(){return!FR.UI.gridPanel.view.searchMode}],handler:function(){FR.UI.gridPanel.showContextMenu(this.el)}}),newCollection:new FR.ContextAction({text:"New collection",iconCls:"fa-plus",cls:"fr-btn-new",requires:["empty","not-readonly",function(){return Settings.ui_enable_collections},{sections:["collections"]}],handler:function(){FR.actions.newCollectionPrompt()}}),newAlbum:new FR.ContextAction({text:"New photo album",iconCls:"fa-plus",cls:"fr-btn-new",requires:["empty","not-readonly",function(){return Settings.ui_enable_collections},function(){return Settings.media_folders_photos},{sections:["albums"]}],handler:function(){FR.actions.newCollectionPrompt({type:"album"})}}),emptyTrash:new FR.ContextAction({text:"Empty trash",iconCls:"fa-trash",cls:"fr-btn-new",handler:function(){return FR.actions.emptyTrash()},requires:["isTrash"]}),searchBtn:new FR.ContextAction({tooltip:"Search",requires:["empty",function(){return FR.currentFolderHasSearch&&!FR.UI.searchPanel.isVisible()}],iconCls:"fa-search",cls:"fr-btn-search",handler:function(){FR.UI.searchPanel.open()}}),cancelSearch:new FR.ContextAction({text:"Cancel search",iconCls:"fa-close",cls:"fr-btn-new",requires:["empty",function(){return FR.UI.gridPanel.view.searchMode}],handler:function(){FR.UI.searchPanel.close()}}),downloadCart:new Ext.menu.Item({iconCls:"fa-cart-arrow-down",cls:"fr-btn-cart",text:"Download cart",hidden:!Settings.ui_enable_download_cart||!User.perms.download,handler:function(){this.deactivate();FR.UI.cartWindow.show()},listeners:{render:function(){FR.UI.cart.attachToComponent(this)}}}),filePick:new FR.ContextAction({iconCls:"fa-check",text:FR.UI.layout.isSmall?false:"Select",tooltip:"Select file",requires:["non-empty","single",function(target){return FR.filePicker&&"file"in target.objectTypes}],cls:FR.UI.layout.isSmall?false:"fr-btn-primary fr-btn-file-picker",handler:function(){var a=FR.UI.contextActions[FR.filePicker];if(a){var item=FR.UI.gridPanel.getOneSel();FR.actions.customAction(a.pluginSettings,item.data.path,item.data.name)}}}),download:new FR.ContextAction({tooltip:"Download",iconCls:"fa-download",action:"download",contextTarget:"topMenu",requires:["non-empty","download",function(target){if(!User.perms.download_folders){if(target.location=="tree"){return false}if("folder"in target.objectTypes){return false}}return true}]}),locate:new FR.ContextAction({tooltip:"Open file location",iconCls:"fa-folder",action:"locate",contextTarget:"topMenu",requires:["single","in-grid","isFileOrFolder",function(){return FR.UI.gridPanel.view.searchMode||["myfiles","userWithShares","sharedFolder","trash"].indexOf(FR.currentSection)==-1}]}),preview:new FR.ContextAction({tooltip:"Preview",iconCls:"fa-eye",action:"preview",contextTarget:"topMenu",requires:["preview"]}),weblink:new FR.ContextAction({tooltip:"Web link",iconCls:"fa-link",action:"weblink",contextTarget:"topMenu",requires:["single","non-empty","not-homefolder","download","weblink",function(){return!FR.UI.gridPanel.view.searchMode}]}),shareWithUsers:new FR.ContextAction({tooltip:"Share with users",iconCls:"fa-user-plus",action:"shareWithUsers",contextTarget:"topMenu",requires:["non-empty","share","isFileOrFolder",function(){return!FR.UI.gridPanel.view.searchMode}]}),remove:new FR.ContextAction({tooltip:"Delete",iconCls:"fa-trash",action:"remove",contextTarget:"topMenu",requires:["non-empty","alter","not-homefolder",{skip_sections:["trash"]},function(target){return"folder"in target.objectTypes||"file"in target.objectTypes},function(){return!FR.UI.layout.isSmall},function(){return!FR.UI.gridPanel.view.searchMode}]}),more:new FR.ContextAction({tooltip:"More options",iconCls:"fa-ellipsis-v",cls:"fr-btn-more",requires:["non-empty"],handler:function(){FR.UI.gridPanel.showContextMenu(this.el)}}),info:new FR.ContextAction({tooltip:"View details",iconCls:"fa-info-circle",cls:"fr-btn-info-toggle",requires:[function(){return FR.UI.infoPanel.collapsed}],handler:FR.UI.expandInfo}),refresh:new Ext.Button({iconCls:"fa-refresh",cls:"fr-btn-refresh",tooltip:"Refresh",handler:function(){FR.contextMenuActions.refresh(false)},hidden:true}),sortItems:new Ext.menu.CheckItem({text:"Sort",hidden:true,checkHandler:function(menuItem,checked){var hd=FR.UI.gridPanel.getView().mainHd;if(checked){hd.setStyle("display","block");FR.UI.feedback("Use the displayed header bar to sort by the desired field.")}else{hd.setStyle("display","none")}}}),disableFolderGrouping:new Ext.menu.CheckItem({hidden:true,text:"Disable grouping",checkHandler:function(menuItem,checked){var g=FR.UI.gridPanel;g.store.enableFolderGrouping=!checked;g.store.applySort();g.view.refresh()}}),toggleFilter:{iconCls:"fa-filter",text:"Show only",hideOnClick:false,menu:{defaults:{xtype:"menucheckitem",group:"filter_mode",checkHandler:function(m){FR.UI.gridPanel.view.changeFilter(m.value,false)}},items:function(){var typeFilterList=[{text:"Show all",value:false},"-"];Ext.iterate(FR.metaFileTypes,function(id,type){typeFilterList.push({text:type.name,value:id})});return typeFilterList}()}},selectAll:{tooltip:"Select All",iconCls:"fa-check-square",handler:function(){FR.utils.toggleGridSelection()}},toggleViewList:new Ext.Panel({unstyled:true,title:"Display mode",layout:"fit",items:new Ext.menu.Menu({floating:false,defaults:{xtype:"menucheckitem",group:"display_mode",checkHandler:function(m){var permanent=["photos","videos","music"].indexOf(FR.currentSection)==-1;FR.UI.gridPanel.view.setViewMode(m.value,permanent).refresh(true);FR.UI.actions.gridOptions.menu.hide()}},items:[{iconCls:"fa-list",text:"Detailed list",value:"list"},{iconCls:"fa-grid",text:"Thumbnails",value:"thumbnails"},{iconCls:"fa-grid2",text:"Large",value:"large_grid"},{iconCls:"fa-photo",text:"Photos",value:"photos"}]})})};var ua=FR.UI.actions;ua.gridOptions=new Ext.Button({iconCls:"fa-sliders-v-square",tooltip:"Options",hidden:true,menu:{modal:Ext.isPhone,items:[ua.toggleViewList,"-",ua.sortItems,ua.disableFolderGrouping,"-",ua.toggleFilter]}});FR.UI.headerTBar=new Ext.Toolbar({cls:"headerTbar",height:FR.UI.layout.northBarsHeight,plain:true,layoutConfig:{triggerWidth:52},items:[ua.openTree,ua.filePick,ua.emptyTrash,ua.newItem,ua.newCollection,ua.newAlbum,ua.cancelSearch,ua.searchBtn,ua.selected,ua.locate,ua.preview,ua.weblink,ua.shareWithUsers,ua.download,ua.remove,ua.more,"->",ua.info]});FR.UI.gridToolbar=new Ext.Container({cls:"fr-grid-tbar",items:[FR.UI.gridBreadcrumbs=new FR.components.gridBreadcrumbs({flex:1}),{xtype:"toolbar",cls:"fr-grid-utils-tbar",items:["->",ua.refresh,ua.selectAll,ua.gridOptions]}]});FR.UI.contextActions={};var a=FR.UI.contextActions;a.newFolder=new FR.ContextAction({text:"Folder",iconCls:"fa-folder-plus",requires:["empty","folder","upload"],action:"newFolder"});a.newFileUpload=new FR.ContextAction({text:"File upload",iconCls:"fa-file-upload",requires:["empty","folder","upload"],handler:function(){FR.actions.upload("files")}});a.newFolderUpload=new FR.ContextAction({text:"Folder upload",iconCls:"fa-folder-upload",requires:["empty","folder","upload"],handler:function(){FR.actions.upload("folder")}});a.newFileRequest=new FR.ContextAction({text:"File request",iconCls:"fa-inbox-in",requires:["empty","folder","upload"],handler:function(){FR.contextMenuActions.newFileRequest(false)}});a.newSubFolder=new FR.ContextAction({text:"New sub-folder",iconCls:"fa-folder-plus",action:"newFolder",requires:["non-empty","in-tree","folder","upload"]});a.copyPath=new FR.ContextAction({text:"Copy path",iconCls:"fa-clipboard",action:"copyPath",requires:["non-empty","single","not-homefolder","isFileOrFolder"],isMoreOptItem:true});a.locate=new FR.ContextAction({text:"Open file location",iconCls:"fa-folder",style:"font-weight:bold",action:"locate",requires:["single","in-grid","isFileOrFolder",{skip_sections:["trash","userWithShares","sharedFolder"]},function(){return FR.currentSection!="myfiles"||FR.currentSection=="myfiles"&&FR.UI.gridPanel.view.searchMode}]});a.download=new FR.ContextAction({text:"Download",iconCls:"fa-download",action:"download",requires:["non-empty","download",function(target){if(!User.perms.download_folders){if(target.location=="tree"){return false}if("folder"in target.objectTypes){return false}}return true}]});a.preview=new FR.ContextAction({text:"Preview",iconCls:"fa-eye",action:"preview",requires:["preview"]});a.edit=new FR.ContextAction({text:"Edit",iconCls:"fa-edit",action:"edit",requires:["single","file","edit",{skip_sections:["trash"]}]});var openWithItems=[],createNewFileItems=[];Ext.iterate(FR.customActions,function(n,ca){ca.actionName=n;var a;if(ca.createNew){var enable=true;Ext.each(ca.requiredUserPerms,function(perm){if(!User.perms[perm]){enable=false}});if(enable){a={text:ca.createNew.title,icon:ca.icon,iconCls:ca.iconCls,requires:["empty","upload"]};if(ca.createNew.options){a.menu=[];Ext.each(ca.createNew.options,function(o){a.menu.push({text:o.title,icon:o.icon,iconCls:o.iconCls,handler:function(){return FR.actions.createNew(ca,o.fileName)}})});a.handler=function(){return false}}else{a.handler=function(){return FR.actions.createNew(ca)}}createNewFileItems.push(FR.UI.contextActions["createNew_"+n]=new FR.ContextAction(a))}}a={action:"customAction",isOpenWithItem:true,text:ca.title,icon:ca.icon,iconCls:ca.iconCls,requires:ca.requires||[]};if(a.requires.indexOf("multiple")==-1){a.requires.push("single")}if(!ca.folder){a.requires.push("file")}if(ca.extensions){a.requires.push(function(target,opt){return opt.pluginSettings.extensions.indexOf(target.items[0].ext)!=-1});if(ca.replaceDoubleClickAction){Ext.each(ca.extensions,function(ext){FR.ext[ext]=n})}}if(ca.useWith){a.requires.push(function(target,opt){return opt.pluginSettings.useWith.indexOf(target.items[0].filetype)!=-1})}FR.UI.contextActions[n]=new FR.ContextAction(a);FR.UI.contextActions[n].pluginSettings=ca;openWithItems.push(FR.UI.contextActions[n])});a.openWith=new FR.ContextAction({text:"Open with",iconCls:"fa-arrows",menu:{items:openWithItems},requires:["non-empty","download",{skip_sections:["trash","collections"]}]});a.label=new FR.ContextAction({text:"Label",iconCls:"fa-tag",menu:FR.UI.getLabelMenuItems(function(label){FR.actions.setLabel(FR.UI.contextMenu.lastTarget,label)}),requires:["non-empty","not-homefolder","isFileOrFolder","comment",{skip_sections:["trash"]}]});a.addToCollection=new FR.ContextAction({text:"Collection",action:"add2Col",requires:[function(){return Settings.ui_enable_collections},"not-readonly","non-empty","not-homefolder","download"],iconCls:"fa-clone",isAddToItem:true});a.addToPhotoAlbum=new FR.ContextAction({text:"Photo album",action:"add2Album",requires:[function(){return Settings.media_folders_photos},"not-readonly","non-empty","not-homefolder","download"],iconCls:"fa-images",isAddToItem:true});a.addStar=new FR.ContextAction({text:"Starred",iconCls:"fa-star",action:"addStar",requires:["metadata","non-empty","not-readonly","isFileOrFolder",{skip_sections:["trash","starred"]},"not-homefolder",function(){return User.perms.download},function(target){if(target.location=="grid"){var countStarred=0;Ext.each(target.items,function(t){if(t.star){countStarred++}});if(countStarred==0||countStarred>0&&countStarred<target.items.length){return true}}else{var a=target.items[0].attributes;if(target.section=="myfiles"||target.section=="sharedFolder"){return!a.custom||a.custom&&!a.custom.star}}}],isAddToItem:true});a.removeStar=new FR.ContextAction({text:"Remove star",iconCls:"fa-star",action:"removeStar",requires:["non-empty",{skip_sections:["trash"]},"not-readonly",function(){return User.perms.download},function(target){if(target.location=="grid"){if(target.section=="starred"){return true}var countStarred=0;Ext.each(target.items,function(t){if(t.star){countStarred++}});if(countStarred>0){return true}}else{if(target.section=="myfiles"||target.section=="sharedFolder"){var a=target.items[0].attributes;return a.custom&&a.custom.star}}}]});a.metadata=new FR.ContextAction({text:"Metadata",iconCls:"fa-sticky-note",action:"metadata",requires:["single","not-homefolder","isFileOrFolder",function(){return User.perms.metadata}],isMoreOptItem:true});a.rename=new FR.ContextAction({text:"Rename",iconCls:"fa-i-cursor",action:"rename",requires:["non-empty",{skip_sections:["trash"]},"not-homefolder","single","alter",function(target){if(target.location=="tree"&&target.items[0].attributes.section=="collections"){return false}return true}]});a.restore=new FR.ContextAction({text:"Restore",iconCls:"fa-undo",action:"restore",requires:["non-empty","in-grid","alter",{sections:["trash"]}]});a.weblink=new FR.ContextAction({text:"Web link",iconCls:"fa-link",action:"weblink",requires:["single","non-empty","not-homefolder","download","weblink"],isShareItem:true});a.shareWithUsers=new FR.ContextAction({text:"With users",iconCls:"fa-user-plus",action:"shareWithUsers",requires:["non-empty","download","share","isNotCollection"],isShareItem:true});a.remove=new FR.ContextAction({text:"Delete",iconCls:"fa-trash",action:"remove",requires:["non-empty","alter","not-homefolder",function(target){return"folder"in target.objectTypes||"file"in target.objectTypes}]});a.email=new FR.ContextAction({text:"E-mail",iconCls:"fa-envelope-o",action:"email",requires:["non-empty","not-homefolder","download","email","isNotCollection"],isShareItem:true});a.share=new FR.ContextAction({text:"Share",iconCls:"fa-share-alt",menu:[a.weblink,a.shareWithUsers,a.email]});a.getInternalLink=new FR.ContextAction({text:"Copy direct link",iconCls:"fa-link",action:"getInternalLink",requires:["single","isFileOrFolder","not-homefolder",{skip_sections:["trash"]}],isMoreOptItem:true});a.notifications=new FR.ContextAction({text:"Notifications",iconCls:"fa-bell",requires:["single","folder",{sections:["myfiles","userWithShares","sharedFolder","collection"]},"isNotCollection",function(){return Settings.allow_folder_notifications}],menu:{listeners:{beforeshow:function(){var nfo,t=FR.UI.contextMenu.lastTarget,firstItem=t.items[0];if(t.location=="tree"){var tn=firstItem.attributes;if(tn.custom&&tn.custom.notInfo){nfo=tn.custom.notInfo}}else{nfo=firstItem.notInfo}if(!nfo){nfo={w:0,s:0,r:0,m:0}}var menu=this.items.first().items.first();menu.items.each(function(menuItem){menuItem.setChecked(nfo[menuItem.name],true)})}},items:{xtype:"panel",title:"Receive notifications on:",unstyled:true,layout:"fit",items:new Ext.menu.Menu({floating:false,autoWidth:true,defaults:{xtype:"menucheckitem",hideLabel:true,checkHandler:function(){var menu=this.ownerCt;menu.el.mask("Please wait...");FR.contextMenuActions.saveNotif(menu.items,function(){menu.el.unmask()})}},items:[{text:"New files",name:"w"},{text:"New comments and labels",name:"s"},{text:"Downloads and previews",name:"r"},{text:"Other actions",name:"m"}]})}},isMoreOptItem:true});a.fileCPanel=new FR.ContextAction({text:"Control panel",iconCls:"fa-cogs",action:"openFileCPanel",requires:["admin","single","isFileOrFolder"],isMoreOptItem:true});a.copyMove=new FR.ContextAction({text:FR.T("Copy")+"/"+FR.T("Move"),iconCls:"fa-copy",action:"copyOrMove",requires:["non-empty","isNotCollection",{skip_sections:["trash"]},"not-homefolder","download","not-readonly"]});a.alog=new FR.ContextAction({text:"Activity log",iconCls:"fa-book",action:"activityLog",requires:["single","isFileOrFolder","not-homefolder",function(target){if(!User.perms.file_history){return false}if(target.section=="sharedFolder"){return Settings.filelog_for_shares}return true}],isMoreOptItem:true});a.addToCart=new FR.ContextAction({text:"Download cart",iconCls:"fa-cart-arrow-down",action:"addToCart",requires:[{skip_sections:["sharedFolder"]},"non-empty","not-homefolder","download",function(){return Settings.ui_enable_download_cart}],isAddToItem:true});a.zip=new FR.ContextAction({text:"Zip archive",iconCls:"fa-file-zip-o",action:"zip",requires:["non-empty","not-homefolder","upload","download","alter",{sections:["myfiles","sharedFolder"]},function(target){if(target.items.length==1&&target.items[0].filetype=="arch"){return false}return true}],isAddToItem:true});a.extract=new FR.ContextAction({text:"Extract archive",iconCls:"fa-file-archive",action:"extract",requires:["file","single","download","upload",function(target){return target.items[0].filetype=="arch"}],isAddToItem:true});a.unweblink=new FR.ContextAction({text:"Remove links",style:"font-weight:bold",iconCls:"fa-unlink",action:"unweblink",requires:["non-empty","in-grid",{sections:["webLinked"]}]});a.removeFromCollection=new FR.ContextAction({text:"Remove from collection",iconCls:"fa-square-minus",style:"font-weight:bold",action:"removeFromCollection",requires:["non-empty","in-grid","not-readonly",{sections:["collection"]}]});a.removeCollections=new FR.ContextAction({text:"Remove",iconCls:"fa-minus-circle",action:"removeCollections",requires:["non-empty","not-readonly","isCollection"]});a.lock=new FR.ContextAction({text:"Lock",iconCls:"fa-lock",action:"lock",requires:["alter","download","file",function(){return!Settings.free_mode&&!Settings.freelancer_mode}]});a.unlock=new FR.ContextAction({text:"Unlock",iconCls:"fa-unlock-alt",action:"unlock",requires:["alter","download","file",function(){return!Settings.free_mode&&!Settings.freelancer_mode}]});a.versioning=new FR.ContextAction({text:"Versioning",iconCls:"fa-history",requires:["single","file",{skip_sections:["trash"]},"download",function(){return!Settings.disable_versioning}],isMoreOptItem:true,menu:new Ext.menu.Menu({id:"myfiles-contextmenu-versioning",items:[new Ext.menu.Item({text:"Previous versions",iconCls:"fa-history",handler:function(){return FR.actions.openVersions(FR.UI.gridPanel.target)},hidden:Settings.disable_versioning}),a.lock,a.unlock]})});a.addTo=new FR.ContextAction({iconCls:"fa-file-plus",text:"Add to",menu:[a.addStar,a.addToCollection,a.addToPhotoAlbum,a.zip,a.addToCart]});a.more=new FR.ContextAction({text:"More options",iconCls:"fa-ellipsis-v",menu:[a.copyPath,a.getInternalLink,a.metadata,a.versioning,a.notifications,a.alog,a.fileCPanel]});a.viewDetails=new FR.ContextAction({text:"View details",iconCls:"fa-info-circle",action:"viewDetails",requires:["in-grid","non-empty",function(){var v=FR.UI.ImageViewer;if(v&&!v.hidden){return v.infoPanel.collapsed}else{return FR.UI.infoPanel.collapsed}}]});a.emptyTrash=new FR.ContextAction({text:"Empty trash",iconCls:"fa-trash",handler:function(){return FR.actions.emptyTrash()},requires:["isTrash"]});for(var i=0;i<=10;i++){a["s"+i]=new Ext.menu.Separator}var contextItems=[a.newFolder,a.s0,a.newFileUpload,a.newFolderUpload,a.newFileRequest,a.s2,a.newSubFolder,a.s3,a.locate,a.s4,a.download,a.preview,a.edit,a.openWith,a.s5,a.share,a.label,a.s6,a.addTo,a.copyMove,a.removeStar,a.extract,a.restore,a.s7,a.viewDetails,a.more,a.rename,a.s8,a.remove,a.removeCollections,a.s9,a.emptyTrash,a.unweblink,a.removeFromCollection];Ext.each(createNewFileItems,function(item){contextItems.push(item)});FR.UI.contextMenu=new FR.components.ContextMenu({items:contextItems});var userMenu={modal:Ext.isPhone,items:[{text:"Connect app",hidden:!Settings.ui_show_connect_app,iconCls:"fa-plug",handler:function(){FR.actions.connectWebDav()}}]};if(User.perms.account_settings){userMenu.items.push({text:"Account settings",iconCls:"fa-address-card",handler:function(){FR.actions.openAccountSettings()}})}if(!Settings.hideLogout){userMenu.items.push({text:"Sign out",iconCls:"fa-sign-out",handler:function(){document.location.href=FR.logoutURL}})}if(userMenu.items.length==0){userMenu=false}FR.UI.quotaIndicator=new Ext.menu.Item({text:"Storage usage",iconCls:"fa-database",tooltip:"Click to recalculate",hidden:!FR.utils.hasQuota(),hideOnClick:false,handler:FR.UI.refreshQuotaUsage});var items={cpanel:{text:"Control panel",iconCls:"fa-cog",handler:function(){FR.actions.openControlPanel()},hidden:!User.isAdmin&&!User.isIndep},help:{text:"Help",iconCls:"fa-question",handler:function(){if(!Settings.helpURL.startsWith("http")){window.open(Settings.helpURL)}else{FR.UI.popup({src:Settings.helpURL,noId:1})}},hidden:!Settings.helpURL},user:{id:"fr-btn-user",cls:"fr-btn-user",text:User.fname,icon:FR.baseURL+"/a/?uid="+User.id,menuIndicatorCls:"fa-no-icon",autoExpand:false,menu:userMenu},pwdBy:{id:"funny-"+Math.random(),icon:Settings.smallFileRunLogoURL,text:'<img height="20" title="FileRun" alt="FileRun" src="'+Settings.FileRunLogoURL+'" style="vertical-align: middle;" />',hidden:!Settings.has_branding,handler:function(){window.open("https://filerun.com/ref/ui")}}};var cornerMenuItems=["-",ua.downloadCart];if(FR.UI.layout.isShort){items.user.menu.items.unshift("-");items.user.menu.items.unshift(items.help);items.user.menu.items.unshift("-");items.user.menu.items.unshift(items.cpanel);if(FR.utils.hasQuota()){items.user.menu.items.push({xtype:"menuseparator"})}items.user.menu.items.push(FR.UI.quotaIndicator);cornerMenuItems.push(items.user)}else{cornerMenuItems.push(items.cpanel);cornerMenuItems.push(items.help);cornerMenuItems.push(items.user);if(FR.utils.hasQuota()){cornerMenuItems.push({xtype:"menuseparator"})}cornerMenuItems.push(FR.UI.quotaIndicator)}cornerMenuItems.push(items.pwdBy);FR.UI.cornerMenu=new Ext.menu.Menu({cls:"cornerMenu",floating:false,subMenuAlign:"br-tr?",ignoreParentClicks:true,items:cornerMenuItems});FR.UI.cornerMenu.render()};FR.components.ContextMenu=Ext.extend(Ext.menu.Menu,{target:false,location:false,section:false,countVisible:0,modal:Ext.isPhone,reqChecks:new Ext.util.MixedCollection,event:function(opts){Ext.apply(this,opts);this.prepareItems();if(this.countVisible>0){if(opts.alignTo||this.modal){this.show(opts.alignTo)}else{this.showAtCursor()}}},showSeparators:function(){var visible=new Ext.util.MixedCollection;if(!this.countVisible){return}this.items.each(function(item){if(item.getXType()=="menuseparator"||!item.hidden){visible.add(visible.getCount(),item)}});var lastShown,visibleBefore=0;visible.each(function(item){if(item.getXType()=="menuseparator"){if(visibleBefore&&(!lastShown||lastShown&&lastShown.getXType()!="menuseparator")){item.show()}}else{visibleBefore++}if(!item.hidden){lastShown=item}});if(lastShown.getXType()=="menuseparator"){lastShown.hide()}visible.keySort("DESC",function(a,b){return a-b});visibleBefore=0;visible.each(function(item){if(item.getXType()=="menuseparator"){if(visibleBefore==0){item.hide()}}else{visibleBefore++}})},prepareItems:function(){var target;this.countVisible=0;this.countVisibleOpenWithItems=0;this.countVisibleAddToItems=0;this.countVisibleMoreOptsItems=0;this.countVisibleShareItems=0;this.reqChecks.clear();if(this.location=="grid"){target=FR.UI.gridPanel.target}else{target=FR.Context.getTarget(this.location,this.target)}this.lastTarget=target;Ext.iterate(FR.UI.contextActions,function(key,ca){var show=false;var cfg=ca.initialConfig;if(cfg.requires){var meets=0;if(cfg.debug){console.log(cfg.text)}Ext.each(cfg.requires,function(req){var met,prevReqCheck=false,isSimpleReq=typeof req!="function"&&typeof req!="object";if(isSimpleReq){prevReqCheck=this.reqChecks.get(req)}if(prevReqCheck){met=prevReqCheck.met}else{if(typeof req=="function"){met=req(target,ca)}else{met=FR.Context.checkRequirement(req,target)}}if(isSimpleReq){this.reqChecks.add(req,{met:met})}if(cfg.debug){console.log("\t",req,met,prevReqCheck?"prevChecked":"")}if(met){meets++}else{return false}},this);if(cfg.requires.length==meets){show=true;if(cfg.isOpenWithItem){this.countVisibleOpenWithItems++}if(cfg.isAddToItem){this.countVisibleAddToItems++}if(cfg.isMoreOptItem){this.countVisibleMoreOptsItems++}if(cfg.isShareItem){this.countVisibleShareItems++}}}if(show){ca.show();this.countVisible++}else{ca.hide()}},this);FR.UI.contextActions.openWith.setHidden(this.countVisibleOpenWithItems==0);FR.UI.contextActions.addTo.setHidden(this.countVisibleAddToItems==0);FR.UI.contextActions.more.setHidden(this.countVisibleMoreOptsItems==0);FR.UI.contextActions.share.setHidden(this.countVisibleShareItems==0);this.showSeparators()},showAtCursor:function(){this.showAt([FR.UI.xy[0]+2,FR.UI.xy[1]+2])}});