FR.contextMenuActions={addToCart:function(target){FR.UI.cart.addItems(target.getFileList())},refresh:function(){FR.utils.reloadGrid();FR.utils.reloadTree()},locate:function(){return FR.utils.locateSelected()},newFolder:function(target){new Ext.ux.prompt({title:"Create a new folder",defaultValue:FR.T("New Folder"),confirmHandler:function(folderName){if(!folderName){return true}FR.actions.newFolder(target.getPath(),folderName)}})},copyPath:function(target){var path="",treeNode;if(target.location=="tree"){treeNode=target.items[0]}else{treeNode=FR.UI.tree.currentSelectedNode}var items=[treeNode];while(treeNode.parentNode){treeNode=treeNode.parentNode;if(treeNode.isRoot){continue}items.unshift(treeNode)}Ext.each(items,function(treeNode,index){if(index>0){path+=" > "}path+='"'+treeNode.text+'"'},this);if(target.location=="grid"){if(path.length){path+=" > "}path+='"'+target.items[0].filename+'"'}FR.UI.copyToClipboard(path,"The folder path was copied to your clipboard")},newFileRequest:function(){new Ext.ux.prompt({title:"What are you requesting?",placeHolder:"Photos, Documents, Contracts...",confirmHandler:function(folderName){if(!folderName){return true}FR.actions.newFolder(FR.currentPath,folderName,function(rs,opts){FR.actions.WebLink(opts.params.path+"/"+opts.params.name,opts.params.name,true)})}})},download:function(target){var t=target.getFileInfo();var paths=t.paths||[t.path];var zipName=t.filename||FR.UI.currentFolderTitle;FR.actions.download(paths,zipName)},preview:function(target){var firstFile;Ext.each(target.items,function(item){if(item.objectType=="file"){firstFile=item;return false}});if(!firstFile){return false}FR.utils.showPreview(firstFile)},edit:function(target){FR.utils.editFile()},addStar:function(target){FR.actions.star(target,"add")},removeStar:function(target){FR.actions.star(target,"remove")},weblink:function(target){var t=target.getFileInfo();FR.actions.WebLink(t.path,t.filename)},unweblink:function(){FR.actions.UnWebLink()},add2Col:function(target){FR.actions.promptToCollection(target.getFileInfo())},add2Album:function(target){FR.actions.promptToCollection(target.getFileInfo(),{type:"album"})},removeFromCollection:function(){FR.actions.removeFromCollection()},removeCollections:function(target){FR.actions.removeCollections(target)},shareWithUsers:function(target){var t=target.getFileInfo();var paths=t.paths||[t.path];var popupTitle=paths.length>1?FR.T("Sharing %1 items",paths.length):t.filename;FR.sharing={paths:paths};var post=[];Ext.each(paths,function(path){post.push({name:"paths[]",value:path})});FR.UI.persistentWindow({id:"folderShare",src:FR.baseURL+"/?module=share",post:post,modal:true,width:560,height:420,title:popupTitle})},getInternalLink:function(target){FR.actions.process({url:"/?module=fileman&section=utils&page=pid",params:{path:target.getPath()},successCallback:function(rs){if(rs.pid){FR.UI.copyToClipboard(URLRoot+"/index.php/f/"+rs.pid,"The link has been copied to clipboard.")}}})},email:function(target){var items=[];if(target.location=="tree"){var fileInfo=target.getFileInfo();items.push({icon:"f.png",filename:fileInfo.filename,path:fileInfo.path,isFolder:true})}else{Ext.each(target.items,function(gridItem){items.push({icon:gridItem.icon,filename:gridItem.filename,path:gridItem.path,filesize:gridItem.filesize,isFolder:gridItem.isFolder})})}FR.actions.emailFiles(items,true)},openFileCPanel:function(target){var params=[];var fileInfo=target.getFileInfo();params.push({name:"path",value:fileInfo.path});FR.UI.popup({src:FR.baseURL+"/?module=file_cpanel",post:params,title:fileInfo.filename})},metadata:function(target){FR.actions.openMetadata(target)},activityLog:function(target){var t=target.getFileInfo();FR.UI.popup({src:FR.baseURL+"/?module=filelog&section=default&page=default",post:[{name:"path",value:t.path}],title:t.filename})},zip:function(target){var t=target.getFileInfo();var paths=t.paths||[t.path];var zipName;if(target.location=="tree"){zipName=t.filename+".zip"}else{if(t.path){zipName=FR.utils.stripFileExtension(t.filename)+".zip"}else{zipName=FR.T("New Archive.zip")}}new Ext.ux.prompt({title:"Add to zip",text:"Please type a name for the zip file:",defaultValue:zipName,confirmHandler:function(zipName){if(zipName){var target=FR.currentPath+"/"+zipName;FR.actions.abstractZip(target,paths)}}})},extract:function(target){return FR.actions.extractPrompt(target)},lock:function(){return FR.actions.changeLocking(true)},unlock:function(){return FR.actions.changeLocking(false)},copyOrMove:function(target){var params={};var t=target.getFileInfo();params["paths[]"]=t.paths||[t.path];if(!FR.UI.moveToFolderSelector){FR.UI.moveToFolderSelector=new Ext.ux.TargetSelector({dataUrl:FR.baseURL+"/?module=fileman&section=get&page=destination",allowRootSelection:true,addRequiresTarget:true,buttons:[{text:"Move here",disabled:true,cls:"fr-btn-primary",handler:function(){this.params.moveTo=this.getSelectedPath();this.hide();FR.actions.process({baseURL:FR.doBaseURL,url:"&page=move",params:this.params,loadMsg:"Moving files...",failureCallback:function(){this.show()},scope:this})}},{text:"Copy here",cls:"fr-btn-primary",style:"margin-left:5px",handler:function(){this.params.copyTo=this.getSelectedPath();this.hide();FR.actions.process({baseURL:FR.doBaseURL,url:"&page=copy",params:this.params,loadMsg:"Copying...",failureCallback:function(){this.show()},scope:this})}},"->",{iconCls:"fa-folder-plus",text:"New Folder",handler:function(){if(this.selectedRecord){this.listPanel.clearSelections()}new Ext.ux.prompt({title:"Create a new folder",defaultValue:FR.T("New Folder"),confirmHandler:function(name){if(!name){return false}FR.actions.newFolder(this.currentPath,name,Ext.createDelegate(function(){this.addRecord({text:name,perms:this.currentFolderData.perms})},this))},scope:this})}}],onSelectionChange:function(){var perms=FR.getTargetPerms(this.selectedRecord?this.selectedRecord.data.perms:this.currentFolderData.perms);this.buttons[0].setText(this.selectedRecord?"Move":"Move here").setDisabled(!perms.upload);this.buttons[1].setText(this.selectedRecord?"Copy":"Copy here").setDisabled(!perms.upload)},onLoad:function(){this.buttons[3].setVisible(FR.getTargetPerms(this.currentFolderData.perms).upload)},listeners:{hide:function(){FR.UI.gridPanel.view.focusEl.focus()}}})}FR.UI.moveToFolderSelector.params=params;var browsePath="/ROOT/HOME";if(["myfiles","userWithShares","sharedFolder"].indexOf(FR.currentSection)!=-1){browsePath=FR.currentPath}else{if(params["paths[]"].length==1){var first=params["paths[]"][0];var pathInfo=FR.utils.pathInfo(first);browsePath=pathInfo.dirname}}FR.UI.moveToFolderSelector.show().load(browsePath)},rename:function(target){var t=target.getFileInfo();var pars={path:t.path};new Ext.ux.prompt({title:"Rename",confirmBtnLabel:"Rename",defaultValue:t.filename,closable:true,confirmHandler:function(newValue,oldValue){if(newValue&&newValue!=oldValue){pars.newName=newValue;FR.actions.process({baseURL:FR.doBaseURL,url:"&page=rename",params:pars,loadMsg:"Renaming file..."})}}})},remove:function(target,ca,e){var showPrompt=e&&e.shiftKey||"folder"in target.objectTypes;var fileInfo=target.getFileInfo();FR.removeParams={"paths[]":fileInfo.paths||[fileInfo.path]};if(FR.currentSection=="trash"){showPrompt=false}else if(["myfiles","sharedFolder"].indexOf(FR.currentSection)==-1){showPrompt=true}if(showPrompt){var promptTitle;var promptMessage=FR.T("Are you sure?");if(target.items.length==1){promptTitle=FR.T("Deleting %1",FR.UI.styleFileName(fileInfo.filename))}else{promptTitle=FR.T("Deleting %1",FR.T("multiple items"))}if(["myfiles","sharedFolder"].indexOf(FR.currentSection)==-1){promptMessage='<span style="color:var(--theme-textDanger);font-weight:bold"><i class="fa fa-warning fa-inline fa-flash"></i> '+FR.T("This action deletes file data.")+"</span><br><br>"+promptMessage}FR.UI.lastDeleteFolderWin=new Ext.Window({title:promptTitle,width:400,modal:true,html:'<div style="margin: 14px 0">'+promptMessage+'</div><div style="margin:10px 0 24px 0;"><label><input type="checkbox" value="1" class="folderDelConfWinPerm" style="vertical-align:middle;margin-right:5px;" />'+FR.T("Permanent deletion")+"</label></div>",defaultButton:0,buttons:[{text:"Delete",cls:"fr-btn-primary",handler:function(){var win=FR.UI.lastDeleteFolderWin;var permCheckbox=win.el.query("input.folderDelConfWinPerm")[0];if(permCheckbox.checked){FR.removeParams.permanent=true}win.close();FR.actions.remove()}},{text:"Cancel",style:"margin-left:10px",handler:function(){FR.UI.lastDeleteFolderWin.close()}}],listeners:{hide:function(){FR.UI.gridPanel.view.focusEl.focus()}}});FR.UI.lastDeleteFolderWin.show();return true}FR.actions.remove()},restore:function(){FR.actions.processGridItemsByIds({url:"/?module=trash&section=ajax&page=restore",loadMsg:"Restoring file(s)..."})},saveNotif:function(menuOptions,callback){var params={path:FR.UI.contextMenu.lastTarget.getPath()};menuOptions.each(function(opt){if(opt.name){params["options["+opt.name+"]"]=opt.checked?1:0}});FR.actions.process({url:"/?module=notifications&section=ajax&page=set",params:params,callback:callback})},customAction:function(target,ca,e){var f=target.getFileInfo();FR.actions.customAction(ca.baseAction.pluginSettings,f.paths||f.path,f.filename,e)},viewDetails:function(){var v=FR.UI.ImageViewer;if(v&&!v.hidden){v.openDetails()}else{FR.UI.expandInfo()}}};FR.actions.upload=function(type){if(!FR.currentFolderPerms.upload){FR.UI.feedback("You are not allowed to upload files in this folder.");return false}FR.UI.showUploadWindow({targetPath:FR.currentPath,folder:type=="folder"})};FR.actions.openMetadata=function(target){var fileInfo=target.getFileInfo();FR.UI.popup({title:FR.T("Metadata: %1",FR.UI.styleFileName(fileInfo.filename)),width:460,height:600,autoDestroy:true,src:FR.baseURL+"/?module=metadata&path="+encodeURIComponent(fileInfo.path)})};FR.actions.remove=function(){FR.removeParams.csrf=User.csrf_token;var opts={params:FR.removeParams,loadMsg:"Deleting files...",callback:function(){FR.removeParams={}}};if(FR.currentSection=="trash"){opts.url="/?module=trash&section=ajax&page=delete"}else{opts.url="&page=delete";opts.baseURL=FR.doBaseURL}FR.actions.process(opts)};FR.actions.UnWebLink=function(){FR.actions.processGridItemsByPaths({url:"/?module=weblinks&section=ajax&page=remove_multiple"})};FR.actions.download=function(paths,archiveName){var url=FR.doBaseURL+"&page=download";if(archiveName){url+="&archiveName="+encodeURIComponent(archiveName)}var dom={tag:"FORM",action:url,method:"POST",target:"_blank",children:[]};Ext.each(paths,function(p){dom.children.push({tag:"INPUT",type:"hidden",name:"paths[]",value:p})});var frm=Ext.get("theBODY").createChild(dom,false);frm.dom.submit();frm.remove()};FR.actions.openFileInBrowser=function(path){window.open(FR.doBaseURL+"&page=download&open_in_browser=1&paths[]="+encodeURIComponent(path))};FR.actions.connectWebDav=function(){window.open(FR.baseURL+"/oauth2/authorize/?response_type=webdav&client_id=Generic0000000000000000000WebDAV&redirect_uri=nc%3A%2F%2F&state=state5df4f4de0f81e&scope=webdav")};FR.actions.openAccountSettings=function(){FR.UI.popup({id:"accountSettings",title:"Account settings",src:FR.baseURL+"/?module=fileman&section=profile",width:580,height:500,autoDestroy:true,modal:true})};FR.actions.move=function(drop,target){FR.moveParams={"paths[]":[],moveTo:target};var paths=[];var hasFolders=false;if(drop.data.grid){Ext.each(drop.data.selections,function(s){if(s.data.isFolder){hasFolders=true}FR.moveParams["paths[]"].push(s.data.path)});if(!FR.moveParams["paths[]"].length){return false}}else if(drop.tree){hasFolders=true;FR.moveParams["paths[]"].push(drop.dropNode.getPath("pathname"))}else{return false}if(hasFolders){new Ext.ux.prompt({title:"Move folder?",text:"Are you sure you want to move the folder?",confirmHandler:function(){FR.actions.doMove()}});return true}FR.actions.doMove()};FR.actions.doMove=function(){FR.actions.process({baseURL:FR.doBaseURL,url:"&page=move",params:FR.moveParams,loadMsg:"Moving files..."})};FR.actions.emptyTrash=function(cnfirm){if(!cnfirm){new Ext.ux.prompt({title:"Empty trash?",text:"All files and folders in your trash are about to be permanently deleted.",confirmHandler:function(){FR.actions.emptyTrash(true)}});return true}FR.actions.process({url:"/?module=trash&section=ajax&page=empty",loadMsg:"Emptying trash...",successCallback:function(){if(FR.currentSection=="trash"){FR.utils.reloadGrid()}FR.UI.refreshQuotaUsage()}})};FR.actions.newFolder=function(path,folderName,successCallback){FR.actions.process({baseURL:FR.doBaseURL,url:"&page=new_folder",params:{path:path,name:folderName},loadMsg:"Creating new folder...",successCallback:successCallback||function(rs,opts){FR.UI.gridPanel.highlightOnDisplay=opts.params.name}})};FR.actions.changeLocking=function(lock){FR.actions.processGridItemsByPaths({url:"/?module=versioning&section=ajax&page=locking&action="+(lock?"lock":"unlock"),loadMsg:lock?"Locking file...":"Unlocking file..."})};FR.actions.abstractZip=function(target,paths){var pars={target:target};pars["paths[]"]=paths;FR.actions.process({params:pars,baseURL:FR.doBaseURL,url:"&page=zip",loadMsg:"Zipping files...",failureCallback:function(rs){if(!rs||rs&&!rs.msg){new Ext.ux.prompt({text:"An error occurred while trying to process the request."})}},successCallback:function(){FR.utils.reloadGrid()}})};FR.actions.extractPrompt=function(target){var selectedFile=target.getFileInfo();if(!FR.UI.extractToFolderSelector){FR.UI.extractToFolderSelector=new Ext.ux.TargetSelector({dataUrl:FR.baseURL+"/?module=fileman&section=get&page=tree",allowRootSelection:true,addRequiresTarget:true,buttons:[{text:"Extract here",cls:"fr-btn-primary",handler:function(){this.params.extractTo=this.getSelectedPath();this.hide();FR.actions.process({baseURL:FR.doBaseURL,url:"&page=extract",params:this.params,loadMsg:"Extracting archive contents...",failureCallback:function(){this.show()},scope:this})}},"->",{iconCls:"fa-folder-plus",text:"New Folder",handler:function(){if(this.selectedRecord){this.load(this.selectedRecord.get("path"))}new Ext.ux.prompt({title:"Create a new folder",defaultValue:FR.utils.stripFileExtension(selectedFile.filename),confirmHandler:function(name){if(!name){return false}FR.actions.newFolder(this.currentPath,name,Ext.createDelegate(function(){this.addRecord({text:name,perms:this.currentFolderData.perms})},this))},scope:this})}}],onSelectionChange:function(){var perms=FR.getTargetPerms(this.selectedRecord?this.selectedRecord.data.perms:this.currentFolderData.perms);this.buttons[0].setText(this.selectedRecord?"Extract":"Extract here").setDisabled(!perms.upload)},onLoad:function(){this.buttons[2].setVisible(FR.getTargetPerms(this.currentFolderData.perms).upload)},listeners:{hide:function(){FR.UI.gridPanel.view.focusEl.focus()}}})}FR.UI.extractToFolderSelector.params={path:selectedFile.path};FR.UI.extractToFolderSelector.show().load(FR.currentPath)};FR.actions.emailFiles=function(items,sendLinks){FR.sendingByEmail={items:items,sendLinks:sendLinks};FR.UI.persistentWindow({id:"emailFiles",src:FR.baseURL+"/?module=email",width:480,height:490,title:"E-mail Files",modal:true})};FR.actions.EmailFromLink=function(){FR.UI.popups.webLink.hide();var pathInfo=FR.utils.pathInfo(FR.WebLinking.path);FR.utils.locateItem(pathInfo.dirname,pathInfo.basename,function(success,gridNode){if(!success){return false}var data=gridNode.data;var items=[{icon:data.icon,filename:data.filename,path:data.path,filesize:data.filesize,isFolder:data.isFolder}];FR.actions.emailFiles(items,true)})};FR.actions.WebLink=function(path,itemTitle,isFileRequest){FR.WebLinking={path:path,isFileRequest:isFileRequest};FR.UI.persistentWindow({id:"webLink",src:FR.baseURL+"/?module=weblinks",width:520,height:340,title:itemTitle,modal:true})};FR.actions.openVersions=function(target){var fileInfo=target.getFileInfo();FR.UI.popup({title:FR.T("File versions: %1",FR.UI.styleFileName(fileInfo.filename)),width:450,height:300,src:FR.baseURL+"/?module=versioning",post:[{name:"path",value:fileInfo.path}],autoDestroy:true})};FR.actions.editReadMe=function(readmeFileName){if(!readmeFileName){return false}FR.utils.editFile({path:FR.utils.gluePath(FR.UI.infoPanel.target.getFileInfo().path,readmeFileName),filename:readmeFileName})};FR.actions.setLabel=function(target,label,opts){var t=target.getFileInfo();FR.actions.process(Ext.apply({url:"/?module=labels",params:{label:label,"paths[]":t.paths||[t.path]}},opts||{}))};FR.actions.star=function(target,action){var t=target.getFileInfo();FR.actions.process({url:"/?module=stars&page=set",params:{action:action,"paths[]":t.paths||[t.path]}})};FR.actions.customAction=function(opts,path,filename,e){var url=FR.baseURL+"/?module=custom_actions&action="+opts.actionName;var postData=[{name:"currentPath",value:FR.currentPath}];if(opts.popup||opts.newTab){if(Ext.isArray(path)){Ext.each(path,function(p){postData.push({name:"paths[]",value:p})})}else{postData.push({name:"path",value:path})}}if(Ext.isMobile){postData.push({name:"mobile",value:"1"})}if(opts.newTab){FR.UI.postToTarget({src:url,post:postData})}else if(opts.popup){var popOpts={title:opts.title,loadingMsg:opts.loadingMsg||false,src:url,icon:opts.icon,post:postData,autoDestroy:true};if(filename){popOpts.title+=": "+filename}if(opts.width){popOpts.width=opts.width}if(opts.height){popOpts.height=opts.height}if(opts.external||e&&e.ctrlKey||opts.externalPopupForMobile&&Ext.isMobile){FR.UI.openInPopup(popOpts)}else{FR.UI.popup(popOpts)}}else if(opts.ajax){postData={currentPath:FR.currentPath};if(Ext.isArray(path)){postData["paths[]"]=path}else{postData["path"]=path}FR.actions.process({loadMsg:"Please wait...",url:"/?module=custom_actions&action="+opts.actionName,params:postData,callback:function(rs){if(rs&&rs.refresh){FR.utils.reloadGrid(rs.highlight||false)}}})}else if(opts.handler){opts.handler()}else if(opts.fn){eval(opts.fn)}};FR.actions.createNew=function(action,filename,params){if(action.createNew.fn){new Function(action.createNew.fn)();return true}if(!filename){filename=FR.T(action.createNew.defaultFileName)}if(!params){params={}}new Ext.ux.prompt({text:"Please type a file name:",defaultValue:filename,confirmHandler:function(fileName){FR.actions.process({loadMsg:"Creating blank file...",url:"/?module=custom_actions&action="+action.actionName+"&method=createBlankFile",params:Ext.apply(params,{path:FR.currentPath,fileName:fileName}),successCallback:function(rs,opts){FR.actions.customAction(action,opts.params.path+"/"+fileName,fileName);FR.utils.reloadGrid()}})}})};FR.actions.setMetadata=function(opts){this.processGridItemsByPaths(Ext.applyIf(opts,{url:"/?module=metadata&section=ajax&page=set"}))};FR.actions.createURL=function(url){if(!url){new Ext.ux.prompt({text:"You can paste URLs directly inside the file list. Simply CTRL+V and you will create the link file.<br><br>Or paste it here:",defaultValue:"",confirmHandler:function(url){FR.actions.createURL(url)}});return false}FR.actions.process({loadMsg:"Linking external file...",url:"/?module=custom_actions&action=link",params:{path:FR.currentPath,url:url},successCallback:function(rs,opts){if(rs.success){if(rs.fileName){FR.utils.reloadGrid(rs.fileName)}}}})};FR.actions.handlePaste=function(e){if(!FR.currentFolderPerms.upload){return false}var cd=e.clipboardData;if(!cd.items||!cd.items.length){return false}if(cd.items.length==1){var item=cd.items[0];if(item.kind=="string"&&item.type=="text/plain"&&FR.customActions.link){FR.lastPasteEvent=e;item.getAsString(function(text){if(text.startsWith("http://")||text.startsWith("https://")){if(document.activeElement==FR.UI.gridPanel.view.focusEl.dom){FR.actions.createURL(text)}}});return true}else if(item.type.indexOf("image")===0){var reader=new FileReader;reader.onload=function(event){var imageObj=new Image;imageObj.src=event.target.result;imageObj.style.maxWidth="600px";imageObj.style.maxHeight="400px";imageObj.onload=function(){var w=new Ext.Window({title:"Uploading pasted image...",contentEl:this,modal:true});w.show();var fileName=FR.T("Pasted image")+" "+Ext.util.Format.date(new Date,"Y-m-d H-i-s")+".png";FR.pasteBlob.fileName=fileName;var upload=new Flow({target:"?module=fileman&section=do&page=up",chunkSize:Settings.upload_chunk_size,validateChunkResponse:function(status,message){if(status!="200"){return"retry"}try{var rs=Ext.decode(message)}catch(er){return"retry"}if(rs){if(rs.success){return"success"}else{return"error"}}},validateChunkResponseScope:this,startOnSubmit:true});upload.on("fileSuccess",function(){w.close();FR.UI.feedback("Pasted image successfully uploaded");FR.actions.WebLink(FR.currentPath+"/"+fileName,fileName);FR.utils.reloadGrid(fileName);FR.pasteBlob=false});upload.on("progress",function(flow){var percent=Math.floor(flow.getProgress()*100);w.setTitle(FR.T("Uploading pasted image...")+" "+percent+"%")});upload.addFile(FR.pasteBlob,false,{path:FR.currentPath})}};FR.pasteBlob=item.getAsFile();reader.readAsDataURL(FR.pasteBlob);return true}}FR.UI.showUploadWindow({targetPath:FR.currentPath,dropEvent:e})};FR.actions.filterMeta=function(fieldId,value,mode){if(mode=="exact"){value='"'+value+'"'}var params={meta:{}};params.meta[fieldId]=[value];if(["myfiles","sharedFolder"].indexOf(FR.currentSection)==-1){FR.utils.locateItem("/ROOT/HOME",false,function(){FR.UI.searchPanel.doSearch(params)})}else{FR.UI.searchPanel.doSearch(params)}};FR.actions.openControlPanel=function(){window.open(FR.baseURL+"/?module=cpanel")};FR.actions.promptToCollection=function(targetFileInfo,opts){opts=opts||{};var type=opts.type||"regular";var texts={album:{title:"Albums",empty:"There are no albums yet"},regular:{title:"Collections",empty:"There are no collections"}};if(!FR.UI.collectionSelectors[type]){FR.UI.collectionSelectors[type]=new Ext.ux.TargetSelector({dataUrl:FR.baseURL+"/?module=collections&page=tree&type="+type,noBrowse:true,defaultFolderName:FR.T(texts[type].title),emptyText:texts[type].empty,buttons:[{text:"Ok",cls:"fr-btn-primary",disabled:true,handler:function(){this.params.targetPath=this.getSelectedPath();this.hide();FR.actions.addToCollection(this.params)}},"->",{iconCls:"fa-plus",text:type=="album"?"Create a new album":"Create a new collection",handler:function(){FR.actions.newCollectionPrompt({type:type,successCallback:Ext.createDelegate(function(rs){this.addRecord({text:rs.collectionInfo.name,pathname:rs.collectionInfo.id,iconCls:type=="album"?"fa-images":"fa-clone"})},this)})}}],onSelectionChange:function(){this.buttons[0].setDisabled(!this.selectedRecord)},listeners:{hide:function(){FR.UI.gridPanel.view.focusEl.focus()}}});FR.UI.collectionSelectors[type].load("/ROOT/Collections")}var params=opts.params||{};params["paths[]"]=targetFileInfo.paths||[targetFileInfo.path];FR.UI.collectionSelectors[type].params=params;FR.UI.collectionSelectors[type].show()};FR.actions.addToCollection=function(params){FR.actions.process({url:"/?module=collections&section=items&page=add",params:params,loadMsg:"Adding files to collection..."})};FR.actions.newCollectionPrompt=function(opts={}){if(!opts.type){opts.type="regular"}new Ext.ux.prompt(Ext.apply({title:opts.type=="album"?"Create a new album":"Create a new collection",defaultValue:opts.defaultValue||"",confirmHandler:function(name){FR.actions.createCollection({params:{name:name,type:opts.type},successCallback:Ext.createSequence(opts.successCallback||function(){},function(rs){var addTo=opts.type=="album"?FR.UI.tree.photoAlbumsNode:FR.UI.tree.collectionsNode;addTo.appendChild(new FR.components.TreeNode({text:rs.collectionInfo.name,pathname:rs.collectionInfo.id,section:"collection",objectType:"collection",nodeType:"node",iconCls:opts.type=="album"?"fa-images":"fa-clone",allowDrop:true}))}),failureCallback:function(){FR.actions.newCollectionPrompt(opts)}})}},opts))};FR.actions.createCollection=function(opts){opts.successCallback=Ext.createSequence(opts.successCallback,function(rs){if(rs.collectionInfo.type=="regular"&&FR.currentSection=="collections"||rs.collectionInfo.type=="album"&&FR.currentSection=="albums"){FR.utils.reloadGrid(rs.collectionInfo.name)}});FR.actions.process(Ext.apply(opts,{url:"/?module=collections&section=collections&page=create",loadMsg:opts.type=="album"?"Creating a new photo album...":"Creating a new collection..."}))};FR.actions.removeFromCollection=function(){FR.actions.processGridItemsByIds({url:"/?module=collections&section=items&page=remove",loadMsg:"Removing items from collection..."})};FR.actions.removeCollections=function(target){var fileInfo=target.getFileInfo();var title;if(target.items.length==1){title=FR.UI.styleFileName(fileInfo.filename)}else{title=FR.T("Multiple collections")}new Ext.ux.prompt({title:title,text:"Are you sure you want to remove the collection?",confirmHandler:function(){FR.actions.process({url:"/?module=collections&section=collections&page=remove",params:{"paths[]":fileInfo.paths||[fileInfo.path]},loadMsg:"Removing collections..."})}})};FR.actions.processMetadata=function(opts){this.process(Ext.apply({url:"/?module=metadata&section=ajax&page=set"},opts))};FR.actions.processGridItemsByIds=function(opts){this.processGridItems(Ext.apply(opts,{paramName:"ids[]",attr:"uniqid"}))};FR.actions.processGridItemsByPaths=function(opts){this.processGridItems(Ext.apply(opts,{paramName:"paths[]",attr:"path"}))};FR.actions.processGridItems=function(opts){var defaultParams={};defaultParams[opts.paramName]=FR.UI.gridPanel.getSelectedAttrs(opts.attr);opts.params=Ext.apply(opts.params||{},defaultParams);this.process(opts)};FR.actions.process=function(opts){var url=opts.baseURL||FR.baseURL;if(opts.url){url+=opts.url}if(opts.loadMsg){FR.UI.showLoading(opts.loadMsg)}if(!opts.params){opts.params={}}if(!opts.params.csrf){opts.params.csrf=User.csrf_token}Ext.Ajax.request({url:url,method:"post",params:opts.params,opts:opts,callback:function(opts,succ,req){FR.UI.doneLoading();try{var rs=Ext.decode(req.responseText)}catch(er){}if(opts.opts.callback){opts.opts.callback.apply(opts.opts.scope,[rs,opts.opts])}if(!rs||!rs.success){if(opts.opts.failureCallback){opts.opts.failureCallback.apply(opts.opts.scope,[rs,opts.opts])}if(!rs){return false}}else{if(opts.opts.successCallback){opts.opts.successCallback.apply(opts.opts.scope,[rs,opts.opts])}}if(rs.updates){FR.utils.applyBatchFileUpdates(rs.updates)}var feedbackType="";if(rs.hasOwnProperty("success")){feedbackType=rs.success?"success":"error"}if(rs.msg){FR.UI.feedback(rs.msg,feedbackType)}}})};