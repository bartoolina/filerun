FR.utils={parseRawLabel:function(v){if(!v){return false}if(typeof v!=="string"){return v}var s=v.split("|");return{color:s[1],text:s[0]}},getTagColor:function(s){s=s.toLowerCase();if(s=="filerun"){return"#590099"}var named=colourNameToHex(s);if(named){return named}var hue=getSeededRandomInt(s,0,360);return hsluv.hsluvToHex([hue,100,50])},getLabelHTML:function(label){return"<div"+(label.color?' style="color: '+label.color+';"':"")+">"+label.text+"</div>"},showCount:function(count,one,multiple){if(count==1){return FR.T(one)}return FR.T(multiple).replace("%1",count)},hasQuota:function(){return!Settings.free_mode&&User.perms.space_quota_max},reloadGrid:function(highlightOnDisplay){if(highlightOnDisplay){FR.UI.gridPanel.highlightOnDisplay=highlightOnDisplay}FR.UI.gridPanel.load(FR.currentPath)},reloadTree:function(){if(["myfiles","sharedFolder","userWithShares","collections"].indexOf(FR.currentSection)!=-1){var n=FR.UI.tree.currentSelectedNode;if(n&&n.loading==false&&n.loaded==true){FR.UI.tree.reloadNode(n)}}},pathInfo:function(path){var s=path.split("/");return{basename:s.pop(),dirname:s.join("/")}},firstPathName:function(path){return path.split("/").filter(Boolean)[0]},renamePath:function(path,newName){return this.pathInfo(path).dirname+"/"+newName},gluePath:function(){var i=0;var count=arguments.length;var parts=[];Ext.each(arguments,function(p){i++;var t=typeof p;if(t=="string"){if(i==1){p=p.replace(new RegExp("[/]+$"),"")}else{if(i!=count){p=p.replace(new RegExp("[/]+$"),"")}p=p.replace(new RegExp("^[/]+"),"")}}if(t!=="boolean"&&p!==""){parts.push(p)}});return parts.join("/")},splitNameAndExt:function(filename){var dotpos=filename.lastIndexOf(".");var rs={namePart:"",ext:""};if(dotpos==-1||dotpos==0){rs.namePart=filename}else{rs.namePart=filename.substr(0,dotpos);rs.ext=filename.substr(dotpos+1).toLowerCase()}return rs},getFileExtension:function(filename){var dotpos=filename.lastIndexOf(".");if(dotpos==-1||dotpos==0){return""}return filename.substr(dotpos+1).toLowerCase()},stripFileExtension:function(filename){var dotpos=filename.lastIndexOf(".");if(dotpos==-1||dotpos==0){return filename}return filename.substr(0,dotpos)},dimExt:function(filename){var dot=filename.lastIndexOf(".");if(dot==-1||dotpos==0){return filename}var name=filename.substr(0,dot);var ext=filename.substr(dot);return name+'<span class="gray">'+ext+"<span>"},humanFilePath:function(str){str=str.replace("/ROOT/HOME",FR.T("My Files"));str=str.replace("/ROOT/TRASH",FR.T("Trash"));return str},inPath:function(childPath,parentPath){return childPath.indexOf(parentPath)===0},isEditable:function(item){if(!User.perms.download){return false}if(User.perms.read_only){return false}return FR.customActionsEditors.byType.indexOf(item.filetype)!=-1||FR.customActionsEditors.byExt.indexOf(item.ext)!=-1},editFile:function(item){if(!item){item=FR.UI.gridPanel.getOneSel().data}var post=[{name:"path",value:item.path}];if(Ext.isMobile){post.push({name:"mobile",value:"1"})}FR.UI.popup({title:item.filename,autoDestroy:true,maximized:true,src:FR.baseURL+"/?module=fileman&section=utils&page=file_edit",post:post});return true},supportsImageViewer:function(item){return item.objectType=="file"},showPreview:function(item){if(item.filetype=="mp3"&&FR.customActions.audio_player){FR.UI.AudioPlayer.open(item);return true}if(this.supportsImageViewer(item)){if(!FR.UI.ImageViewer){FR.UI.ImageViewer=new FR.components.ImageViewer}FR.UI.ImageViewer.open(item);return true}return true},locateSelected:function(){var s=Ext.copyTo({},FR.UI.gridPanel.getOneSel().data,["isFolder","path","filename"]);if(s.isFolder){FR.utils.locateItem(s.path)}else{FR.utils.locateItem(FR.utils.pathInfo(s.path).dirname,s.filename)}},locateItem:function(path,filename,callback){var grid=FR.UI.gridPanel;if(grid.view.searchMode){FR.UI.searchPanel.close()}if(filename){grid.highlightOnDisplay=filename;grid.highlightOnLoadCallback=callback;if(path==FR.currentPath){if(grid.highlight(filename,callback)){return}FR.utils.reloadGrid(filename);return}}if(!callback){callback=function(){}}callback=callback.createInterceptor(function(success,node){if(success&&node){node.select().scrollIntoView()}});if(path.startsWith("/ROOT/HOME/")&&Settings.has_home_folder){FR.UI.tree.layPath(path,callback)}else{FR.UI.tree.panel.selectPath(path,"pathname",callback)}},browseToPath:function(path){this.locateItem(path,false,function(success){if(!success){if(FR.UI.tree.currentSelectedNode){FR.UI.tree.reloadNode(FR.UI.tree.currentSelectedNode,function(){FR.utils.locateItem(path)})}else{Ext.getCmp("FR-Tree-Region").expand();new Ext.ux.prompt({text:FR.T("This link that you have followed does not seem to point at a valid menu option.")})}}})},toggleGridSelection:function(){var grid=FR.UI.gridPanel;if(grid.countSel==grid.store.getCount()){grid.selModel.clearSelections()}else{grid.selModel.selectAll()}},applyFileUpdates:function(path,updates){var treeNode=FR.UI.tree.panel.findNodeByPath(path);if(treeNode){if(!treeNode.attributes.custom){treeNode.attributes.custom={}}if(updates=="remove"){treeNode.parentNode.removeChild(treeNode);if(!FR.UI.tree.currentSelectedNode){if(Settings.has_home_folder){FR.UI.tree.homeFolderNode.select()}}}else if(updates=="reload"){if(!FR.utils.inPath(FR.currentPath,path)){FR.UI.tree.reloadNode(treeNode)}}else{Ext.iterate(updates,function(k,v){if(["weblink","star","share","notInfo","label"].indexOf(k)!=-1){treeNode.attributes.custom[k]=v}else if(k=="filename"){treeNode.setText(v);var oldPath=treeNode.getPath("pathname");if(oldPath==FR.currentPath){if(treeNode.attributes.objectType!="collection"){treeNode.attributes.pathname=v;FR.currentPath=treeNode.getPath("pathname");FR.replaceHistory(FR.currentPath);FR.utils.reloadGrid()}FR.UI.tree.setCurrentFolderName(v)}else{if(treeNode.attributes.objectType!="collection"){treeNode.attributes.pathname=v}}}else if(k=="new_folder"){FR.UI.tree.layPath(FR.utils.gluePath(path,v))}});FR.UI.tree.updateIcon(treeNode)}}var gridRow=FR.UI.gridPanel.getByPath(path);if(gridRow){var store=FR.UI.gridPanel.getStore();if(updates=="remove"||updates=="removeFromGrid"){store.remove(store.getById(gridRow.id))}else{Ext.iterate(updates,function(k,v){if(["star","share","comments","notInfo"].indexOf(k)!=-1){gridRow.data[k]=v}else if(k=="label"){gridRow.data[k]=store.fields.get("label").convert(v)}else if(k=="weblink"){gridRow.data.hasWebLink=v}else if(k=="lock"){gridRow.data.lockInfo=v}else if(k=="filename"){if(gridRow.data.path){if(gridRow.data.objectType!="collection"){gridRow.data.path=FR.utils.renamePath(gridRow.data.path,v);gridRow.data.thumbURL=false}}gridRow.data.filename=v;if(gridRow.data.objectType=="file"){var split=FR.utils.splitNameAndExt(v);gridRow.data.filenameWithoutExt=split.namePart;gridRow.data.ext=split.ext}}});FR.UI.gridPanel.getView().refresh()}}if(path==FR.currentPath){if(updates=="reload"||typeof updates=="object"){var highlight=false;if(typeof updates=="object"){highlight=updates.new_folder||updates.new_file}FR.utils.reloadGrid(highlight)}}FR.UI.infoPanel.applyFileUpdates(path,updates);if(FR.UI.ImageViewer){FR.UI.ImageViewer.applyFileUpdates(path,updates)}},applyBatchFileUpdates:function(updates){Ext.each(updates,function(u){this.applyFileUpdates(u.path,u.updates)},this)},elementInView:function(o,s,offset){var b=s.bottom;if(offset){b=b*offset}return o.top<=b&&o.bottom>=s.top&&o.right>=s.left&&o.left<=s.right},encodeURIComponent:function(s){return encodeURIComponent(s).replace(/\-/g,"%2D").replace(/\_/g,"%5F").replace(/\./g,"%2E").replace(/\!/g,"%21").replace(/\~/g,"%7E").replace(/\*/g,"%2A").replace(/\'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29")}};