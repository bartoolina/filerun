FR.Context={lastGridTarget:false,targetId:1,getTarget:function(location,items){if(location=="currentFolder"){return this.getTarget("grid",[])}var target={location:location,objectTypes:{},section:false,items:location=="tree"?[items]:items,getFileList(){return FR.Context.getFileList(this)},getFileInfo(){return FR.Context.getFileInfo(this)},getPath(){return FR.Context.getFileInfo(this).path},getItem(){return this.items[0]},matchesAll(multipleReq){var matches=true;var target=this;Ext.each(multipleReq,function(req){if(!FR.Context.checkRequirement(req,target)){matches=false;return false}});return matches},matchesAny(multipleReq){var matches=false;var target=this;Ext.each(multipleReq,function(req){if(FR.Context.checkRequirement(req,target)){matches=true;return false}});return matches},checkRequirement(req){return FR.Context.checkRequirement(req,this)}};var gridHasNoSelection=false;if(location=="grid"){target.section=FR.currentSection;if(target.items[0]){Ext.each(target.items,function(item){if(!target.objectTypes[item.objectType]){target.objectTypes[item.objectType]=0}target.objectTypes[item.objectType]++;if(item.perms){if(!target.perms){target.perms={}}if(target.perms!="user"){if(item.perms=="user"){target.perms="user"}else{Ext.iterate(item.perms,function(perm,val){if(!(perm in target.perms)||val&&!target.perms[perm]){target.perms[perm]=val}})}}}})}else{gridHasNoSelection=true}}if(location=="tree"||gridHasNoSelection){var treeNodeAttributes;if(location=="tree"){treeNodeAttributes=target.items[0].attributes}else{if(!FR.UI.tree.currentSelectedNode){return false}treeNodeAttributes=FR.UI.tree.currentSelectedNode.attributes}var objectType=treeNodeAttributes.objectType||"folder";target.objectTypes[objectType]=1;target.section=treeNodeAttributes.section;if(["folder","collection"].indexOf(objectType)!=-1){target.perms=treeNodeAttributes.perms}}target.unAdjustedPerms=target.perms;if(target.perms){target.perms=FR.getTargetPerms(target.perms)}target.id=this.targetId++;return target},checkRequirement:function(req,target){if(req=="in-grid"){return target.location=="grid"}if(req=="in-tree"){return target.location=="tree"}if(req=="empty"){return target.items.length==0}if(req=="non-empty"){return target.location=="tree"||target.items.length>0}if(req=="single"){return target.location=="tree"||target.items.length==1}if(req=="multiple"){return target.items.length>1}if(req=="isNotVirtual"){return!("virtual"in target.objectTypes)}if(req=="isFile"||req=="file"){return"file"in target.objectTypes}if(req=="isFolder"||req=="folder"){return"folder"in target.objectTypes}if(req=="isFileOrFolder"){return"file"in target.objectTypes||"folder"in target.objectTypes}if(req=="isCollection"){return"collection"in target.objectTypes}if(req=="isNotCollection"){return!("collection"in target.objectTypes)}if(req=="isFolderOrCollection"){return"folder"in target.objectTypes||"collection"in target.objectTypes}if(req=="isTrash"){return"trash"in target.objectTypes}if(req=="section-myfiles"){return target.section=="myfiles"}if(req=="not-homefolder"){return target.getPath()!="/ROOT/HOME"}if(req=="upload"||req=="create"){if(!target.perms){return false}return target.perms.upload}if(req=="weblink"){if(!target.perms){return false}return target.perms.weblink}if(req=="share"){if(!target.perms){return false}return target.perms.share}if(req=="email"){if(!target.perms){return false}return target.perms.share}if(req=="pdfs"){var onlyPdfs=true;Ext.each(target.items,function(item){if(item.ext!="pdf"){onlyPdfs=false;return false}});return onlyPdfs}if(req=="images"){var onlyImages=true;Ext.each(target.items,function(item){if(item.filetype!="img"){onlyImages=false;return false}});return onlyImages}if(req=="preview"){if(!("file"in target.objectTypes)){return false}if(target.section=="sharedFolder"||target.section=="userWithShares"){if(!target.perms){return false}return target.perms.download}return User.perms.preview}if(req=="download"){if(!("collection"in target.objectTypes)&&!("file"in target.objectTypes)&&!("folder"in target.objectTypes)){return false}if(!target.perms){return false}return target.perms.download}if(req=="metadata"){return User.perms.metadata}if(req=="comment"){if(!target.perms){return false}return target.perms.comment}if(req=="edit"){if(!target.perms){return false}return target.perms.alter&&FR.utils.isEditable(target.items[0])}if(req=="alter"){if(!target.perms){return false}if(!("collection"in target.objectTypes)&&!("file"in target.objectTypes)&&!("folder"in target.objectTypes)){return false}return target.perms.alter}if(req=="not-readonly"){return!User.perms.read_only}if(req=="admin"){return User.isAdmin}if(typeof req=="object"){if(req.sections){if(req.sections.indexOf(target.section)!=-1){return true}}else if(req.skip_sections){if(req.skip_sections.indexOf(target.section)==-1){return true}}}return false},getFileList:function(target){if(target.location=="tree"){var treeNode=target.items[0];return[{path:treeNode.getPath("pathname"),filename:treeNode.text,objectType:treeNode.attributes.objectType||"folder"}]}else{return target.items}},getFileInfo:function(target){if(target.location=="tree"||target.items.length==0){var treeNode=target.items[0]||FR.UI.tree.currentSelectedNode;return{objectType:treeNode.attributes.objectType||"folder",filename:treeNode.text,path:treeNode.getPath("pathname")}}else if(target.items.length>1){var paths=[];Ext.each(target.items,function(item){paths.push(item.path)});return{paths:paths}}else{return target.items[0]}}};FR.ContextAction=Ext.extend(Ext.Action,{constructor:function(config){config.hidden=true;if(config.action){config.handler=function(t,e){var cfg=t.initialConfig;var target;if(cfg.contextTarget=="topMenu"){target=FR.UI.gridPanel.target}else{target=FR.UI.contextMenu.lastTarget}return FR.contextMenuActions[cfg.action](target,t,e)};config.scope=this}else{if(!config.handler){config.handler=function(){return false}}}this.initialConfig=config;this.itemId=config.itemId=config.itemId||config.id||Ext.id();this.items=[]}});