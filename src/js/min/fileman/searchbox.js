FR.components.SearchPanel=Ext.extend(Ext.Window,{width:500,stateful:false,closable:false,params:{},prepopulated:false,title:false,bodyStyle:"padding-top:15px",closeAction:"hidePanel",focusField:true,initComponent:function(){this.inputListeners={keyup:function(f,e){if(e.getKey()==e.ENTER){this.runSearch()}if(e.getKey()==e.ESC){this.hidePanel()}},scope:this};this.metaFieldSelector=new Ext.form.ComboBox({mode:"local",triggerAction:"all",editable:false,flex:1,store:FR.searchMetaColumns,valueField:"id",displayField:"title",value:"-",name:"fid",listeners:{select:function(cb,record){if(record.data.options){var html="<ul><li>"+record.data.options.join("</li><li>")+"</li></ul>";new Ext.ToolTip({title:"Available options",html:html,closable:true,dismissDelay:2e4}).showBy(cb.el)}},scope:this}});this.inputs={filename:new Ext.form.TextField({fieldLabel:"Name",anchor:"100%",name:"filename",enableKeyEvents:true,hidden:true,listeners:this.inputListeners}),metatype:new Ext.form.ComboBox({fieldLabel:"Type",hidden:true,mode:"local",triggerAction:"all",editable:false,name:"metatype",store:FR.searchMetaFileTypes,value:"",listeners:this.inputListeners}),contents:new Ext.form.TextField({fieldLabel:"Contents",anchor:"100%",name:"contents",enableKeyEvents:true,hidden:true,listeners:this.inputListeners}),meta:new Ext.form.CompositeField({hidden:true,combineValues:true,name:"meta",items:[{xtype:"textfield",fieldLabel:"Metadata",enableKeyEvents:true,flex:1,name:"keyword",listeners:this.inputListeners},this.metaFieldSelector,{xtype:"button",tooltip:"Add a new search criteria",iconCls:"fa-plus",cls:"fr-btn-default fr-btn-in-form",handler:function(){this.addNewMeta()},scope:this}],focus:function(){return this.items.first().focus()}})};this.toggles={filename:new Ext.Button({text:"Name",value:"filename",enableToggle:true,toggleHandler:this.typeToggle,scope:this}),meta:new Ext.Button({text:"Metadata",value:"meta",hidden:FR.searchMetaColumns.length==0||!User.perms.metadata,style:"margin-left:5px;",enableToggle:true,toggleHandler:this.typeToggle,scope:this}),metatype:new Ext.Button({text:"Type",value:"metatype",style:"margin-left:5px;",enableToggle:true,toggleHandler:this.typeToggle,scope:this}),contents:new Ext.Button({text:"Contents",value:"contents",hidden:!Settings.fullTextSearch,enableToggle:true,toggleHandler:this.typeToggle,scope:this})};this.contentsToogleSeparator=new Ext.Toolbar.Separator({hidden:!Settings.fullTextSearch});this.formPanel=new Ext.form.FormPanel({labelWidth:80,bodyStyle:"padding:15px 0",tbar:{defaults:{scope:this},items:[FR.T("By:"),this.toggles.filename,this.toggles.metatype,this.toggles.meta,this.contentsToogleSeparator,this.toggles.contents]},items:[this.inputs.filename,this.inputs.metatype,this.inputs.contents,this.inputs.meta]});Ext.apply(this,{tools:[{toolType:"close",iconCls:"fa-angle-up",tooltip:"Hide",handler:this[this.closeAction].createDelegate(this,[])}],items:this.formPanel,bbar:[{text:"Search",tooltip:FR.T("Keyboard shortcut: %1","Enter"),cls:"fr-btn-primary",iconCls:"fa-search",handler:function(){this.runSearch()},scope:this},{text:"Hide",tooltip:FR.T("Keyboard shortcut: %1","Esc"),iconCls:"fa-angle-up",style:"margin-left:5px",handler:function(){this.hidePanel()},scope:this},"->",{text:"Cancel search",iconCls:"fa-close",handler:function(){this.close()},scope:this}],listeners:{show:function(){this.updateTitle();FR.UI.actions.searchBtn.items[0].hide();var visible=false;Ext.iterate(this.inputs,function(k,input){if(input.isVisible()){visible=input;input.focus();return false}});if(this.prepopulated){this.adjustHeight();return true}if(!visible){this.toggles[Settings.search_default_mode].toggle(true)}},hide:function(){FR.UI.actions.searchBtn.items[0].show()},scope:this}});FR.components.SearchPanel.superclass.initComponent.apply(this,arguments)},folderChange:function(){this.updateTitle()},updateTitle:function(){this.setTitle(FR.T("Search %1").replace("%1",FR.UI.styleFileName(FR.UI.currentFolderTitle)))},hidePanel:function(){var v=FR.UI.gridPanel.view;if(this.isEmpty(this.getParams())){v.closeSearchPanel()}else{this.hide()}v.focusEl.focus()},hasParams:function(){return!this.isEmpty(this.getParams())},getParams:function(){var fieldValues=this.formPanel.form.getFieldValues();this.params={};var sendParams={};Ext.iterate(fieldValues,function(k,v){if(k=="meta"){Ext.each(v,function(metaItem){if(metaItem.keyword){if(!this.params.meta){this.params.meta={}}var metaKey="search[meta]["+metaItem["fid"]+"][]";if(Ext.isArray(sendParams[metaKey])){sendParams[metaKey].push(metaItem.keyword);this.params.meta[metaItem["fid"]].push(metaItem.keyword)}else{sendParams[metaKey]=[metaItem.keyword];this.params.meta[metaItem["fid"]]=[metaItem.keyword]}}},this)}else{if(v){this.params[k]=v;sendParams["search["+k+"]"]=v}}},this);return sendParams},push2History:function(){FR.push2History(FR.currentPath+"?"+encodeURIComponent(JSON.stringify(this.params)))},addNewMeta:function(keyword,fid){var field=new Ext.form.CompositeField({combineValues:true,name:"meta",additional:true,items:[{xtype:"textfield",fieldLabel:"Metadata",name:"keyword",enableKeyEvents:true,flex:1,listeners:this.inputListeners,value:keyword||""},new Ext.form.ComboBox({mode:"local",triggerAction:"all",editable:false,flex:1,store:FR.searchMetaColumns,valueField:"id",displayField:"title",value:fid||"-",name:"fid"}),{xtype:"button",tooltip:"Remove search criteria",iconCls:"fa-minus",cls:"fr-btn-default fr-btn-in-form",handler:function(btn){this.removeMetaInput(btn.ownerCt.ownerCt)},scope:this}],focus:function(){this.items.first().focus()}});this.formPanel.add(field);this.formPanel.doLayout();this.adjustHeight();field.focus()},removeMetaInput:function(input){var value=input.items.first().getValue();this.formPanel.remove(input,true);this.formPanel.doLayout();this.adjustHeight();if(value.length){this.runSearch()}},removeAdditionalMetaInputs:function(){this.formPanel.items.each(function(item){if(item.name=="meta"&&item.additional){this.removeMetaInput(item)}},this)},isEmpty:function(params){var isEmpty=true;Ext.iterate(params,function(k,v){if(v){isEmpty=false;return false}});return isEmpty},typeToggle:function(button,pressed){if(pressed){if(button.value=="contents"){this.toggles.filename.toggle(false);this.toggles.metatype.toggle(false);this.toggles.meta.toggle(false)}else{this.toggles.contents.toggle(false)}this.inputs[button.value].show();if(this.focusField){this.inputs[button.value].focus(true,20)}}else{this.inputs[button.value].hide().reset();if(button.value=="meta"){this.formPanel.items.each(function(item){if(item.name=="meta"&&item.additional){this.removeMetaInput(item)}},this)}}this.adjustHeight()},adjustHeight:function(){this.setHeight(this.formPanel.body.dom.scrollHeight+158)},updateForm:function(p){this.focusField=false;this.removeAdditionalMetaInputs();Ext.iterate(this.toggles,function(k,toggle){if(k=="meta"){if(p.hasOwnProperty("meta")){toggle.toggle(true)}}else{var value="",toggled=false;if(p[k]){value=p[k];if(p[k].length>0){toggled=true}}toggle.toggle(toggled);this.inputs[k].suspendEvents().setValue(value).resumeEvents()}},this);if(p.meta){var count=0;Ext.iterate(p.meta,function(fid,vals){Ext.each(vals,function(val){count++;if(count==1){this.inputs.meta.items.first().suspendEvents().setValue(val).resumeEvents();this.metaFieldSelector.suspendEvents().setValue(fid).resumeEvents()}else{this.addNewMeta(val,fid)}},this)},this)}this.focusField=true},close:function(noHistoryChange){FR.UI.actions.cancelSearch.items[0].hide();var g=FR.UI.gridPanel;var hadSearchParams=false;Ext.iterate(g.store.baseParams,function(k,v){if(k.indexOf("search")!==-1){hadSearchParams=true;delete g.store.baseParams[k]}});g.view.closeSearchPanel();if(hadSearchParams){FR.utils.reloadGrid()}if(!noHistoryChange){FR.push2History(FR.currentPath)}},open:function(prepopulated){FR.UI.gridPanel.view.showSearchPanel()},doSearch:function(p){if(!p&&!FR.UI.tree.currentSelectedNode){FR.UI.tree.panel.selectFirstVisible();return false}this.open();this.updateForm(p||{});this.prepopulated=!!p;this.runSearch()},runSearch:function(){var sendParams=this.getParams();if(this.isEmpty(sendParams)){FR.UI.feedback("Nothing to search for");return false}this.push2History();var g=FR.UI.gridPanel;var newBaseParams={};Ext.iterate(g.store.baseParams,function(k,v){if(k.indexOf("search")===-1){newBaseParams[k]=v}});Ext.iterate(sendParams,function(k,v){newBaseParams[k]=v});g.store.baseParams=newBaseParams;g.setMetaCols();g.load()}});